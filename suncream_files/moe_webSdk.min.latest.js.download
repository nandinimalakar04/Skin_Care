/*! For license information please see sdk.js.LICENSE.txt */
(()=>{var e={483:(e,t,n)=>{e.exports=function e(t,n,i){function a(o,s){if(!n[o]){if(!t[o]){if(r)return r(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}l=n[o]={exports:{}},t[o][0].call(l.exports,(function(e){return a(t[o][1][e]||e)}),l,l.exports,e,t,n,i)}return n[o].exports}for(var r=void 0,o=0;o<i.length;o++)a(i[o]);return a}({1:[function(e,t,i){(function(e){"use strict";var n,i,a,r,o=e.MutationObserver||e.WebKitMutationObserver,s=o?(n=0,o=new o(d),i=e.document.createTextNode(""),o.observe(i,{characterData:!0}),function(){i.data=n=++n%2}):e.setImmediate||void 0===e.MessageChannel?"document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){d(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(d,0)}:((a=new e.MessageChannel).port1.onmessage=d,function(){a.port2.postMessage(0)}),l=[];function d(){var e,t;r=!0;for(var n=l.length;n;){for(t=l,l=[],e=-1;++e<n;)t[e]();n=l.length}r=!1}t.exports=function(e){1!==l.push(e)||r||s()}}).call(this,void 0!==n.g?n.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,n){"use strict";var i=e(1);function a(){}var r={},o=["REJECTED"],s=["FULFILLED"],l=["PENDING"];function d(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=l,this.queue=[],this.outcome=void 0,e!==a&&m(this,e)}function c(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function u(e,t,n){i((function(){var i;try{i=t(n)}catch(i){return r.reject(e,i)}i===e?r.reject(e,new TypeError("Cannot resolve promise with itself")):r.resolve(e,i)}))}function g(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function m(e,t){var n=!1;function i(t){n||(n=!0,r.reject(e,t))}function a(t){n||(n=!0,r.resolve(e,t))}var o=p((function(){t(a,i)}));"error"===o.status&&i(o.value)}function p(e,t){var n={};try{n.value=e(t),n.status="success"}catch(e){n.status="error",n.value=e}return n}(t.exports=d).prototype.catch=function(e){return this.then(null,e)},d.prototype.then=function(e,t){if("function"!=typeof e&&this.state===s||"function"!=typeof t&&this.state===o)return this;var n=new this.constructor(a);return this.state!==l?u(n,this.state===s?e:t,this.outcome):this.queue.push(new c(n,e,t)),n},c.prototype.callFulfilled=function(e){r.resolve(this.promise,e)},c.prototype.otherCallFulfilled=function(e){u(this.promise,this.onFulfilled,e)},c.prototype.callRejected=function(e){r.reject(this.promise,e)},c.prototype.otherCallRejected=function(e){u(this.promise,this.onRejected,e)},r.resolve=function(e,t){var n=p(g,t);if("error"===n.status)return r.reject(e,n.value);if(n=n.value)m(e,n);else{e.state=s,e.outcome=t;for(var i=-1,a=e.queue.length;++i<a;)e.queue[i].callFulfilled(t)}return e},r.reject=function(e,t){e.state=o,e.outcome=t;for(var n=-1,i=e.queue.length;++n<i;)e.queue[n].callRejected(t);return e},d.resolve=function(e){return e instanceof this?e:r.resolve(new this(a),e)},d.reject=function(e){var t=new this(a);return r.reject(t,e)},d.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,i=!1;if(!n)return this.resolve([]);for(var o=new Array(n),s=0,l=-1,d=new this(a);++l<n;)!function(e,a){t.resolve(e).then((function(e){o[a]=e,++s!==n||i||(i=!0,r.resolve(d,o))}),(function(e){i||(i=!0,r.reject(d,e))}))}(e[l],l);return d},d.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,i=!1;if(!n)return this.resolve([]);for(var o=-1,s=new this(a);++o<n;)!function(e){t.resolve(e).then((function(e){i||(i=!0,r.resolve(s,e))}),(function(e){i||(i=!0,r.reject(s,e))}))}(e[o]);return s}},{1:1}],3:[function(e,t,i){(function(t){"use strict";"function"!=typeof t.Promise&&(t.Promise=e(2))}).call(this,void 0!==n.g?n.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}();function r(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(a){if("TypeError"!==a.name)throw a;for(var n=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),i=0;i<e.length;i+=1)n.append(e[i]);return n.getBlob(t.type)}}"undefined"==typeof Promise&&e(3);var o=Promise;function s(e,t){t&&e.then((function(e){t(null,e)}),(function(e){t(e)}))}function l(e,t,n){"function"==typeof t&&e.then(t),"function"==typeof n&&e.catch(n)}function d(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function c(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var u="local-forage-detect-blob-support",g=void 0,m={},p=Object.prototype.toString,h="readonly",v="readwrite";function f(e){return"boolean"==typeof g?o.resolve(g):(t=e,new o((function(e){var n=t.transaction(u,v),i=r([""]);n.objectStore(u).put(i,"key"),n.onabort=function(t){t.preventDefault(),t.stopPropagation(),e(!1)},n.oncomplete=function(){var t=navigator.userAgent.match(/Chrome\/(\d+)/),n=navigator.userAgent.match(/Edge\//);e(n||!t||43<=parseInt(t[1],10))}})).catch((function(){return!1})).then((function(e){return g=e})));var t}function S(e){e=m[e.name];var t={};t.promise=new o((function(e,n){t.resolve=e,t.reject=n})),e.deferredOperations.push(t),e.dbReady?e.dbReady=e.dbReady.then((function(){return t.promise})):e.dbReady=t.promise}function E(e){return(e=m[e.name].deferredOperations.pop())&&(e.resolve(),e.promise)}function y(e,t){if(e=m[e.name].deferredOperations.pop())return e.reject(t),e.promise}function b(e,t){return new o((function(n,i){if(m[e.name]=m[e.name]||{forages:[],db:null,dbReady:null,deferredOperations:[]},e.db){if(!t)return n(e.db);S(e),e.db.close()}var r=[e.name];t&&r.push(e.version);var o=a.open.apply(a,r);t&&(o.onupgradeneeded=function(t){var n=o.result;try{n.createObjectStore(e.storeName),t.oldVersion<=1&&n.createObjectStore(u)}catch(n){if("ConstraintError"!==n.name)throw n;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),o.onerror=function(e){e.preventDefault(),i(o.error)},o.onsuccess=function(){n(o.result),E(e)}}))}function _(e){return b(e,!1)}function T(e){return b(e,!0)}function I(e,t){if(!e.db)return 1;var n=!e.db.objectStoreNames.contains(e.storeName),i=e.version<e.db.version,a=e.version>e.db.version;return i&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),(a||n)&&(!n||(n=e.db.version+1)>e.version&&(e.version=n),1)}function A(e){return r([function(e){for(var t=e.length,n=new ArrayBuffer(t),i=new Uint8Array(n),a=0;a<t;a++)i[a]=e.charCodeAt(a);return n}(atob(e.data))],{type:e.type})}function w(e){return e&&e.__local_forage_encoded_blob}function D(e){var t=this,n=t._initReady().then((function(){var e=m[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady}));return l(n,e,e),n}function O(e,t,n,i){void 0===i&&(i=1);try{var a=e.db.transaction(e.storeName,t);n(null,a)}catch(a){if(0<i&&(!e.db||"InvalidStateError"===a.name||"NotFoundError"===a.name))return o.resolve().then((function(){if(!e.db||"NotFoundError"===a.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),T(e)})).then((function(){return function(e){S(e);for(var t=m[e.name],n=t.forages,i=0;i<n.length;i++){var a=n[i];a._dbInfo.db&&(a._dbInfo.db.close(),a._dbInfo.db=null)}return e.db=null,_(e).then((function(t){return e.db=t,I(e)?T(e):t})).then((function(i){e.db=t.db=i;for(var a=0;a<n.length;a++)n[a]._dbInfo.db=i})).catch((function(t){throw y(e,t),t}))}(e).then((function(){O(e,t,n,i-1)}))})).catch(n);n(a)}}var P={_driver:"asyncStorage",_initStorage:function(e){var t=this,n={db:null};if(e)for(var i in e)n[i]=e[i];var a=m[n.name];a||(a={forages:[],db:null,dbReady:null,deferredOperations:[]},m[n.name]=a),a.forages.push(t),t._initReady||(t._initReady=t.ready,t.ready=D);var r=[];function s(){return o.resolve()}for(var l=0;l<a.forages.length;l++){var d=a.forages[l];d!==t&&r.push(d._initReady().catch(s))}var c=a.forages.slice(0);return o.all(r).then((function(){return n.db=a.db,_(n)})).then((function(e){return n.db=e,I(n,t._defaultConfig.version)?T(n):e})).then((function(e){n.db=a.db=e,t._dbInfo=n;for(var i=0;i<c.length;i++){var r=c[i];r!==t&&(r._dbInfo.db=n.db,r._dbInfo.version=n.version)}}))},_support:function(){try{if(!a)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}(),iterate:function(e,t){var n=this,i=new o((function(t,i){n.ready().then((function(){O(n._dbInfo,h,(function(a,r){if(a)return i(a);try{var o=r.objectStore(n._dbInfo.storeName).openCursor(),s=1;o.onsuccess=function(){var n,i=o.result;i?(w(n=i.value)&&(n=A(n)),void 0!==(n=e(n,i.key,s++))?t(n):i.continue()):t()},o.onerror=function(){i(o.error)}}catch(a){i(a)}}))})).catch(i)}));return s(i,t),i},getItem:function(e,t){var n=this;e=d(e);var i=new o((function(t,i){n.ready().then((function(){O(n._dbInfo,h,(function(a,r){if(a)return i(a);try{var o=r.objectStore(n._dbInfo.storeName).get(e);o.onsuccess=function(){var e=o.result;w(e=void 0===e?null:e)&&(e=A(e)),t(e)},o.onerror=function(){i(o.error)}}catch(a){i(a)}}))})).catch(i)}));return s(i,t),i},setItem:function(e,t,n){var i=this;e=d(e);var a=new o((function(n,a){var r;i.ready().then((function(){return r=i._dbInfo,"[object Blob]"===p.call(t)?f(r.db).then((function(e){return e?t:(n=t,new o((function(e,t){var i=new FileReader;i.onerror=t,i.onloadend=function(t){t=btoa(t.target.result||""),e({__local_forage_encoded_blob:!0,data:t,type:n.type})},i.readAsBinaryString(n)})));var n})):t})).then((function(t){O(i._dbInfo,v,(function(r,o){if(r)return a(r);try{var s=o.objectStore(i._dbInfo.storeName);null===t&&(t=void 0);var l=s.put(t,e);o.oncomplete=function(){n(t=void 0===t?null:t)},o.onabort=o.onerror=function(){var e=l.error||l.transaction.error;a(e)}}catch(r){a(r)}}))})).catch(a)}));return s(a,n),a},removeItem:function(e,t){var n=this;e=d(e);var i=new o((function(t,i){n.ready().then((function(){O(n._dbInfo,v,(function(a,r){if(a)return i(a);try{var o=r.objectStore(n._dbInfo.storeName).delete(e);r.oncomplete=function(){t()},r.onerror=function(){i(o.error)},r.onabort=function(){var e=o.error||o.transaction.error;i(e)}}catch(a){i(a)}}))})).catch(i)}));return s(i,t),i},clear:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){O(t._dbInfo,v,(function(i,a){if(i)return n(i);try{var r=a.objectStore(t._dbInfo.storeName).clear();a.oncomplete=function(){e()},a.onabort=a.onerror=function(){var e=r.error||r.transaction.error;n(e)}}catch(i){n(i)}}))})).catch(n)}));return s(n,e),n},length:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){O(t._dbInfo,h,(function(i,a){if(i)return n(i);try{var r=a.objectStore(t._dbInfo.storeName).count();r.onsuccess=function(){e(r.result)},r.onerror=function(){n(r.error)}}catch(i){n(i)}}))})).catch(n)}));return s(n,e),n},key:function(e,t){var n=this,i=new o((function(t,i){e<0?t(null):n.ready().then((function(){O(n._dbInfo,h,(function(a,r){if(a)return i(a);try{var o=r.objectStore(n._dbInfo.storeName),s=!1,l=o.openCursor();l.onsuccess=function(){var n=l.result;n?0===e||s?t(n.key):(s=!0,n.advance(e)):t(null)},l.onerror=function(){i(l.error)}}catch(a){i(a)}}))})).catch(i)}));return s(i,t),i},keys:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){O(t._dbInfo,h,(function(i,a){if(i)return n(i);try{var r=a.objectStore(t._dbInfo.storeName).openCursor(),o=[];r.onsuccess=function(){var t=r.result;t?(o.push(t.key),t.continue()):e(o)},r.onerror=function(){n(r.error)}}catch(i){n(i)}}))})).catch(n)}));return s(n,e),n},dropInstance:function(e,t){t=c.apply(this,arguments);var n,i=this.config();return(e="function"!=typeof e&&e||{}).name||(e.name=e.name||i.name,e.storeName=e.storeName||i.storeName),s(n=e.name?(n=e.name===i.name&&this._dbInfo.db?o.resolve(this._dbInfo.db):_(e).then((function(t){var n=m[e.name],i=n.forages;n.db=t;for(var a=0;a<i.length;a++)i[a]._dbInfo.db=t;return t})),e.storeName?n.then((function(t){if(t.objectStoreNames.contains(e.storeName)){var n=t.version+1;S(e);var i=m[e.name],r=i.forages;t.close();for(var s=0;s<r.length;s++){var l=r[s];l._dbInfo.db=null,l._dbInfo.version=n}return new o((function(t,i){var r=a.open(e.name,n);r.onerror=function(e){r.result.close(),i(e)},r.onupgradeneeded=function(){r.result.deleteObjectStore(e.storeName)},r.onsuccess=function(){var e=r.result;e.close(),t(e)}})).then((function(e){i.db=e;for(var t=0;t<r.length;t++){var n=r[t];n._dbInfo.db=e,E(n._dbInfo)}})).catch((function(t){throw(y(e,t)||o.resolve()).catch((function(){})),t}))}})):n.then((function(t){S(e);var n=m[e.name],i=n.forages;t.close();for(var r=0;r<i.length;r++)i[r]._dbInfo.db=null;return new o((function(t,n){var i=a.deleteDatabase(e.name);i.onerror=i.onblocked=function(e){var t=i.result;t&&t.close(),n(e)},i.onsuccess=function(){var e=i.result;e&&e.close(),t(e)}})).then((function(e){n.db=e;for(var t=0;t<i.length;t++)E(i[t]._dbInfo)})).catch((function(t){throw(y(e,t)||o.resolve()).catch((function(){})),t}))}))):o.reject("Invalid arguments"),t),n}},N="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",C=/^~~local_forage_type~([^~]+)~/,R="__lfsc__:",L=R.length,k="arbf",M="blob",x=L+k.length,B=Object.prototype.toString;function U(e){var t,n,i,a,r=.75*e.length,o=e.length,s=0;"="===e[e.length-1]&&(r--,"="===e[e.length-2]&&r--),r=new ArrayBuffer(r);for(var l=new Uint8Array(r),d=0;d<o;d+=4)t=N.indexOf(e[d]),n=N.indexOf(e[d+1]),i=N.indexOf(e[d+2]),a=N.indexOf(e[d+3]),l[s++]=t<<2|n>>4,l[s++]=(15&n)<<4|i>>2,l[s++]=(3&i)<<6|63&a;return r}function W(e){for(var t=new Uint8Array(e),n="",i=0;i<t.length;i+=3)n+=N[t[i]>>2],n+=N[(3&t[i])<<4|t[i+1]>>4],n+=N[(15&t[i+1])<<2|t[i+2]>>6],n+=N[63&t[i+2]];return t.length%3==2?n=n.substring(0,n.length-1)+"=":t.length%3==1&&(n=n.substring(0,n.length-2)+"=="),n}var H={serialize:function(e,t){var n="";if(e&&(n=B.call(e)),e&&("[object ArrayBuffer]"===n||e.buffer&&"[object ArrayBuffer]"===B.call(e.buffer))){var i,a=R;e instanceof ArrayBuffer?(i=e,a+=k):(i=e.buffer,"[object Int8Array]"===n?a+="si08":"[object Uint8Array]"===n?a+="ui08":"[object Uint8ClampedArray]"===n?a+="uic8":"[object Int16Array]"===n?a+="si16":"[object Uint16Array]"===n?a+="ur16":"[object Int32Array]"===n?a+="si32":"[object Uint32Array]"===n?a+="ui32":"[object Float32Array]"===n?a+="fl32":"[object Float64Array]"===n?a+="fl64":t(new Error("Failed to get type for BinaryArray"))),t(a+W(i))}else if("[object Blob]"===n)(n=new FileReader).onload=function(){var n="~~local_forage_type~"+e.type+"~"+W(this.result);t(R+M+n)},n.readAsArrayBuffer(e);else try{t(JSON.stringify(e))}catch(n){console.error("Couldn't convert value into a JSON string: ",e),t(null,n)}},deserialize:function(e){if(e.substring(0,L)!==R)return JSON.parse(e);var t,n=e.substring(x),i=e.substring(L,x);i===M&&C.test(n)&&(t=(e=n.match(C))[1],n=n.substring(e[0].length));var a=U(n);switch(i){case k:return a;case M:return r([a],{type:t});case"si08":return new Int8Array(a);case"ui08":return new Uint8Array(a);case"uic8":return new Uint8ClampedArray(a);case"si16":return new Int16Array(a);case"ur16":return new Uint16Array(a);case"si32":return new Int32Array(a);case"ui32":return new Uint32Array(a);case"fl32":return new Float32Array(a);case"fl64":return new Float64Array(a);default:throw new Error("Unkown type: "+i)}},stringToBuffer:U,bufferToString:W};function F(e,t,n,i){e.executeSql("CREATE TABLE IF NOT EXISTS "+t.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],n,i)}function G(e,t,n,i,a,r){e.executeSql(n,i,a,(function(e,o){o.code===o.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],(function(e,s){s.rows.length?r(e,o):F(e,t,(function(){e.executeSql(n,i,a,r)}),r)}),r):r(e,o)}),r)}function K(e,t,n,i){var a=this;e=d(e);var r=new o((function(r,o){a.ready().then((function(){var s=t=void 0===t?null:t,l=a._dbInfo;l.serializer.serialize(t,(function(t,d){d?o(d):l.db.transaction((function(n){G(n,l,"INSERT OR REPLACE INTO "+l.storeName+" (key, value) VALUES (?, ?)",[e,t],(function(){r(s)}),(function(e,t){o(t)}))}),(function(t){t.code===t.QUOTA_ERR&&(0<i?r(K.apply(a,[e,s,n,i-1])):o(t))}))}))})).catch(o)}));return s(r,n),r}var V={_driver:"webSQLStorage",_initStorage:function(e){var t=this,n={db:null};if(e)for(var i in e)n[i]="string"!=typeof e[i]?e[i].toString():e[i];var a=new o((function(e,i){try{n.db=openDatabase(n.name,String(n.version),n.description,n.size)}catch(e){return i(e)}n.db.transaction((function(a){F(a,n,(function(){t._dbInfo=n,e()}),(function(e,t){i(t)}))}),i)}));return n.serializer=H,a},_support:"function"==typeof openDatabase,iterate:function(e,t){var n=this,i=new o((function(t,i){n.ready().then((function(){var a=n._dbInfo;a.db.transaction((function(n){G(n,a,"SELECT * FROM "+a.storeName,[],(function(n,i){for(var r=i.rows,o=r.length,s=0;s<o;s++){var l=r.item(s),d=(d=l.value)&&a.serializer.deserialize(d);if(void 0!==(d=e(d,l.key,s+1)))return void t(d)}t()}),(function(e,t){i(t)}))}))})).catch(i)}));return s(i,t),i},getItem:function(e,t){var n=this;e=d(e);var i=new o((function(t,i){n.ready().then((function(){var a=n._dbInfo;a.db.transaction((function(n){G(n,a,"SELECT * FROM "+a.storeName+" WHERE key = ? LIMIT 1",[e],(function(e,n){n=(n=n.rows.length?n.rows.item(0).value:null)&&a.serializer.deserialize(n),t(n)}),(function(e,t){i(t)}))}))})).catch(i)}));return s(i,t),i},setItem:function(e,t,n){return K.apply(this,[e,t,n,1])},removeItem:function(e,t){var n=this;e=d(e);var i=new o((function(t,i){n.ready().then((function(){var a=n._dbInfo;a.db.transaction((function(n){G(n,a,"DELETE FROM "+a.storeName+" WHERE key = ?",[e],(function(){t()}),(function(e,t){i(t)}))}))})).catch(i)}));return s(i,t),i},clear:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){var i=t._dbInfo;i.db.transaction((function(t){G(t,i,"DELETE FROM "+i.storeName,[],(function(){e()}),(function(e,t){n(t)}))}))})).catch(n)}));return s(n,e),n},length:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){var i=t._dbInfo;i.db.transaction((function(t){G(t,i,"SELECT COUNT(key) as c FROM "+i.storeName,[],(function(t,n){n=n.rows.item(0).c,e(n)}),(function(e,t){n(t)}))}))})).catch(n)}));return s(n,e),n},key:function(e,t){var n=this,i=new o((function(t,i){n.ready().then((function(){var a=n._dbInfo;a.db.transaction((function(n){G(n,a,"SELECT key FROM "+a.storeName+" WHERE id = ? LIMIT 1",[e+1],(function(e,n){n=n.rows.length?n.rows.item(0).key:null,t(n)}),(function(e,t){i(t)}))}))})).catch(i)}));return s(i,t),i},keys:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){var i=t._dbInfo;i.db.transaction((function(t){G(t,i,"SELECT key FROM "+i.storeName,[],(function(t,n){for(var i=[],a=0;a<n.rows.length;a++)i.push(n.rows.item(a).key);e(i)}),(function(e,t){n(t)}))}))})).catch(n)}));return s(n,e),n},dropInstance:function(e,t){t=c.apply(this,arguments);var n=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||n.name,e.storeName=e.storeName||n.storeName);var i=this,a=e.name?new o((function(t){var a,r=e.name===n.name?i._dbInfo.db:openDatabase(e.name,"","",0);e.storeName?t({db:r,storeNames:[e.storeName]}):t((a=r,new o((function(e,t){a.transaction((function(n){n.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],(function(t,n){for(var i=[],r=0;r<n.rows.length;r++)i.push(n.rows.item(r).name);e({db:a,storeNames:i})}),(function(e,n){t(n)}))}),(function(e){t(e)}))}))))})).then((function(e){return new o((function(t,n){e.db.transaction((function(i){for(var a=[],r=0,s=e.storeNames.length;r<s;r++)a.push(function(e){return new o((function(t,n){i.executeSql("DROP TABLE IF EXISTS "+e,[],(function(){t()}),(function(e,t){n(t)}))}))}(e.storeNames[r]));o.all(a).then((function(){t()})).catch((function(e){n(e)}))}),(function(e){n(e)}))}))})):o.reject("Invalid arguments");return s(a,t),a}};function j(e,t){var n=e.name+"/";return e.storeName!==t.storeName&&(n+=e.storeName+"/"),n}function Y(e,t){for(var n,i,a=e.length,r=0;r<a;){if((n=e[r])===(i=t)||"number"==typeof n&&"number"==typeof i&&isNaN(n)&&isNaN(i))return 1;r++}}e={_driver:"localStorageWrapper",_initStorage:function(e){var t={};if(e)for(var n in e)t[n]=e[n];return t.keyPrefix=j(e,this._defaultConfig),!function(){var e="_localforage_support_test";try{return localStorage.setItem(e,!0),void localStorage.removeItem(e)}catch(e){return 1}}()||0<localStorage.length?((this._dbInfo=t).serializer=H,o.resolve()):o.reject()},_support:function(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}(),iterate:function(e,t){var n=this,i=n.ready().then((function(){for(var t=n._dbInfo,i=t.keyPrefix,a=i.length,r=localStorage.length,o=1,s=0;s<r;s++){var l=localStorage.key(s);if(0===l.indexOf(i)){var d=(d=localStorage.getItem(l))&&t.serializer.deserialize(d);if(void 0!==(d=e(d,l.substring(a),o++)))return d}}}));return s(i,t),i},getItem:function(e,t){var n=this;e=d(e);var i=n.ready().then((function(){var t=n._dbInfo,i=localStorage.getItem(t.keyPrefix+e);return i&&t.serializer.deserialize(i)}));return s(i,t),i},setItem:function(e,t,n){var i=this;e=d(e);var a=i.ready().then((function(){var n=t=void 0===t?null:t;return new o((function(a,r){var o=i._dbInfo;o.serializer.serialize(t,(function(t,i){if(i)r(i);else try{localStorage.setItem(o.keyPrefix+e,t),a(n)}catch(t){"QuotaExceededError"!==t.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==t.name||r(t),r(t)}}))}))}));return s(a,n),a},removeItem:function(e,t){var n=this;e=d(e);var i=n.ready().then((function(){var t=n._dbInfo;localStorage.removeItem(t.keyPrefix+e)}));return s(i,t),i},clear:function(e){var t=this,n=t.ready().then((function(){for(var e=t._dbInfo.keyPrefix,n=localStorage.length-1;0<=n;n--){var i=localStorage.key(n);0===i.indexOf(e)&&localStorage.removeItem(i)}}));return s(n,e),n},length:function(e){var t=this.keys().then((function(e){return e.length}));return s(t,e),t},key:function(e,t){var n=this,i=n.ready().then((function(){var t,i=n._dbInfo;try{t=localStorage.key(e)}catch(i){t=null}return t&&t.substring(i.keyPrefix.length)}));return s(i,t),i},keys:function(e){var t=this,n=t.ready().then((function(){for(var e=t._dbInfo,n=localStorage.length,i=[],a=0;a<n;a++){var r=localStorage.key(a);0===r.indexOf(e.keyPrefix)&&i.push(r.substring(e.keyPrefix.length))}return i}));return s(n,e),n},dropInstance:function(e,t){t=c.apply(this,arguments),(e="function"!=typeof e&&e||{}).name||(i=this.config(),e.name=e.name||i.name,e.storeName=e.storeName||i.storeName);var n=this,i=e.name?new o((function(t){e.storeName?t(j(e,n._defaultConfig)):t(e.name+"/")})).then((function(e){for(var t=localStorage.length-1;0<=t;t--){var n=localStorage.key(t);0===n.indexOf(e)&&localStorage.removeItem(n)}})):o.reject("Invalid arguments");return s(i,t),i}};var z=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},q={},$={},J={INDEXEDDB:P,WEBSQL:V,LOCALSTORAGE:e},X=(e=[J.INDEXEDDB._driver,J.WEBSQL._driver,J.LOCALSTORAGE._driver],["dropInstance"]),Q=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(X),Z={description:"",driver:e.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function ee(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];if(n)for(var i in n)n.hasOwnProperty(i)&&(z(n[i])?e[i]=n[i].slice():e[i]=n[i])}return e}function te(e){for(var t in function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,te),J){var n,i;J.hasOwnProperty(t)&&(i=(n=J[t])._driver,this[t]=i,q[i]||this.defineDriver(n))}this._defaultConfig=ee({},Z),this._config=ee({},this._defaultConfig,e),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch((function(){}))}e=new(te.prototype.config=function(e){if("object"!==(void 0===e?"undefined":i(e)))return"string"==typeof e?this._config[e]:this._config;if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e&&e.driver)||this.setDriver(this._config.driver)},te.prototype.defineDriver=function(e,t,n){var i=new o((function(t,n){try{var i=e._driver,a=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void n(a);for(var r=Q.concat("_initStorage"),l=0,d=r.length;l<d;l++){var c=r[l];if((!Y(X,c)||e[c])&&"function"!=typeof e[c])return void n(a)}!function(){for(var t=0,n=X.length;t<n;t++){var i=X[t];e[i]||(e[i]=function(e){return function(){var t=new Error("Method "+e+" is not implemented by the current driver");return s(t=o.reject(t),arguments[arguments.length-1]),t}}(i))}}();var u=function(n){q[i]&&console.info("Redefining LocalForage driver: "+i),q[i]=e,$[i]=n,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(u,n):u(!!e._support):u(!0)}catch(a){n(a)}}));return l(i,t,n),i},te.prototype.driver=function(){return this._driver||null},te.prototype.getDriver=function(e,t,n){return l(e=q[e]?o.resolve(q[e]):o.reject(new Error("Driver not found.")),t,n),e},te.prototype.getSerializer=function(e){var t=o.resolve(H);return l(t,e),t},te.prototype.ready=function(e){var t=this,n=t._driverSet.then((function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready}));return l(n,e,e),n},te.prototype.setDriver=function(e,t,n){var i=this;z(e)||(e=[e]);var a=this._getSupportedDrivers(e);function r(){i._config.driver=i.driver()}function s(e){return i._extend(e),r(),i._ready=i._initStorage(i._config),i._ready}return e=null!==this._driverSet?this._driverSet.catch((function(){return o.resolve()})):o.resolve(),this._driverSet=e.then((function(){var e=a[0];return i._dbInfo=null,i._ready=null,i.getDriver(e).then((function(e){i._driver=e._driver,r(),i._wrapLibraryMethodsWithReady(),i._initDriver=function(e){return function(){var t=0;return function n(){for(;t<e.length;){var a=e[t];return t++,i._dbInfo=null,i._ready=null,i.getDriver(a).then(s).catch(n)}r();var l=new Error("No available storage method found.");return i._driverSet=o.reject(l),i._driverSet}()}}(a)}))})).catch((function(){r();var e=new Error("No available storage method found.");return i._driverSet=o.reject(e),i._driverSet})),l(this._driverSet,t,n),this._driverSet},te.prototype.supports=function(e){return!!$[e]},te.prototype._extend=function(e){ee(this,e)},te.prototype._getSupportedDrivers=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var a=e[n];this.supports(a)&&t.push(a)}return t},te.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=Q.length;e<t;e++)!function(e,t){e[t]=function(){var n=arguments;return e.ready().then((function(){return e[t].apply(e,n)}))}}(this,Q[e])},te.prototype.createInstance=function(e){return new te(e)},te),t.exports=e},{3:3}]},{},[4])(4)},375:(e,t,n)=>{let i;e.exports="function"==typeof queueMicrotask?queueMicrotask.bind("undefined"!=typeof window?window:n.g):e=>(i=i||Promise.resolve()).then(e).catch((e=>setTimeout((()=>{throw e}),0)))},967:(e,t,n)=>{e.exports=function(e,t,n){if("number"!=typeof t)throw new Error("second argument must be a Number");let a,r,o,s,l,d,c=!0;function u(e){function t(){n&&n(e,a),n=null}c?i(t):t()}function g(t,n,i){if(a[t]=i,n&&(l=!0),0==--o||n)u(n);else if(!l&&d<r){let t;s?(t=s[d],d+=1,e[t]((function(e,n){g(t,e,n)}))):(t=d,d+=1,e[t]((function(e,n){g(t,e,n)})))}}o=r=Array.isArray(e)?(a=[],e.length):(s=Object.keys(e),a={},s.length),d=t,o?s?s.some((function(n,i){return e[n]((function(e,t){g(n,e,t)})),i===t-1})):e.some((function(e,n){return e((function(e,t){g(n,e,t)})),n===t-1})):u(null),c=!1};const i=n(375)},877:(e,t,n)=>{var i=n(570),a=n(171);(n=a).v1=i,n.v4=a,e.exports=n},327:e=>{for(var t=[],n=0;n<256;++n)t[n]=(n+256).toString(16).substr(1);e.exports=function(e,n){var i=n||0;return[(n=t)[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],n[e[+i]]].join("")}},217:e=>{var t,n,i="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);i?(t=new Uint8Array(16),e.exports=function(){return i(t),t}):(n=new Array(16),e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),n[t]=e>>>((3&t)<<3)&255;return n})},570:(e,t,n)=>{var i,a,r=n(217),o=n(327),s=0,l=0;e.exports=function(e,t,n){var d=t&&n||0,c=t||[],u=(e=e||{}).node||i,g=void 0!==e.clockseq?e.clockseq:a;null!=u&&null!=g||(p=r(),null==u&&(u=i=[1|p[0],p[1],p[2],p[3],p[4],p[5]]),null==g&&(g=a=16383&(p[6]<<8|p[7])));var m=void 0!==e.msecs?e.msecs:(new Date).getTime(),p=(n=void 0!==e.nsecs?e.nsecs:l+1,m-s+(n-l)/1e4);if(p<0&&void 0===e.clockseq&&(g=g+1&16383),1e4<=(n=(p<0||s<m)&&void 0===e.nsecs?0:n))throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");s=m,a=g,n=(1e4*(268435455&(m+=122192928e5))+(l=n))%4294967296,c[d++]=n>>>24&255,c[d++]=n>>>16&255,c[d++]=n>>>8&255,c[d++]=255&n,m=m/4294967296*1e4&268435455,c[d++]=m>>>8&255,c[d++]=255&m,c[d++]=m>>>24&15|16,c[d++]=m>>>16&255,c[d++]=g>>>8|128,c[d++]=255&g;for(var h=0;h<6;++h)c[d+h]=u[h];return t||o(c)}},171:(e,t,n)=>{var i=n(217),a=n(327);e.exports=function(e,t,n){var r=t&&n||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var o=(e=e||{}).random||(e.rng||i)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t)for(var s=0;s<16;++s)t[r+s]=o[s];return t||a(o)}}},t={};function n(i){var a=t[i];return void 0!==a||(a=t[i]={exports:{}},e[i](a,a.exports,n)),a.exports}n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{"use strict";n.r(i),n.d(i,{exportForTesting:()=>Qa,initializeLaunchSequence:()=>qa});var e=n(483);const t="initData",a="browserDetails",r="unifiedLogs",o="hasUserLoggedOut",s={USER_DATA:"USER_DATA",PUSH_TOKEN:"PUSH_TOKEN",SUBSCRIPTION_DETAILS:"SUBSCRIPTION_DETAILS",SETUP_TIME:"SETUP_TIME",OPT_IN_SHOWN_TIME:"OPT_IN_SHOWN_TIME",OPTED_STATUS_TRACK_TIME:"OPTED_STATUS_TRACK_TIME",SOFT_ASK_STATUS:"SOFT_ASK_STATUS",HARD_ASK_STATUS:"HARD_ASK_STATUS",WEB_SETTINGS:"WEB_SETTINGS",GRACEFUL_DATA:"GRACEFUL_DATA",Q:{PREFIX:"Q",REPORT:"REPORT",DEVICE:"DEVICE"},INIT_DATA:"INIT_DATA",OLD_SDK:{USER_DATA:"moengage_data",SUBSCRIPTION_DETAILS:"MOE_PUSH_ENDPOINT",PUSH_TOKEN:"MOE_PUSH_TOKEN"},BROWSER_DETAILS:"browserDetails",SESSION:"SESSION",DEVICE_DATA:"DEVICE_DATA",IDENTITY_MAP:"IDENTITY_MAP",SDK_VERSION:"SDK_VERSION",SDK_DISABLED:"SDK_DISABLED"},l=2,d="COOKIE_SHARING",c={COOKIE_NAME_MAPPING:{[s.USER_DATA]:"moe_u_d",[s.SUBSCRIPTION_DETAILS]:"moe_s_d",[s.PUSH_TOKEN]:"moe_p_t",[s.OPT_IN_SHOWN_TIME]:"moe_o_s_t",[s.SOFT_ASK_STATUS]:"moe_s_a_s",[s.HARD_ASK_STATUS]:"moe_h_a_s",[s.SESSION]:"moe_s_n",[s.DEVICE_DATA]:"moe_d_d",[s.IDENTITY_MAP]:"moe_i_m",[s.SDK_DISABLED]:"moe_dis",COOKIE_SHARING:"moe_c_s"},PERMISSION_STATE_MAPPING:{prompt:2,granted:1,dismissed:3,denied:0,shown:4,"not shown":5,allowed:6},SUBSCRIPTION_DETAILS_KEYS:{domain:"d",token:"t",endpoint:"e",keys:"k",p256dh:"p",auth:"a"},USER_DATA_KEYS:{attributes:"a",subscribedToOldSdk:"s_old",deviceUuid:"d_id",deviceAdded:"d_added"},ATTRIBUTE_KEYS:{key:"k",value:"v",updated_at:"u_at"},IDENTITY_MAP_KEYS:{userIdentities:"u_i",previousIdentities:"p_i",previousIdentitiesUpdatedTime:"p_i_u_t"},SESSION_KEYS:{sessionKey:"s_k",sessionStartTime:"s_s_t",sessionMaxTime:"s_m_t",customIdentifiersToTrack:"c_i_t_t",sessionExpiryTime:"s_e_t",numberOfSessions:"n_o_s",currentSource:"c_s"},SOURCE_KEYS:{source:"s",medium:"m",source_url:"s_u",term:"t",campaign_name:"c_n",campaign_id:"c_id",content:"c",extra:"e"},DEVICE_DATA_KEYS:{deviceUniqueId:"d_uid"}},u="MOE_WEB_UNSUBSCRIBED",g="EVENT_ACTION_WEB_SESSION_START",m="MOE_PAGE_VIEWED",p="MOE_WEB_OPTIN_BANNER_LOAD",h="MOE_WEB_OPTIN_CLOSED",v="MOE_WEB_OPTIN_ACCEPTED",f="MOE_OPT_IN_SHOWN",S="MOE_OPT_IN_ALLOWED",E="MOE_OPT_IN_DISMISSED",y="MOE_OPT_IN_BLOCKED",b="MOE_OPT_IN_ATTEMPT",_="MOE_LOGOUT",T="EVENT_ACTION_DEVICE_ATTRIBUTE",I="MOE_PUSH_PERMISSION_STATE_ALLOWED",A="MOE_PUSH_PERMISSION_STATE_BLOCKED",w="MOE_PAGE_EXIT",D="MOE_PAGE_SCROLL",O="MOE_PAGE_URL_EVENT",P="USER_ATTRIBUTE_UNIQUE_ID",N="USER_ATTRIBUTE_USER_EMAIL",C="USER_ATTRIBUTE_USER_NAME",R="USER_ATTRIBUTE_USER_FIRST_NAME",L="USER_ATTRIBUTE_USER_LAST_NAME",k="USER_ATTRIBUTE_USER_MOBILE",M="USER_ATTRIBUTE_USER_GENDER",x="USER_ATTRIBUTE_USER_BDAY",B=["id","first_name","last_name","email","mobile","name","gender","birthday"],U=[P,"USER_ID_MODIFIED_FROM"],W="MOE_LIFECYCLE",H={MOE_INIT:"SDK_INITIALIZED",SETTINGS_FETCHED:"SETTINGS_FETCHED",EVENT_TRACKED:"EVENT_TRACKED",DEVICE_UUID:"DEVICE_UUID",MOE_INIT_COMPLETED:"SDK_INITIALIZATION_COMPLETED",CARDS_INIT:"CARDS_INITIALIZED",SDK_DISABLED:"SDK_DISABLED",SDK_ENABLED:"SDK_ENABLED",OSM_INIT:"OSM_INITIALIZED",WEBP_INIT:"WEBP_INITIALIZED"},F={HARD_ASK_SHOWN:"HARD_ASK_SHOWN",HARD_ASK_DISMISSED:"HARD_ASK_DISMISSED",HARD_ASK_ATTEMPTED:"HARD_ASK_ATTEMPTED",HARD_ASK_ALLOWED:"HARD_ASK_ALLOWED",HARD_ASK_DENIED:"HARD_ASK_DENIED",SOFT_ASK_SHOWN:"SOFT_ASK_SHOWN",SOFT_ASK_DISMISSED:"SOFT_ASK_DISMISSED",SOFT_ASK_ALLOWED:"SOFT_ASK_ALLOWED"},G="USER_LIFECYCLE",K={USER_IDENTITY_UPDATE:"USER_IDENTITY_UPDATE",LOGOUT:"LOGOUT"},V="SPA",j={PAGE_CHANGED:"PAGE_CHANGED"},Y={code:1e3,reason:"Web push not supported in current browser environment"},z={code:1001,reason:"Registering the service worker failed"},q={code:1002,reason:"Web push settings not configured"},$={code:1004,reason:"Hard ask was dismissed to many times"},J={code:1005,reason:"Service worker can not be registered on this page due to scope issues"},X="https://media.giphy.com/media/KDRv3QggAjyo/giphy.gif",Q={DC_1:"sdk-01.moengage.com",DC_2:"sdk-02.moengage.com",DC_3:"sdk-03.moengage.com",DC_4:"sdk-04.moengage.com",DC_5:"sdk-05.moengage.com",DC_6:"sdk-06.moengage.com",DC_100:"sdk-100.moengage.com",EU:"sdk-02.moengage.com",IN:"sdk-03.moengage.com"},Z={MOE_DASHBOARD:"https://dashboard.moengage.com",WEBSDK_DOCS:"https://developers.moengage.com/hc/en-us/articles/360060713252-Web-SDK-Integration",SELF_HANDLED_DOCS:"https://developers.moengage.com/hc/en-us/articles/360061219351-Configure-Self-Handled-Opt-In"},ee="Dashboard --\x3e Settings --\x3e Channel --\x3e Push",te="SESSION",ne="moe_tracking",ie="events",ae="batched_events",re="moe_database",oe="moe_data",se="moe_uuid",le="MoengagePageEventHistoryManager",de={HOST_1:"https://sdk-01.moengage.com/",HOST_2:"https://sdk-02.moengage.com/",HOST_3:"https://sdk-03.moengage.com/",HOST_4:"https://sdk-04.moengage.com/",HOST_5:"https://sdk-05.moengage.com/",HOST_6:"https://sdk-06.moengage.com/",HOST_100:"https://sdk-100.moengage.com/",API:{META:"v3/campaigns/inapp/live",CAMPAIGN_PAYLOAD:"v3/campaigns/inapp/live/",DRAFT_CAMPAIGN_PAYLOAD:"v3/campaigns/inapp/test/",STATS:"v3/campaigns/inapp/live/stats",CAMPAIGNS_PAYLOAD:"v3/campaigns/inapp/live/campaigns"},DRAFT_CAMPAIGN_TPYES:{WEB_PERSONALIZATON:"web_personalization",ONSITE_MESSAGING:"onsite_messaging"},META_REFRESH_TIME:9e5,DATABASE_NAME:"moe_onsite",OSM_MODULE:"moeOnsite",DELIVERY_FUNNEL:{ATTEMPTED:{CAMPAIGN_ATTEMPTED:"ATM"},PRIORITIZED:{CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE:"PRT_HIGH_PRT_CMP_AVL",CAMPAIGN_PRIORITY_MAX_TIMES_SHOWN:"PRT_MAX_TIM_SWN",CAMPAIGN_PRIORITY_MIN_DELAY:"PRT_MIN_DEL",CAMPAIGN_PRIORITY_GLOBAL_DELAY:"PRT_GBL_DEL",CAMPAIGN_PRIORITY_EXPIRED:"PRT_EXP"},DELIVERED:{CAMPAIGN_DELIVERED_API_FAILURE:"DLV_API_FLR",CAMPAIGN_DELIVERED_MANDATORY_PARAMS_MISSING:"DLV_MAND_PARM_MIS"},IMPRESSION:{CAMPAIGN_IMPRESSION_URL_CHANGED:"IMP_URL_CHG",CAMPAIGN_IMPRESSION_GLOBAL_DELAY:"IMP_GBL_DEL",CAMPAIGN_IMPRESSION_MAX_TIMES_SHOWN:"IMP_MAX_TIM_SHW",CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE:"IMP_ANTR_CMP_VISB",CAMPAIGN_IMPRESSION_CANCEL_BEFORE_DELAY:"IMP_CNCL_BFR_DEL"},EVALUATION:{CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED:"EVL_PATH_TIME_EXP",CAMPAIGN_EVALUATION_USER_NOT_ON_APP:"EVL_USER_NOT_ON_APP"}},STORES:{CAMPAIGNS_META:{NAME:"campaigns_meta"},CAMPAIGNS_TAGS:{NAME:"campaigns_tags"},CAMPAIGNS_STATS:{NAME:"campaigns_stats"},EXIT_INTENT_CAMPAIGN_STORE:{NAME:"exit_intent"},SERVICE_META:{NAME:"service_meta",KEYS:{LAST_META_CALL_TIME:"last_meta_call_time",GLOBAL_DELAY:"global_delay_between_inapps",LAST_INAPP_SHOWN_TIME:"last_inapp_shown",LAST_FETCH_SDK_VERSION:"last_fetch_sdk_version",UNIQUE_ID:"unique_id"}},PENDING_SECONDARY_EVENTS:{NAME:"pending_secondary_events"},PENDING_TIMER_CAMPAIGNS:{NAME:"pending_timer_campaigns"},TRIGGERING_PRIMARY_EVENTS:{NAME:"triggering_primary_events"}},EVENT_NAMES:{OSM:{CLICK:"MOE_ONSITE_MESSAGE_CLICKED",IMPRESSION:"MOE_ONSITE_MESSAGE_SHOWN",DISMISS:"MOE_ONSITE_MESSAGE_DISMISSED",AUTO_DISMIS:"MOE_ONSITE_MESSAGE_AUTO_DISMISS",DELIVERED:"MOE_ONSITE_MESSAGE_DELIVERED",TYPE:"onsite"},WP:{CLICK:"MOE_WEBP_MESSAGE_CLICKED",IMPRESSION:"MOE_WEBP_MESSAGE_SHOWN",DISMISS:"MOE_WEBP_MESSAGE_DISMISSED",DELIVERED:"MOE_WEBP_MESSAGE_DELIVERED",TYPE:"webp"}},WEB_HELPER_IFRAME_URL:"https://cdn.moengage.com/webpush/beta/webpushhelper.html",IFRAME_CHANNEL:"inapp_helper",IFRAME_TOPICS:{COOKIE_STORAGE:"COOKIE_STORAGE"},COOKIE_STORAGE:{TEST_DRAFT_TYPE:"moe_inapp_draft_type",TEST_DRAFT_ID:"moe_inapp_draft_id",TEST_DRAFT_TAG:"moe_inapp_draft_tag",TEST_CAMPAIGN_META:"test_campaign_meta",TEST_TEMPLATE_TYPE:"test_template_type",TEST_VARIATION:"moe_inapp_draft_variation",TEST_LOCALE:"moe_inapp_draft_locale"},CSS_SELECTORS:{CLICK_INAPP:"moe-inapp-click",DISMISS_INAPP:"moe-inapp-close"},EXIT_INTENT:{CONFIG:{SCROLL_DOWN_THRESHOLD:50,SCROLL_UP_THRESHOLD:5,SCROLL_INTERVAL:1e3}},POSITIONED_TEMPLATE:'data-editor-type="MOE_EDITOR"',SIDE_BANNER:'data-template-type="SIDE_BANNER"',PUSH_BANNER:"moe-osm-pusher",GCG_ERROR_CODE:"E001",SCROLL_CAMPAIGN_THROTTLING_TIME:1500},ce={CARDS:{name:"CARDS",src:"https://cdn.moengage.com/release/dc_1/versions/2.56.1/moe_webSdk_cards.min.latest.js",windowLocation:"moeCards"}},ue="moe_database",ge={NAME:"offline_data"},me="v2/sdk/report/",pe=15e3,he="number",ve={TOPIC:"MOE_AUTOMATED_EVENTS",NAMES:[u,g,m,p,h,v,"MOE_USER_SUBSCRIBED",b,f,S,E,y,I,A,_,de.EVENT_NAMES.OSM.CLICK,de.EVENT_NAMES.OSM.IMPRESSION,de.EVENT_NAMES.OSM.DISMISS,de.EVENT_NAMES.OSM.AUTO_DISMIS]},fe=[b],Se="IOS_PERMISSION_DENIED",Ee="moe_push_opted",ye="v1/sdk_logging/",be="v2/device/add",_e="v2/device/token-check",Te="v2/report/add",Ie={TV:"tv",TABLET:"tablet",MOBILE:"mobile",WEB:"web"},Ae="User is offline.",we=[{moeName:"uid",attributeName:"USER_ATTRIBUTE_UNIQUE_ID",programName:"id"},{moeName:"u_em",attributeName:"USER_ATTRIBUTE_USER_EMAIL",programName:"email"},{moeName:"u_gd",attributeName:"USER_ATTRIBUTE_USER_GENDER",programName:"gender"},{moeName:"u_bd",attributeName:"USER_ATTRIBUTE_USER_BDAY",programName:"birthday"},{moeName:"u_n",attributeName:"USER_ATTRIBUTE_USER_NAME",programName:"name"},{moeName:"u_fn",attributeName:"USER_ATTRIBUTE_USER_FIRST_NAME",programName:"first_name"},{moeName:"u_ln",attributeName:"USER_ATTRIBUTE_USER_LAST_NAME",programName:"last_name"},{moeName:"u_mb",attributeName:"USER_ATTRIBUTE_USER_MOBILE",programName:"mobile"}],De=["Google Chrome","Mozilla Firefox","Opera","Apple Safari","Edge"],Oe="identifiers",Pe=["moe-card=1"],Ne=[s.DEVICE_DATA],Ce="moe-floating-icon-iframe",Re="moe-floating-icon";function Le(e,t,n){return null!=e&&t?(e=e[(t=Array.isArray(t)?t:t.split("."))[0]])&&1<t.length?Le(e,t.slice(1),n):void 0===e?n||null:e:null}class ke{static set(e,t){ke.baseLogTag,window&&(window.moeInternals?window.moeInternals.ephemeral||(window.moeInternals.ephemeral={}):(window.moeInternals={},window.moeInternals.ephemeral={}),window.moeInternals.ephemeral[e]=t)}static get(e){return Le(window,"moeInternals.ephemeral."+e,null)}static clear(){window&&(window.moeInternals={},window.moeInternals.ephemeral={})}}function Me(){return window[window.moengage_object||"Moengage"]}ke.baseLogTag="EphemeralStorage";class xe{static logData(e,t){return{log_type:e,sent_time:(new Date).toISOString(),lake_fields:t}}static setRemoteLogging(e,t){return this.isTrackingEnabled||(this.logLevel=e,this.isTrackingEnabled=t,this.isTrackingEnabled)}static log(e,t,n,i,...a){!this.isTrackingEnabled||e!==this.logLevel&&"verbose"!==this.logLevel||Me().remoteLogs.addRemoteLogs(this.logData(e,{msg:n+[...a].toString(),file_name:t,trace:i}))}}let Be="color: white; background: #41AE55; border-radius: 5px;";var Ue;class We{static setLogLevel(e,t){var n=We.baseLogTag+".setLogLevel";null==ke.get(r)&&ke.set(r,[]),null==e?We.logLevel=0:e in[0,1,2]?0<(We.logLevel=e)&&t&&We.releaseAllLogs():We.warn(0,n,"Value",e,"not supported for setDebugLevel(). Current log level is",We.logLevel,". Debug level can only be [0, 1, 2]")}static setLogTabStyle(e){We.tagLogStyle=We.tagLogStyle.replace("#48beab",e)}static log(e,t,n,...i){e<=We.logLevel?console.log("%c "+We.logBrand+" %c %c info %c %c "+t+" ",Be,"","color: white; background: #18a0bf; border-radius: 5px;","",We.tagLogStyle,n,...i):We.cacheLog((()=>{We.log(e,t,n,...i)}))}static remoteLogTracking(e,t,n,i,...a){xe.log(t,n,i,...a),this.log(e,n,i,...a)}static error(e,t,n,...i){var a;null!==(a=i[i.length-1])&&void 0!==a&&a.isCached||xe.log("error",t,n,...i),e<=We.logLevel?console.error("%c "+We.logBrand+" %c %c error %c %c "+t+" ",Be,"","color: white; background: #cc0a0a; border-radius: 5px;","",We.tagLogStyle,n,...i.slice(0,-1)):We.cacheLog((()=>{We.error(e,t,n,...i,{isCached:!0})}))}static warn(e,t,n,...i){var a;null!==(a=i[i.length-1])&&void 0!==a&&a.isCached||xe.log("warning",t,n,...i),e<=We.logLevel?console.warn("%c "+We.logBrand+" %c %c warn %c %c "+t+" ",Be,"","color: white; background: #e8ab51; border-radius: 5px;","",We.tagLogStyle,n,...i.slice(0,-1)):We.cacheLog((()=>{We.warn(e,t,n,...i,{isCached:!0})}))}static customLabel(e,t,n,...i){e<=We.logLevel?console.log("%c "+We.logBrand+" %c %c "+t+" %c %c "+n+" %c ",Be,"",We.tagLogStyle,"","color: white; background: #a400ff; border-radius: 5px;","",...i):We.cacheLog((()=>{We.customLabel(e,t,n,...i)}))}static image(e,t){e<=We.logLevel?console.log("%c+","font-size: 1px; padding: 20px 80px; line-height: 45px; background: url("+t+"); background-size: 160px 90px; color: transparent;"):We.cacheLog((()=>{We.image(e,t)}))}static releaseAllLogs(){var e=ke.get(r),t=e.length;const n=e;if(ke.set(r,[]),0<t){We.log(0,"Logger.releaseAllLogs","<---- HISTORICAL LOGS BEGIN ----\x3e");for(let e=0;e<t;e++)n[e]();We.log(0,"Logger.releaseAllLogs","<---- HISTORICAL LOGS END ----\x3e")}}static setLogBrand(e){We.logBrand=e}static setBrandColor(e){Be="color: white; background: "+e+"; border-radius: 5px;"}static cacheLog(e){let t=ke.get(r);null==t&&(t=[]),t.push(e),ke.set(r,t)}}We.baseLogTag="Logger",We.logBrand="MoEngage",We.logLevel=0,We.tagLogStyle="color: white; background: #48beab; border-radius: 5px;";class He{constructor(e){this.debugLevel=0,this.cluster=null,this.environment=null,this.baseDomainName="https://sdk-01.moengage.com/",this.inapp=null,this.customSoftAsk=null;var t=He.baseLogTag+".constructor";null!=Le(e,"app_id",null)?(this.appId=Le(e,"app_id",null),this.integrationType=Ue.OLD_SDK):null!=Le(e,"appId",null)?(this.appId=Le(e,"appId",null),this.integrationType=Ue.NEW_SDK):(We.error(1,t,"App Id not specified. Please check docs page to complete the integration - ",Z.WEBSDK_DOCS),this.integrationType=null),null!=Le(e,"debug_logs",null)?this.debugLevel=Le(e,"debug_logs",0):null!=Le(e,"debugLevel",null)?this.debugLevel=Le(e,"debugLevel",0):(We.log(2,t,"No log level config found. Using default value of",0),this.debugLevel=0),this.appId&&(this.baseDomainName="https://sdk-01.moengage.com/",this.forceSwUpdate=Le(e,"forceSwUpdate",!1),this.cluster="DC_1",this.cluster=Le(e,"cluster",this.cluster),this.cluster&&null!=Q[this.cluster.toUpperCase()]&&(this.environment=Q[this.cluster.toUpperCase()]),Le(e,"environment",null)&&(this.environment=e.environment),this.environment&&(this.baseDomainName="https://"+this.environment+"/"),0<this.debugLevel&&this.appId.indexOf("_DEBUG")<0?this.appId=this.appId+"_DEBUG":0===this.debugLevel&&0<=this.appId.indexOf("_DEBUG")&&(this.appId=this.appId.substr(0,this.appId.indexOf("_DEBUG"))),this.swPath=Le(e,"swPath",null),null!=e.customSoftAsk?this.customSoftAsk={mainClass:Le(e,"customSoftAsk.mainClass",null),allowClass:Le(e,"customSoftAsk.allowClass",null),dismissClass:Le(e,"customSoftAsk.dismissClass",null)}:this.customSoftAsk={mainClass:Le(e,"main_class",null),allowClass:Le(e,"allow_class",null),dismissClass:Le(e,"block_class",null)},null!=Le(e,"inapp.host",null)&&(this.inapp={host:Le(e,"inapp.host",null)}),null!=Le(e,"swScope",null)&&(this.swScope=Le(e,"swScope",null)),null!=Le(e,"disable_onsite",null)&&(this.disableOnsite=Le(e,"disable_onsite",!1)),null!=Le(e,"enableSPA",null)&&(this.enableSPA=Le(e,"enableSPA",!1)),null!=Le(e,"cards",null)&&(this.cards=Le(e,"cards",{})),null!=Le(e,"proxyDomains",null)&&(this.proxyDomains=Le(e,"proxyDomains",null),this.proxyDomains.api&&(this.baseDomainName="https://"+this.proxyDomains.api+"/",this.environment=this.proxyDomains.api)),null!=Le(e,"disable_web_push",null)&&(this.disableWebPush=Le(e,"disable_web_push",!1)),null!=Le(e,"disableCookies",null)&&(this.disableCookies=Le(e,"disableCookies",!1)),null!=Le(e,"disableSdk",null)&&(this.disableSdk=Le(e,"disableSdk",!1)))}static save(e){ke.set(t,new He(e)),nt.set(s.INIT_DATA,new He(e))}static get(){return ke.get(t)}}function Fe(e,t){return!He.get().disableWebPush&&e.isWebPushEnabled&&0<=De.indexOf(t.name)&&navigator.serviceWorker&&"PushManager"in window&&"Notification"in window}function Ge(e,t){var n,i,a;return t.isChrome()||t.isOpera()||t.isEdge()||t.isSafari()?"vapid"===(null===(n=null==e?void 0:e.chrome)||void 0===n?void 0:n.subscriptionMode)&&null!==(i=null==e?void 0:e.chrome)&&void 0!==i&&i.vapidPublicKey:t.isFirefox()&&"vapid"===(null===(t=null==e?void 0:e.firefox)||void 0===t?void 0:t.subscriptionMode)&&null!==(a=null==e?void 0:e.firefox)&&void 0!==a&&a.vapidPublicKey}function Ke(){var e;const t=null===(e=He.get())||void 0===e?void 0:e.swPath;return!(!t||!t.includes("tools/moengage"))}function Ve(e,t){return!(e!==N&&e!==k&&!t.includes(e))}function je(e,t){var n;return t.isChrome()||t.isOpera()||t.isEdge()||t.isSafari()?(null===(n=null==e?void 0:e.chrome)||void 0===n?void 0:n.vapidPublicKey)||"":t.isFirefox()&&(null===(e=null==e?void 0:e.firefox)||void 0===e?void 0:e.vapidPublicKey)||""}He.baseLogTag="InitData",(nn=Ue=Ue||{}).OLD_SDK="OLD_SDK",nn.NEW_SDK="NEW_SDK";const{SUBSCRIPTION_DETAILS_KEYS:Ye,USER_DATA_KEYS:ze,ATTRIBUTE_KEYS:qe,IDENTITY_MAP_KEYS:$e,SESSION_KEYS:Je,SOURCE_KEYS:Xe,DEVICE_DATA_KEYS:Qe}=c;class Ze{static getCompressedKeyName(e){return c.COOKIE_NAME_MAPPING[e]||e}static getOriginalName(e){return Ze.REVERSE_COOKIE_NAME_MAPPING[e]||e}static compressValue(e,t){return null==e?e:"boolean"!=typeof e||t!==s.SDK_DISABLED&&t!==d?"string"==typeof e&&Object.keys(c.PERMISSION_STATE_MAPPING).includes(e)?c.PERMISSION_STATE_MAPPING[e]:"object"!=typeof e||Array.isArray(e)?e:Ze.compressObject(e,t):e?1:0}static decompressValue(e,t){return null==e?e:"number"!=typeof e||0!==e&&1!==e||t!==s.SDK_DISABLED&&t!==d?"number"==typeof e&&0<=e&&e<=6&&(t===s.SOFT_ASK_STATUS||t===s.HARD_ASK_STATUS)?Object.keys(c.PERMISSION_STATE_MAPPING).find((t=>c.PERMISSION_STATE_MAPPING[t]===e)):"object"!=typeof e||Array.isArray(e)?e:Ze.decompressObject(e,t):1===e}static compressObject(e,t){if(!e)return e;switch(t){case s.SUBSCRIPTION_DETAILS:return function(e){if(!e)return e;var{domain:t,token:n,endpoint:i,keys:a,p256dh:r,auth:o}=Ye;const s={};if(e.domain&&(s[t]=e.domain),e.token&&(s[n]=e.token),e.endpoint){let t=e.endpoint;t.startsWith("https://fcm.googleapis.com/fcm/send/")&&(t="h://fcm.googleapis.com/fcm/send/"),s[i]=t}return e.keys&&(s[a]={},e.keys.p256dh&&(s[a][r]=e.keys.p256dh),e.keys.auth&&(s[a][o]=e.keys.auth)),s}(e);case s.USER_DATA:return function(e){if(!e)return e;var{attributes:t,subscribedToOldSdk:n,deviceUuid:i,deviceAdded:a}=ze;const{key:r,value:o,updated_at:s}=qe,l={};return e.attributes&&(l[t]=e.attributes.map((e=>{const t={};var n,i;return e.key&&(t[r]=(n=e.key,(i=we.find((e=>e.attributeName===n)))?i.moeName:n)),void 0!==e.value&&(t[o]=e.value),void 0!==e.updated_at&&(t[s]=e.updated_at),t}))),void 0!==e.subscribedToOldSdk&&(l[n]=e.subscribedToOldSdk),e.deviceUuid&&(l[i]=e.deviceUuid),void 0!==e.deviceAdded&&(l[a]=e.deviceAdded),l}(e);case s.IDENTITY_MAP:return function(e){if(!e)return e;var{userIdentities:t,previousIdentities:n,previousIdentitiesUpdatedTime:i}=$e;const a={};return e.userIdentities&&(a[t]=e.userIdentities),e.previousIdentities&&(a[n]=e.previousIdentities),void 0!==e.previousIdentitiesUpdatedTime&&(a[i]=e.previousIdentitiesUpdatedTime),a}(e);case s.SESSION:return function(e){if(!e)return e;var{sessionKey:t,sessionStartTime:n,sessionMaxTime:i,customIdentifiersToTrack:a,sessionExpiryTime:r,numberOfSessions:o,currentSource:s}=Je;const l={};return e.sessionKey&&(l[t]=e.sessionKey),e.sessionStartTime&&(l[n]=e.sessionStartTime),void 0!==e.sessionMaxTime&&(l[i]=e.sessionMaxTime),e.customIdentifiersToTrack&&(l[a]=e.customIdentifiersToTrack),void 0!==e.sessionExpiryTime&&(l[r]=e.sessionExpiryTime),void 0!==e.numberOfSessions&&(l[o]=e.numberOfSessions),e.currentSource&&(l[s]=function(e){if(!e)return e;const{source:t,medium:n,source_url:i,term:a,campaign_name:r,campaign_id:o,content:s,extra:l}=Xe,d={};return e.source&&(d[t]=e.source),e.medium&&(d[n]=e.medium),e.source_url&&(d[i]=e.source_url),e.term&&(d[a]=e.term),e.campaign_name&&(d[r]=e.campaign_name),e.campaign_id&&(d[o]=e.campaign_id),e.content&&(d[s]=e.content),e.extra&&(d[l]=e.extra),d}(e.currentSource)),l}(e);case s.DEVICE_DATA:return function(e){if(!e)return e;var t=Qe.deviceUniqueId;const n={};return e.deviceUniqueId&&(n[t]=e.deviceUniqueId),n}(e);default:return e}}static decompressObject(e,t){if(!e)return e;switch(t){case s.SUBSCRIPTION_DETAILS:return function(e){if(!e)return e;var{domain:t,token:n,endpoint:i,keys:a,p256dh:r,auth:o}=Ye;const s={};if(e[t]&&(s.domain=e[t]),e[n]&&(s.token=e[n]),e[i]){let t=e[i];"h://fcm.googleapis.com/fcm/send/"===t&&(t="https://fcm.googleapis.com/fcm/send/"),s.endpoint=t}return e[a]&&(s.keys={},e[a][r]&&(s.keys.p256dh=e[a][r]),e[a][o]&&(s.keys.auth=e[a][o])),s}(e);case s.USER_DATA:return function(e){if(!e)return e;var{attributes:t,subscribedToOldSdk:n,deviceUuid:i,deviceAdded:a}=ze;const{key:r,value:o,updated_at:s}=qe,l={};return e[t]&&(l.attributes=e[t].map((e=>{const t={};var n,i;return e[r]&&(t.key=(n=e[r],(i=we.find((e=>e.moeName===n)))?i.attributeName:n)),void 0!==e[o]&&(t.value=e[o]),void 0!==e[s]&&(t.updated_at=e[s]),t}))),void 0!==e[n]&&(l.subscribedToOldSdk=e[n]),e[i]&&(l.deviceUuid=e[i]),void 0!==e[a]&&(l.deviceAdded=e[a]),l}(e);case s.IDENTITY_MAP:return function(e){if(!e)return e;var{userIdentities:t,previousIdentities:n,previousIdentitiesUpdatedTime:i}=$e;const a={};return e[t]&&(a.userIdentities=e[t]),e[n]&&(a.previousIdentities=e[n]),void 0!==e[i]&&(a.previousIdentitiesUpdatedTime=e[i]),a}(e);case s.SESSION:return function(e){if(!e)return e;var{sessionKey:t,sessionStartTime:n,sessionMaxTime:i,customIdentifiersToTrack:a,sessionExpiryTime:r,numberOfSessions:o,currentSource:s}=Je;const l={};return e[t]&&(l.sessionKey=e[t]),e[n]&&(l.sessionStartTime=e[n]),void 0!==e[i]&&(l.sessionMaxTime=e[i]),e[a]&&(l.customIdentifiersToTrack=e[a]),void 0!==e[r]&&(l.sessionExpiryTime=e[r]),void 0!==e[o]&&(l.numberOfSessions=e[o]),e[s]&&(l.currentSource=function(e){if(!e)return e;const{source:t,medium:n,source_url:i,term:a,campaign_name:r,campaign_id:o,content:s,extra:l}=Xe,d={};return e[t]&&(d.source=e[t]),e[n]&&(d.medium=e[n]),e[i]&&(d.source_url=e[i]),e[a]&&(d.term=e[a]),e[r]&&(d.campaign_name=e[r]),e[o]&&(d.campaign_id=e[o]),e[s]&&(d.content=e[s]),e[l]&&(d.extra=e[l]),d}(e[s])),l}(e);case s.DEVICE_DATA:return function(e){if(!e)return e;var t=Qe.deviceUniqueId;const n={};return e[t]&&(n.deviceUniqueId=e[t]),n}(e);default:return e}}static isCompressedCookie(e){return e.startsWith("moe_")&&Object.values(c.COOKIE_NAME_MAPPING).includes(e)}static isLegacyValue(e){return"object"==typeof e&&null!==e&&e.hasOwnProperty("MOE_DATA_TYPE")&&e.hasOwnProperty("actualValue")}}Ze.REVERSE_COOKIE_NAME_MAPPING=Object.fromEntries(Object.entries(c.COOKIE_NAME_MAPPING).map((([e,t])=>[t,e])));class et{static set(e,t){var n,i;null!==(i=He.get())&&void 0!==i&&i.disableCookies||(n=et.baseTag+".set",null==t?et.remove(e):(i=Ze.compressValue(t,e),(t=Ze.getCompressedKeyName(e))!==e&&et.remove(e),e!==s.PUSH_TOKEN?(e=JSON.stringify(i),i=Date.now(),i=";expires="+new Date(i+31536e6*l).toUTCString(),document.cookie=t+"="+encodeURIComponent(e)+i+";domain="+et.getOrigin()+";path=/;SameSite=None; Secure"):We.log(2,n,"Skipping PUSH_TOKEN as it is redundant with SUBSCRIPTION_DETAILS")))}static get(e){if(null===(t=He.get())||void 0===t||!t.disableCookies){et.baseTag;var t=Ze.getCompressedKeyName(e);let n=et.getCookieValue(t),i=!0;return null===n&&t!==e&&(n=et.getCookieValue(e),i=!1),null===n?null:(n=et.processParseValue(n,e,i),n)}}static getCookieValue(e){var t=e+"=",n=et.getDecodedCookies();for(let e=n.length-1;0<=e;e--){let i=n[e];for(;" "===i.charAt(0);)i=i.substring(1);if(0===i.indexOf(t))return i.substring(t.length,i.length)}return null}static processParseValue(e,t,n){var i="MOE_DATA_TYPE",a="actualValue";try{var r=JSON.parse(e);Ze.isLegacyValue(r)?"string"===Le(r,i,null)?e=(e=Le(r,a,null))?String(e):null:"boolean"===Le(r,i,null)&&(e=Le(r,a,null)):e=n?Ze.decompressValue(r,t):r}catch(e){}return e}static remove(e){var t;null!==(t=He.get())&&void 0!==t&&t.disableCookies||(t=Ze.getCompressedKeyName(e),document.cookie=t+"=;domain="+et.getOrigin()+";path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT;",t!==e&&(document.cookie=e+"=;domain="+et.getOrigin()+";path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT;"))}static setRaw(e,t,n){var i;if(null===(i=He.get())||void 0===i||!i.disableCookies)if(et.baseTag,null==t)et.remove(e);else{let i="";null!=n&&(i=";expires="+n.toISOString()),document.cookie=e+"="+encodeURIComponent(t)+i+";domain="+et.getOrigin()+";path=/;"}}static getOrigin(){if(null===(e=He.get())||void 0===e||!e.disableCookies){var e=et.baseTag+".getOrigin";let t=window.location.origin;return t=t.indexOf(".")!==t.lastIndexOf(".")?t.substring(t.indexOf(".")):"."+t.substring(t.lastIndexOf("/")+1),"localhost"===window.location.hostname&&(We.warn(1,e,"Cross domain user persitence will not work with localhost. \n\nWe will save the key-value pairs in the localhost cookie store for reference. You'll be able to test this functionality in a hosted staging/test environment."),t=""),t}}static getDecodedCookies(){const e=et.baseTag+".getDecodedCookies";return document.cookie.split(";").map((t=>{let n=t.trim();"%"===n.slice(-1)&&(n+="25");try{return decodeURIComponent(n)}catch(t){return We.error(2,e,"Error decoding cookie:",n,t),n}}))}}et.baseTag="CookieStorage";const tt="MOE_DATA";class nt{static setPrefix(e){nt.prefix=e+"_"}static set(e,t){if(nt.baseLogTag,e=nt.prefix+e,localStorage){const n=nt.getMoeData();n[e]=t,localStorage.setItem(tt,JSON.stringify(n))}var n=nt.KEYS_SHARED_WITH_COOKIE.indexOf(e);if(nt.isSharedWithCookie&&0<=n){const i="object"!=typeof t||Array.isArray(t)?t:Object.assign({},t);0===n&&Array.isArray(i.attributes)&&(i.attributes=i.attributes.filter((e=>!!this.isPushBillingOrIdentityAttribute(e.key)))),e===s.SUBSCRIPTION_DETAILS&&(i.domain=t.domain,i.token=t.token,i.endpoint=t.endpoint,i.keys=t.keys),et.set(e,i)}}static get(e){return nt.baseLogTag,e=nt.prefix+e,localStorage?Le(nt.getMoeData(),e,null):null}static remove(e){var t=nt.baseLogTag+".remove",n=nt.prefix+e;if(localStorage&&null!=nt.get(e)){const i=nt.getMoeData();delete i[n],localStorage.setItem(tt,JSON.stringify(i)),We.log(2,t,"Key",e,"removed.")}nt.isSharedWithCookie&&0<=nt.KEYS_SHARED_WITH_COOKIE.indexOf(e)&&et.remove(e)}static logout(){const e=["INIT_DATA","Q","WEB_SETTINGS","SUBSCRIPTION_DETAILS","PUSH_TOKEN","GRACEFUL_DATA","DEVICE_DATA","SDK_VERSION","SDK_DISABLED"];for(const t in s)e.indexOf(t)<0&&nt.remove(s[t]);for(const e in s.Q)it.purge(e)}static getString(e){if(e=nt.prefix+e,localStorage)return"string"==typeof(e=nt.get(e))||e instanceof String?e:JSON.stringify(e)}static removePrefix(){nt.prefix=""}static copyKeysFromCookie(){for(let n=0;n<nt.KEYS_SHARED_WITH_COOKIE.length;n++){var e=nt.KEYS_SHARED_WITH_COOKIE[n],t=et.get(e);if(null!=t){const n="object"!=typeof t||Array.isArray(t)?t:Object.assign({},t);if(e===s.USER_DATA&&(t=nt.get(e)&&nt.get(e).attributes,Array.isArray(n.attributes)&&Array.isArray(t)&&0<t.length)){let e=[...t];n.attributes.forEach((t=>{var n=e.findIndex((e=>e.key===t.key));0<=n?e[n]=t:e.push(t)})),e=e.filter((e=>!(this.isPushBillingOrIdentityAttribute(e.key)&&n.attributes.findIndex((t=>t.key===e.key))<0))),n.attributes=e}nt.set(e,n)}}et.get(s.PUSH_TOKEN)&&et.remove(s.PUSH_TOKEN),nt.removeStaleKeysFromLS(),nt.copyIdentitiesFromCookiesToIDB()}static isPushBillingOrIdentityAttribute(e){var t=nt.get(s.WEB_SETTINGS);const n=(null===(i=null==t?void 0:t.configs)||void 0===i?void 0:i.identityAttributes)||[];var i=(null===(i=null==t?void 0:t.configs)||void 0===i?void 0:i.subscriberBasedBillingAttributes)||[];return!!(null!=t&&t.isPushSubBilling&&Ve(e,i)||U.includes(e)||n.includes((null===(i=we.find((t=>t.attributeName===e)))||void 0===i?void 0:i.moeName)||e))}static copyIdentitiesFromCookiesToIDB(){var t,n,i=this.baseLogTag+".copyIdentitiesFromCookiesToIDB",a=et.get(s.IDENTITY_MAP);const r=et.get(s.USER_DATA),o={};null!=a&&a.userIdentities&&(({userIdentities:t,previousIdentities:a,previousIdentitiesUpdatedTime:n}=a),o.userIdentities=t,o.previousIdentities=a,o.previousIdentitiesUpdatedTime=n),null!==(n=null==r?void 0:r.attributes)&&void 0!==n&&n.length&&r.attributes.find((e=>e.key===P))&&(o.moe_user_id=r.attributes.find((e=>e.key===P)).value),null!==(n=this.moeDataStore)&&void 0!==n&&n.getItem||(this.moeDataStore=e.createInstance({driver:[e.INDEXEDDB],name:"moe_database",storeName:"moe_data"}),this.moeDataStore&&(this.moeDataStore.setItem(Oe,o),We.log(2,i,"Copied identities from cookie to IndexedDB")))}static removeStaleKeysFromLS(){var e=nt.baseLogTag+".removeStaleKeysFromLS";try{Object.keys(nt.getMoeData()).forEach((e=>{var t=et.get(e);!this.KEYS_SHARED_WITH_COOKIE.includes(e)||Ne.includes(e)||t||!1===t||nt.remove(e)}))}catch(t){We.error(1,e,t)}}static getMoeData(){var e=nt.baseLogTag+".getMoeData",t=localStorage.getItem(tt);if(null==t)return{};try{return JSON.parse(t)}catch(t){return We.error(1,e,t),{}}}}nt.baseLogTag="PersistentStorage",nt.prefix="",nt.isSharedWithCookie=!1,nt.KEYS_SHARED_WITH_COOKIE=[s.USER_DATA,s.SUBSCRIPTION_DETAILS,s.SOFT_ASK_STATUS,s.OPT_IN_SHOWN_TIME,s.HARD_ASK_STATUS,s.SESSION,s.DEVICE_DATA,s.IDENTITY_MAP,s.SDK_DISABLED];class it{constructor(){this.items=[]}static enqueue(e,t){e=it.getLocalStorageQName(e);let n=new it;nt.get(e)&&(n=nt.get(e)),n.items.push(t),n.items=n.items.slice(Math.max(n.items.length-50,0)),nt.set(e,n)}static dequeue(e){e=it.getLocalStorageQName(e);const t=nt.get(e);let n=null;return t&&0<t.items.length&&(n=t.items[0],t.items.splice(0,1),nt.set(e,t)),n}static isEmpty(e){return e=it.getLocalStorageQName(e),!(nt.get(e)&&0<nt.get(e).items.length)}static purge(e){var t=this.baseLogTag+".purge",n=it.getLocalStorageQName(e);it.isEmpty(e)||nt.remove(n),We.log(2,t,`Queue "${e}" has been cleared.`)}static getLocalStorageQName(e){return s.Q.PREFIX+"_"+e}}it.baseLogTag="LocalQ";var at,rt=n(877);const ot=e=>{if(e){var t=e.indexOf("?");if(t<0)return{};const n=(e=e.slice(t+1)).replace("?","").split("&"),i={};return n.forEach((e=>{e=(t=e.split("="))[0];var t=decodeURIComponent(t[1]||"");i[e]?"[object Array]"===Object.prototype.toString.call(i[e])?i[e].push(t):i[e]=[i[e],t]:i[e]=t})),JSON.parse(JSON.stringify(i))}return{}},st=(e,t)=>{if(!t)return e;"?"!==e[e.length-1]&&(e+="?");for(const n in t)t.hasOwnProperty(n)&&null!=t[n]&&(e+=n+"="+encodeURIComponent(t[n])+"&");return"&"===e[e.length-1]?e.slice(0,-1):e};class lt{static get(e,t){return lt.makeNetworkCall(at.METHODS.GET,e,t)}static post(e,t){return lt.makeNetworkCall(at.METHODS.POST,e,t)}static makeNetworkCall(e,t,n={}){return new Promise(((i,a)=>{var r=JSON.stringify(Le(n,"postData",null));t=st(t,Le(n,"queryParams",null));const o=new XMLHttpRequest;o.open(e,t,!0),lt.addRequestHeaders(o,Le(n,"headers",{})),o.onreadystatechange=()=>{4===o.readyState&&200===o.status||4===o.readyState&&410===o.status?i({status:o.status,responseText:o.responseText}):4===o.readyState&&200!==o.status&&a({code:o.status,reason:o.responseText})},o.send(r)}))}static addRequestHeaders(e,t){for(const n in t)t.hasOwnProperty(n)&&e.setRequestHeader(n,t[n]);return e}}function dt(){const e=navigator.userAgent;return!(!/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)&&!/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))}function ct(){var e=navigator.userAgent.toLowerCase(),t=/(ipad|tablet|(android(?!.*mobile))|(windows(?!.*phone)(.*touch))|kindle|playbook|silk|(puffin(?!.*(IP|AP|WP))))/.test(e);return/nexus player|neo-x5|adt-2|tsbnettv|roku|tizen|smart-tv.+(samsung)|hbbtv.+maple;(\d+)|(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))|(apple) ?tv|crkey|droid.+aft(\w)( bui|\))|\(dtv[\);].+(aquos)|(aquos-tv[\w ]+)\)|(bravia[\w ]+)( bui|\))|(mitv-\w{5}) bui|Hbbtv.*(technisat) (.*);|\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)|hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)|\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i.test(e)?Ie.TV:t?Ie.TABLET:dt()?Ie.MOBILE:Ie.WEB}function ut(e,t){const n=t&&new RegExp("^("+t.join("|")+")$");return ct()===Ie.TV&&(null!=n&&n.test(e)||!t)?{moe_os_type:function(){var e=navigator.userAgent.toLowerCase();return/tizen/i.test(e)?"Tizen":/web0s/i.test(e)?"WebOS":/xbox/i.test(e)?"Xbox":/vizio/i.test(e)?"viziotv":"SmartTV"}(),os:Ie.TV.toUpperCase()}:{}}(kn=(kn=at=at||{}).METHODS||(kn.METHODS={})).GET="GET",kn.POST="POST";class gt{constructor(){this.p=null,this.res=null,this.rej=null;try{this.p=new Promise(((e,t)=>{this.res=e,this.rej=t}))}catch(e){We.error(1,"Utils.PromiseObject","Promises not supported")}}}var mt=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class pt{static getIdentityMap(){var e=nt.get(s.WEB_SETTINGS);return null!=e&&e.isDomainLevelStorage?this.getIdentitiesFromCookies():this.getIdentitiesFromLocalStorage()}static getIdentitiesFromLocalStorage(){var e=nt.get(s.IDENTITY_MAP);return null!=e&&e.userIdentities?e:null}static getIdentitiesFromCookies(){var e=et.get(s.IDENTITY_MAP);if(e&&"object"==typeof e&&e.userIdentities){const t={userIdentities:e.userIdentities};return e.previousIdentities&&(t.previousIdentities=e.previousIdentities,t.previousIdentitiesUpdatedTime=e.previousIdentitiesUpdatedTime),t}return null}static getUserIdentities(){var e=this.getIdentityMap();return null!=e&&e.userIdentities?e.userIdentities:null}static updateCurrentUserIdentities(e){return mt(this,void 0,void 0,(function*(){let t;var n=this.getIdentityMap();t=null!=n&&n.userIdentities?Object.assign(Object.assign({},n),{userIdentities:Object.assign(Object.assign({},n.userIdentities),e)}):(this.createIdentityMap(),Object.assign(Object.assign({},this.getIdentityMap()),{userIdentities:e})),nt.set(s.IDENTITY_MAP,t),yield this.updateIdentifiersIDB(t)}))}static broadcastUserIdentityUpdate(){var e=this.baseLogTag+".broadcastUserIdentityUpdate";We.log(1,e,"User Identities Updated."),Ht.broadcastToWindow({topic:G,name:K.USER_IDENTITY_UPDATE})}static broadcastLogout(){Ht.broadcastToWindow({topic:G,name:K.LOGOUT})}static updatePreviousUserIdentities(e,t){return mt(this,void 0,void 0,(function*(){let n;var i,a=this.getIdentityMap();n=null!=a&&a.userIdentities?(i=(null==a?void 0:a.previousIdentities)||{},Object.assign(Object.assign({},a),{previousIdentities:Object.assign(Object.assign({},i),e),previousIdentitiesUpdatedTime:t||(new Date).getTime()})):(this.createIdentityMap(),Object.assign(Object.assign({},this.getIdentityMap()),{previousIdentities:e,previousIdentitiesUpdatedTime:t||(new Date).getTime()})),nt.set(s.IDENTITY_MAP,n),yield this.updateIdentifiersIDB(n)}))}static updateIdentifiersIDB(t){var n;return mt(this,void 0,void 0,(function*(){var i;null!==(n=this.moeDataStore)&&void 0!==n&&n.getItem||(this.moeDataStore=e.createInstance({driver:[e.INDEXEDDB],name:re,storeName:oe})),this.moeDataStore&&(Object.keys(t).length?(i=(yield this.moeDataStore.getItem(Oe))||{},yield this.moeDataStore.setItem(Oe,Object.assign(Object.assign({},i),t))):yield this.moeDataStore.setItem(Oe,t))}))}static copyUidIntoIdentityMap(e){var t=this.baseLogTag+".copyUidIntoIdentityMap";(e=e.getAttribute("id"))&&(this.updateCurrentUserIdentities({uid:e}),We.log(1,t,"UID copied into IdentityMap."))}static getIdentifiersFromIdentities(){var{userIdentities:e,previousIdentities:t,previousIdentitiesUpdatedTime:n}=this.getIdentityMap()||{};const i={};return e&&Object.keys(e).length&&(i.userIdentities=e),0<n&&(216e5<(new Date).getTime()-n?this.removePreviousUserIdentities():i.previousIdentities=t),i}static removePreviousUserIdentities(){return mt(this,void 0,void 0,(function*(){var e=this.baseLogTag+".removePreviousUserIdentities",t=Object.assign(Object.assign({},this.getIdentityMap()),{previousIdentities:{},previousIdentitiesUpdatedTime:0});nt.set(s.IDENTITY_MAP,t),yield this.updateIdentifiersIDB(t),We.log(1,e,"previousIdentities removed from IdentityMap.")}))}static createIdentityMap(){nt.set(s.IDENTITY_MAP,{userIdentities:{},previousIdentities:{},previousIdentitiesUpdatedTime:0})}}function ht(e,t){if(null==e||null==t)return e===t;if(e instanceof Function)return e===t;if(e instanceof RegExp)return e===t;if(e===t||e.valueOf()===t.valueOf())return!0;if(Array.isArray(e)&&e.length!==t.length)return!1;if(e instanceof Date)return!1;if(!(e instanceof Object))return!1;if(!(t instanceof Object))return!1;const n=Object.keys(e);return Object.keys(t).every((e=>-1!==n.indexOf(e)))&&n.every((n=>ht(e[n],t[n])))}pt.baseLogTag="IdentityMethods";class vt{constructor(e,t,n){this.os="web",this.osPlatform=e.userAgent,this.isMobile=dt(),this.os=dt()?"mweb":"web",this.name=vt.getBrowserName(e.userAgent,t),this.isIncognito=n}static getInstance(){return function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){if(null!=ke.get(a))return ke.get(a);var e=yield vt.isIncognito(window),t=new vt(navigator,document,e);return ke.set(a,t),(e=nt.get(s.BROWSER_DETAILS))&&vt.isBrowserUpdated(e,t)||nt.set(a,t),t}))}static isIncognito(e){const t=e.RequestFileSystem||e.webkitRequestFileSystem;return new Promise((n=>{t?t(e.TEMPORARY,100,(()=>{n(!1)}),(()=>{n(!0)})):n(!1)}))}static getBrowserName(e,t){return-1!==e.indexOf("MSIE")||1==t.documentMode?vt.BROWSER_NAMES.INTERNET_EXPLORER:-1<e.indexOf("Edg")?vt.BROWSER_NAMES.EDGE:-1<e.indexOf("OPR")||-1<e.indexOf("Opera")?vt.BROWSER_NAMES.OPERA:-1<e.indexOf("Chrome")||e.match(/\b(?:crmo|crios)\/([\w\.]+)/i)?-1<e.indexOf("MMS")?vt.BROWSER_NAMES.OPERA_NEON:vt.BROWSER_NAMES.CHROME:-1<e.indexOf("Safari")?vt.BROWSER_NAMES.SAFARI:-1<e.indexOf("Firefox")?vt.BROWSER_NAMES.FIREFOX:vt.BROWSER_NAMES.OTHERS}static isBrowserUpdated(e,t){return ht(e,t)}isWebPushCompatible(){return this.isChrome()||this.isFirefox()||this.isOpera()||this.isSafari()||this.isEdge()}isChrome(){return this.name===vt.BROWSER_NAMES.CHROME}isFirefox(){return this.name===vt.BROWSER_NAMES.FIREFOX}isOpera(){return this.name===vt.BROWSER_NAMES.OPERA||this.name===vt.BROWSER_NAMES.OPERA_NEON}isSafari(){return this.name===vt.BROWSER_NAMES.SAFARI}isEdge(){return this.name===vt.BROWSER_NAMES.EDGE}static isIOS(){return!(!navigator.userAgent.match(/iPad/i)&&!navigator.userAgent.match(/iPhone/i))}}(nn=(nn=vt=vt||{}).BROWSER_NAMES||(nn.BROWSER_NAMES={})).CHROME="Google Chrome",nn.FIREFOX="Mozilla Firefox",nn.OPERA="Opera",nn.OPERA_NEON="Opera Neon",nn.SAFARI="Apple Safari",nn.INTERNET_EXPLORER="Internet Explorer",nn.EDGE="Edge",nn.OTHERS="Others";const ft=vt,St=()=>new Promise(((e,t)=>{try{var n=JSON.parse(localStorage.getItem("MOE_DATA"));n&&n.WEB_SETTINGS&&n.WEB_SETTINGS.configs&&e(n.WEB_SETTINGS),t("Error in getting sdk settings from localstorage - no data found")}catch(e){We.error(1,"getSDKSettings","Error in getting sdk settings from localstorage ",e),t(e)}})),Et=()=>new Promise(((e,t)=>{try{var n=JSON.parse(localStorage.getItem("MOE_DATA"));return n&&n.INIT_DATA&&e(n.INIT_DATA),{}}catch(e){We.error(1,"getSDKSettings","Error in getting init data from localstorage ",e),t(e)}}));class yt{constructor(e,t){this.key=e,this.value=t,this.updated_at=(new Date).getTime()}static equal(e,t){return e.key===t.key&&JSON.stringify(e.value)===JSON.stringify(t.value)}}function bt(){var e;return(null===(e=nt.get(s.SUBSCRIPTION_DETAILS))||void 0===e?void 0:e.token)||null}function _t(e,t){var{web:n,mobile:e}=e,n=kt(`\n  <div id="desktopBannerWrapped" aria-labelledby="optInTitle" data-rapid_height="50"\n  style="width: 422px; top: 1px; left: calc(50% - 211px); margin: 0px; padding: 0px; box-shadow: rgb(136, 136, 136) 0px 0px 4px; font-size: 11px; font-weight: 400; position: fixed; z-index: 2147483647; background: ${n.banner.backgroundColor};">\n    <div style="margin: 0;padding: 0 20px 10px;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n      <div\n        style="float: left;position: relative;display: inline-block;margin: 15px 15px 0 0!important;padding: 0!important;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n        <img style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;height: 65px!important;width: 65px!important;" src="${n.banner.icon}" alt="${n.banner.altText||""}"/>\n      </div>\n      <div style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;position: relative!important;padding: 10px 0 0!important;color: #000!important;text-align: left!important;margin: 0!important;line-height: 1.4em!important;display: inline-block!important;width: calc(100% - 80px)!important;">\n        <h2 id="optInTitle" style="margin-bottom: 5px; text-align: left; font-size: 14px; font-weight: 700; overflow: hidden; height: 2.8em; line-height: 1.4em; display: block; font-family: Open Sans, sans-serif !important; word-spacing: normal !important; letter-spacing: normal !important; color: ${n.banner.title.textColor+" !important"};">\n          ${n.banner.title.text}\n        </h2>\n        <p aria-describedby="optInTitle" style="overflow: hidden; height: 2.8em; word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; font-size: 12px !important; line-height: 1.4em !important; margin: 10px 0px !important; padding: 0px !important; text-align: left !important; color: ${n.banner.body.textColor+" !important"};">\n          ${n.banner.body.text}\n        </p>\n      </div>\n      <div\n        style="display: flex;justify-content: space-between;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">${t?"":`<div style="margin-top: 0.5em;">\n          <a aria-label="${n.logo.altText||""}" href="https://moengage.com/?utm_source=Journey&amp;utm_medium=soft_ask" target="_blank" style="word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; text-decoration: none !important; font-size: 10px !important; line-height: 1.2em !important; font-weight: 400 !important; color: ${n.logo.logoColor+" !important"};">\n            Powered by <span style="text-decoration: none;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;vertical-align: bottom;"><img alt="" id="moeBannerLogoweb" src="https://app-cdn.moengage.com/images/brand/logo-blue.png" style="width: 6.5em;"></span>\n          </a>\n        </div>`}\n        <div style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;margin: 0!important;padding: 0!important;margin-left: auto !important;">\n          <button id="moe-dontallow_button" style="overflow: hidden; word-spacing: normal !important; letter-spacing: normal !important; width: 100px !important; height: 26px !important; font-size: 14px !important; cursor: pointer !important; line-height: 1.1em !important; border-radius: 4px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; display: inline-block !important; font-weight: 400 !important; margin: 0px 20px 0px 0px !important; padding: 5px !important; text-transform: none !important; box-sizing: border-box !important; text-shadow: none !important; box-shadow: none !important; white-space: nowrap !important; color: ${n.dismissButton.textColor}; background: ${n.dismissButton.backgroundColor};">\n            ${n.dismissButton.text}\n          </button>\n          <button\n            style="overflow: hidden; word-spacing: normal !important; letter-spacing: normal !important; width: 90px !important; height: 26px !important; font-size: 14px !important; cursor: pointer !important; line-height: 1.1em !important; border-radius: 4px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; display: inline-block !important; font-weight: 400 !important; margin: 0px !important; padding: 5px !important; text-transform: none !important; box-sizing: border-box !important; text-shadow: none !important; box-shadow: none !important; white-space: nowrap !important; color: ${n.allowButton.textColor}; background: ${n.allowButton.backgroundColor};" id="optInText">\n            ${n.allowButton.text}\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n  `);return{mobileUI:kt(`\n  <div id="mobileBannerWrapped" aria-labelledby="optInTitle" class="moe-mobile-box" style="position: fixed; top: 0px; left: 0px; width: 100%; box-shadow: rgb(51, 51, 51) 0px 5px 10px -5px; z-index: 2147483647; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif; background: ${e.nudge.backgroundColor};">\n    <div class="moe-logo-text" style="box-sizing: border-box;padding: 10px !important;float: left !important;width: 100% !important">\n      <img height="40px" width="40px" style="box-sizing: border-box;width: 40px !important;height: 40px !important;float: left !important" alt="${e.nudge.altText||""}" src="${e.nudge.icon}">\n      <h2 aria-labelledby="optInTitle" style="box-sizing: border-box; width: calc(100% - 40px); overflow: hidden; height: 2.4em; float: left !important; word-break: break-word !important; font-weight: 400 !important; line-height: 1.2em !important; font-size: 17px !important; text-align: left !important; padding: 0px 0px 0px 10px !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; color:${e.nudge.title.textColor+" !important"}">\n        ${e.nudge.title.text}\n      </h2>\n    </div>\n    <div class="moe-buttons-panel" style="box-sizing: border-box;text-align: right;padding: 0 10px !important;float: left;width: 100% !important;margin-top: 5px;margin-bottom: 3px">\n      <div style="width: 100%;box-sizing: border-box">\n        <button id="moe-dontallow_button" class="moe-mobile-button-outline" style="box-sizing: border-box; font-size: 14px !important; display: inline-block !important; text-transform: none !important; height: 34px !important; font-weight: 400 !important; line-height: 1.2em !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; padding: 0px 5px !important; width: 120px !important; border-radius: 2px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; margin: 0px 5px 0px 0px !important; color: ${e.dismissButton.textColor}; background: ${e.dismissButton.backgroundColor};">\n          <div style="height: 1.2em; line-height: 1.2em; overflow: hidden; color: ${e.dismissButton.textColor}; background: ${e.dismissButton.backgroundColor};">\n            ${e.dismissButton.text}\n          </div>\n        </button>\n        <button class="moe-mobile-button-fill" style="box-sizing: border-box; font-size: 14px !important; display: inline-block !important; text-transform: none !important; height: 34px !important; font-weight: 400 !important; line-height: 1.2em !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; padding: 0px 5px !important; width: 120px !important; border-radius: 2px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; margin: 0px !important; color: ${e.allowButton.textColor}; background: ${e.allowButton.backgroundColor};" id="optInText">\n          <div style="height: 1.2em; line-height: 1.2em; overflow: hidden; color: ${e.allowButton.textColor}; background: ${e.allowButton.backgroundColor};">\n            ${e.allowButton.text}\n          </div>\n        </button>\n      </div>\n    </div>${t?"":`<div style="float: left;margin-top: -2.25em;">\n    <a aria-label="${e.logo.altText||""}" href="https://moengage.com/?utm_source=Journey&amp;utm_medium=soft_ask" target="_blank" style="word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; text-decoration: none !important; font-size: 10px !important; line-height: 1.2em !important; font-weight: 400 !important; color: ${e.logo.logoColor+" !important"};">\n    Powered by <span style="text-decoration: none;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n        <img alt="" id="moeBannerLogomobile" src="https://app-cdn.moengage.com/images/brand/logo-blue.png" style="width: 6.5em;">\n      </span>\n    </a>\n    </div>`}\n  </div>\n  `),webUI:n}}function Tt(e,t){return function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){let n="",i="";const a=yield ft.getInstance();return n=a.isFirefox()?(i=It(function(e){return kt(`\n  <div class="moe_firefox" style="display:none;">\n    <div style='position:relative;top: 200px;left: 400px;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${e=(null===(e=null==e?void 0:e.desktop)||void 0===e?void 0:e.text)||""}\n    </div>\n    <div\n    style="position:relative;top: 45px;left: 300px;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.firefox),t),At(function(e){return kt(`\n  <div class='moe_firefox' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${e=(null===(e=null==e?void 0:e.mobile)||void 0===e?void 0:e.text)||""}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.firefox),t)):a.isOpera()?(i=It(function(e){return kt(`\n  <div class="moe_opera" style="display:none;">\n    <div style='position:relative;top: 240px;left: 40%;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${e=(null===(e=null==e?void 0:e.desktop)||void 0===e?void 0:e.text)||""}\n    </div>\n    <div\n      style="position:relative;top: 45px;left: 55%;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg) scaleX(-1);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.opera),t),At(function(e){return kt(`\n  <div class='moe_opera' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${e=(null===(e=null==e?void 0:e.mobile)||void 0===e?void 0:e.text)||""}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.opera),t)):(i=It(kt(`\n  <div class="moe_chrome" style="display:none;">\n    <div style='position:relative;top: 200px;left: 400px;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${e.chrome.desktop.text}\n    </div>\n    <div\n      style="position:relative;top: 30px;left: 300px;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `),t),At(function(e){return kt(`\n  <div class='moe_chrome' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${e=(null===(e=null==e?void 0:e.mobile)||void 0===e?void 0:e.text)||""}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.chrome),t)),{mobileUI:n,webUI:i}}))}function It(e,t){return`\n  <div id='chrome_desktop_backend' style='z-index: 999999999;position: fixed;height: 100%;top: 0px;left: 0px;width: 100%;background: rgba(0, 0, 0, 0.89);'>\n    ${e}\n    ${t?"":kt('\n    <a href="#" target="_blank"\n    style="text-decoration: none !important;cursor: pointer !important;color:#A5A0A0 !important;font-size: 11px !important;bottom: 0px;left: 10px;position: absolute;"\n    onclick="window.open(\'https://moengage.com/web-push/?utm_source=moengage_branding&utm_medium=webpush\',\'_blank\');event.cancelBubble = true; if (event.stopPropagation) event.stopPropagation();return false;">\n    Powered by <img src="https://app-cdn.moengage.com/images/brand/logo_full_white.png"\n      style="max-width: 100% !important; height: 20px !important;vertical-align: middle !important; padding-right: 3px !important;"></a>\n      ')}\n  </div>\n  `}function At(e,t){return`\n  <div id='chrome_mobile_backend' style='z-index: 999999999;position: fixed;height: 100%;top: 0px;left: 0px;width: 100%;background: rgba(0, 0, 0, 0.798039);'>\n    ${e}\n    ${t?"":kt('\n    <a href="#" target="_blank"\n      style="text-decoration: none !important;cursor: pointer !important;color:#A5A0A0 !important;font-size: 11px !important;left: 0px;bottom: 23%;position: absolute;"\n      onclick="window.open(\'https://moengage.com/web-push/?utm_source=moengage_branding&utm_medium=webpush\',\'_blank\');event.cancelBubble = true; if (event.stopPropagation) event.stopPropagation();return false;">\n      Powered by <img src="https://app-cdn.moengage.com/images/brand/logo_full_white.png"\n        style="max-width: 100% !important; height: 20px !important;vertical-align: middle !important; padding-right: 3px !important;"></a>\n      ')}\n  </div>\n  `}var wt=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};let Dt=null;class Ot{constructor(e){this.attributes=[],this.subscribedToOldSdk=!1,null==e?(this.deviceUuid=(0,rt.v4)(),this.attributes=[],this.deviceAdded=!1):(this.deviceUuid=Le(e,"deviceUuid",(0,rt.v4)()),this.attributes=Le(e,"attributes",[]),this.deviceAdded=Le(e,"deviceAdded",!1))}addAttribute(e){const t=Ot.baseLogTag+".addAttribute";return new Promise((n=>wt(this,void 0,void 0,(function*(){let i=!0;e.key=Ot.getMorphedKey(e.key);let a=-1;for(let t=this.attributes.length-1;0<=t;t--)e.key===this.attributes[t].key&&(a=t);0<=a?(ht(this.attributes[a].value,e.value)&&(We.log(2,t,"Duplicate attribute found: ",e),i=yield this.isAttibuteTrackingRequired(this.attributes[a].updated_at)),i&&(this.attributes[a].value=e.value,this.attributes[a].updated_at=(new Date).getTime())):(We.log(2,t,"Adding attribute:",e),this.attributes.push(e)),this.save().then((()=>{n(i)}))}))))}isAttibuteTrackingRequired(e){return wt(this,void 0,void 0,(function*(){var t=yield St();if(null===t.configs.userAttributeCacheTime)return!0;var n=(new Date).getTime()-e;return Math.round(n/1e3)>t.configs.userAttributeCacheTime}))}static getLocalUser(){const e=Ot.baseLogTag+".getLocalUser";return new Promise((t=>{var n;nt.get(s.USER_DATA)?(We.log(2,e,"Found user in localstorage"),n=nt.get(s.USER_DATA),t(new Ot(n))):t(null)}))}static getCookieUser(){return new Promise((e=>{var t=Ot.baseLogTag+".getLocalUser";et.get(s.USER_DATA)?(We.log(2,t,"Found user in cookie"),t=et.get(s.USER_DATA),e(new Ot(t))):e(null)}))}static getMigrationUser(){const e=Ot.baseLogTag+".getLocalUser";return new Promise((t=>{var n=localStorage.getItem(s.OLD_SDK.USER_DATA);if(n)try{var i=JSON.parse(n);if(i.is_new_sdk_migrated)t(null);else{const e=new Ot({deviceAdded:Le(i,"device_add",!1),deviceUuid:Le(i,"uuid",(0,rt.v4)())}),n=Le(i,"user_attrs",{});for(const t in n)n.hasOwnProperty(t)&&e.attributes.push(new yt(t,n[t]));var a=localStorage.getItem(s.OLD_SDK.PUSH_TOKEN);null!=a&&"NA"!==a&&"null"!==a&&(e.subscribedToOldSdk=!0),t(e)}}catch(n){We.error(1,e,"Error getting the migration user. Resolving as a new user."),We.error(1,e,n),t(null)}else t(null)}))}static getSync(){return Ot.instance}static get(){const e=Ot.baseLogTag+".get";return null!=Dt||(Dt=new Promise((t=>{ft.getInstance().then((n=>{St().then((n=>{var i=Ot.getLocalUser(),a=n.isDomainLevelStorage?Ot.getCookieUser():"resolved",r=Ot.getMigrationUser();Promise.all([i,a,r]).then((i=>{const a=i[0],r=i[1],o=i[2];i=()=>{if(r&&"resolved"!==r)We.log(1,e,"User resolved from cookie: ",r),r.save().then((e=>{t(e)}));else{We.log(1,e,"Local user: ",a);const i=new Ot(a);n.isPushSubBilling&&(bt()||function(e,t){const n=[N,k,...t];return 0<e.filter((e=>n.includes(e.key))).length||!!Mt()}(i.attributes,null==n?void 0:n.configs.subscriberBasedBillingAttributes)?(i.deviceAdded=!0,vn.trackDeviceAttributes()):i.deviceAdded=!1),i.save().then((e=>{t(e)}))}},o?o.save().then((n=>{var i=localStorage.getItem(s.OLD_SDK.USER_DATA);if(i){const e=JSON.parse(i);e.is_new_sdk_migrated=!0,localStorage.setItem(s.OLD_SDK.USER_DATA,JSON.stringify(e))}We.log(1,e,"User resolved from older SDK: ",n),t(n)})):i()})).catch((t=>{We.log(1,e,"Error in fetching/creating user",t)}))})).catch((t=>{We.error(1,e,"Error in getting Web SDK Settings. This might indicate that the App is blocked.",t)}))}))}))),Dt}static logout(){return new Promise((e=>{Dt=null,this.instance=null,window.MoeWebP&&(window.MoeWebP.deviceUuid=null),e(!0)}))}save(){var e;Ot.baseLogTag,Ot.isAmpEnabled()&&(this.deviceUuid=et.get("moe_uuid")),nt.get("WEB_SETTINGS");var t=nt.get(s.WEB_SETTINGS);return null!=t&&t.configs.isWebPersonalizationModuleEnabled&&null!==(e=window.MoeWebP)&&void 0!==e&&e.deviceUuid&&this.deviceUuid!==window.MoeWebP.deviceUuid&&(this.deviceUuid=window.MoeWebP.deviceUuid),Ot.instance=this,new Promise((e=>{nt.set(s.USER_DATA,this),et.setRaw(se,Ot.instance.deviceUuid),e(this)}))}static isAmpEnabled(){const e=et.get(se);return e&&e.includes("amp")}getAttribute(e){let t=null;return e=Ot.getMorphedKey(e),this.attributes.map((n=>{n.key===e&&(t=n.value)})),t}indexOfAttribute(e){let t=-1;return e=Ot.getMorphedKey(e),this.attributes.map(((n,i)=>{n.key===e&&(t=i)})),t}static getMorphedKey(e){switch(e){case"id":e=P;break;case"email":e=N;break;case"name":e=C;break;case"first_name":e=R;break;case"last_name":e=L;break;case"mobile":e=k;break;case"gender":e=M;break;case"birthday":e=x}return e}}Ot.baseLogTag="UserModel",Ot.isResolved=!1,Ot.instance=null;var Pt=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};function Nt(e){e=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/");const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;++e)n[e]=t.charCodeAt(e);return n}function Ct(e){let t="";var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=new Uint8Array(e),a=i.byteLength,r=a-(e=a%3);let o,s,l,d,c;for(let e=0;e<r;e+=3)c=i[e]<<16|i[e+1]<<8|i[e+2],o=(16515072&c)>>18,s=(258048&c)>>12,l=(4032&c)>>6,d=63&c,t+=n[o]+n[s]+n[l]+n[d];return 1==e?(c=i[r],o=(252&c)>>2,s=(3&c)<<4,t+=n[o]+n[s]+"=="):2==e&&(c=i[r]<<8|i[1+r],o=(64512&c)>>10,s=(1008&c)>>4,l=(15&c)<<2,t+=n[o]+n[s]+n[l]+"="),t}function Rt(e){return e.replace(/[\uff0e]/g,".")}function Lt(e){return new Date(Date.parse(e))}function kt(e){var t;let n=e;return e=He.get(),"string"==typeof n&&n.length&&null!==(t=null==e?void 0:e.proxyDomains)&&void 0!==t&&t.api&&(e.proxyDomains.cdnApp&&(n=n.replace(/app-cdn\.moengage\.com/gi,e.proxyDomains.cdnApp)),e.proxyDomains.cdnScript&&(n=n.replace(/cdn\.moengage\.com/gi,e.proxyDomains.cdnScript)),e.proxyDomains.cdnImage&&(n=n.replace(/image\.moengage\.com/gi,e.proxyDomains.cdnImage))),n}function Mt(){if(!ke.get(o)){const e=ot(window.location.href);return e.moe_aid&&!e.moe_aid.includes("{{")?e.moe_aid:void 0}}function xt(){var e=!!He.get().disableSdk;let t=!1;return t=(Bt()?et:nt).get(s.SDK_DISABLED),!(t||e&&!1!==t)}function Bt(){var e=nt.get(s.WEB_SETTINGS);return null!=e&&e.isDomainLevelStorage}function Ut(e){return null!=e&&"NA"!==e&&""!==e&&"null"!==e}class Wt{static getListeners(){return this.listeners}static getTopicListeners(e){return Le(Wt.topicListeners,e,[])}static addListener(e){Wt.listeners.push(e)}static addTopicListener(e,t){Wt.topicListeners[e]=Wt.getTopicListeners(e),Wt.topicListeners[e].push(t)}static broadcast(e){Wt.listeners.map((t=>{t(e)})),Le(Wt.topicListeners,e.topic,[]).map((t=>{t(e)}))}static broadcastToWindow(e,t=!1){window&&(t||xt())&&window.dispatchEvent(new CustomEvent(e.topic,{detail:{name:e.name,data:e.data||null}}))}static deprecatedSdkCallback(e){window.dispatchEvent(new CustomEvent("MOE_OPT_IN",{detail:e}))}static resetAllListeners(){Wt.listeners=[],Wt.topicListeners={}}static resetListeners(){Wt.listeners=[]}}Wt.listeners=[],Wt.topicListeners={};const Ht=Wt,Ft=e=>e===u||e===A;function Gt(){Ht.broadcastToWindow({topic:W,name:H.MOE_INIT_COMPLETED})}const Kt=e=>{let t;try{t=JSON.stringify(e)}catch(e){return!1}return new Blob([t]).size/1024>195};function Vt(e){return`Event "${e}" can't get tracked as its size is more than 195 KB. Max permissible event size is 195 KB.`}const jt=e=>"string"==typeof e,Yt=e=>"[object Date]"===Object.prototype.toString.call(e);class zt{initiateSessionAndSource(e){return new Promise(((t,n)=>{this.isSessionRunning()&&this.isCurrentSourceSameAsPreviousSource()||this.startNewSession(e),t(!0)}))}clearSessionAndSource(){nt.remove(te)}isSessionRunning(){return this.getSessionKey()&&!this.isSessionExpired()}isSessionExpired(){var e=this.getSessionExpiryTime(),t=ke.get("wasBrowserInactive");return!(!t&&null!==t)&&(this.isWindowActive()&&ke.set("wasBrowserInactive",!1),(new Date).getTime()>e)}isNonEventInteractive(e){return zt.NON_INTERACTIVE_EVENTS.includes(e.name)||0<e.attributes.filter((e=>"moe_non_interactive"===e.key&&1===e.value)).length}getCurrentSource(){const e=ot(window.location.href);let t="";const n={};if(Object.keys(e).includes("utm_source")){t="utm_",this.geCustomIdentifiersToTrack().forEach((t=>{e[t]&&(n[t]=e[t])}));const i={source_url:window.location.href};return e[t+"source"]&&(i.source=e[t+"source"]),e[t+"medium"]&&(i.medium=e[t+"medium"]),e[t+"term"]&&(i.term=e[t+"term"]),e[t+"campaign"]&&(i.campaign_name=e[t+"campaign"]),e[t+"content"]&&(i.content=e[t+"content"]),e.utm_id&&(i.campaign_id=e.utm_id),Object.keys(n).length&&(i.extra=n),i}}getActiveSource(){return this.getSavedSource()||this.getCurrentSource()}isSourceOrganic(){const e=ot(window.location.href),t=Object.keys(e);let n=!1;return this.geCustomIdentifiersToTrack().forEach((t=>{e[t]&&(n=!0)})),!t.includes("utm_source")&&!t.includes("source")&&!n}setCurrentSource(e){const t=this.getSession()||{};t.currentSource=e,nt.set(te,t)}removeCurrentSource(){const e=this.getSession();e&&(e.currentSource=void 0,nt.set(te,e))}getSavedSource(){var e=Le(this.getSession(),"currentSource",void 0);if(e)return e}isCurrentSourceSameAsPreviousSource(){if(this.isSourceOrganic())return!0;const e=Object.assign({},this.getCurrentSource());delete e.source_url;const t=Object.assign({},this.getSavedSource());return delete t.source_url,ht(e,t)}getSessionKey(){return Le(this.getSession(),"sessionKey",null)}getSessionStartTime(){return Le(this.getSession(),"sessionStartTime",null)}getSessionExpiryTime(){return Le(this.getSession(),"sessionExpiryTime",null)}getSessionMaxTime(){return Le(this.getSession(),"sessionMaxTime",null)}getSession(){return nt.get(te)}geCustomIdentifiersToTrack(){return Le(this.getSession(),"customIdentifiersToTrack",[])||[]}generateSessionKey(){return(0,rt.v4)()}startNewSession(e){this.removeCurrentSource();var t=this.getNumberOfSessions();t={sessionKey:this.generateSessionKey(),sessionStartTime:(new Date).toISOString(),sessionMaxTime:e.configs.sessionInactiveDuration,customIdentifiersToTrack:e.configs.sourceExtraParams,sessionExpiryTime:(new Date).getTime()+1e3*e.configs.sessionInactiveDuration,numberOfSessions:++t},nt.set(te,t)}extendSession(){const e=this.getSession();e&&(e.sessionExpiryTime=(new Date).getTime()+1e3*e.sessionMaxTime,nt.set(te,e))}handleBrowserInactivity(e){"hidden"===e&&ke.set("wasBrowserInactive",!0)}isWindowActive(){return!!ke.get("isWindowActive")}getNumberOfSessions(){return Le(nt.get(te),"numberOfSessions")||0}}function qt(e){const t=e?new Date(e):new Date;return`${t.getDate()}:${t.getMonth()+1}:${t.getFullYear()}:${t.getHours()}:${t.getMinutes()}:`+t.getSeconds()}function $t(e){return"object"==typeof e&&!Yt(e)}zt.NON_INTERACTIVE_EVENTS=[p,f,p,_];class Jt{constructor(e){this.EVENT_ACTION=e.event.name,this.EVENT_ATTRS=e.event.attributes&&Xt(e.event.attributes),this.EVENT_G_TIME=(new Date).getTime().toString(),this.EVENT_L_TIME=qt(e.event.timestamp),this.EVENT_ATTRS_CUST=e.postData.c,this.N_I_E=e.postData.nie}}Jt.baseLogTag="ReportAddViewEvent";const Xt=e=>{const t={};return e.forEach((e=>{t[e.key]=e.value})),t};class Qt{static visibilityChange(){"hidden"===document.visibilityState&&(Qt.windowClosed||on.reactToTriggerEvents())}static removeEventListeners(){document.removeEventListener("visibilitychange",Qt.visibilityChange,!1)}static addListeners(){document.addEventListener("visibilitychange",Qt.visibilityChange,!1)}}Qt.windowClosed=!1;const Zt=Qt;class en{static initialize(){return function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){if(null==en.ready){en.offlineDataStore=e.createInstance({driver:[e.INDEXEDDB],name:ue,storeName:ge.NAME});const n=e.createInstance({driver:[e.INDEXEDDB],name:ue,storeName:"moe_data"}),i=e.createInstance({driver:[e.INDEXEDDB],name:ue,storeName:"moe_backup"});var t=[en.offlineDataStore.ready(),n.ready(),i.ready()];en.ready=Promise.all(t)}return yield en.ready}))}}class tn{static getRemoteLogsBatchRequestOptions(e){return new Promise((t=>{vn.collectGetParams().then((n=>{n={query_params:Object.assign(Object.assign({},n),{unique_id:n.unique_id,os:"web"===n.os?"Web":"mWeb"}),logs:[...e]},t(n)}))}))}static sendBatchOfLogs(e){const t=vn.baseLogTag+".sendBatchOfLogs";return new Promise(((n,i)=>{tn.getRemoteLogsBatchRequestOptions(e).then((i=>{var a=(a=Et()).baseDomainName+ye+i.query_params.os.toLowerCase()+"/"+a.appId;lt.post(a,{postData:i}).then((()=>{We.log(1,t,"[sendBatchOfLogs] batch payload: "+JSON.stringify(e)),We.log(1,t,"Batch Remote Logs sent to MoEngage successfully"),tn.batchRemoteLogsApiRetries=1,n(!0)})).catch((n=>{We.log(1,t,"Batch Remote Logs API failed",n),this.handleRemoteLogsFailure(e)}))}))}))}static handleRemoteLogsFailure(e){var t=vn.baseLogTag+".handleRemoteLogsFailure";We.log(1,t,"Retry Batch Logs Failed API",tn.batchRemoteLogsApiRetries),tn.batchRemoteLogsApiRetries<3&&setTimeout((()=>{tn.batchRemoteLogsApiRetries++,tn.sendBatchOfLogs(e)}),3e3*tn.batchRemoteLogsApiRetries)}static sendBeacon(e){tn.getRemoteLogsBatchRequestOptions(e).then((e=>{var t=(t=Et()).baseDomainName+ye+e.query_params.os.toLowerCase()+"/"+t.appId+"?"+(new Date).getTime();We.log(1,"RemoteLogsApi.sendBeacon","[sendBeacon] Remote Logs batch payload: "+JSON.stringify(e)),navigator.sendBeacon(t,JSON.stringify(e))}))}}tn.batchRemoteLogsApiRetries=1;var nn,an=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class rn{static updateEventStore(){ct()!==Ie.TV&&e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:"moe_tracking",storeName:ae}).setItem(ae,rn.reports)}static spliceReports(e=rn.reports.length){return e=rn.reports.splice(0,e),rn.updateEventStore(),e}static spliceRemoteLogs(e=rn.remoteLogs.length){return rn.remoteLogs.splice(0,e)}static suspendBatching(){var e=rn.baseLogTag+".suspendBatching";this.spliceReports(),this.spliceRemoteLogs(),rn.periodicSyncInterval&&rn.clearInterval(),Zt.removeEventListeners(),We.log(2,e,"Batching has stopped.")}static shouldCreateNewBatch(){return!rn.lastbatchCreatedAt||(new Date).getTime()-rn.lastbatchCreatedAt>=pe}static shouldCreateNewBatchForRemoteLogs(){return!rn.lastRemoteLogsbatchCreatedAt||(new Date).getTime()-rn.lastRemoteLogsbatchCreatedAt>=pe}static reactToTriggerEvents(){var e=rn.baseLogTag+".reactToTriggerEvents";0<rn.reports.length?(We.log(1,e,`Trigger Events: Created Batch of ${rn.reports.length} reports`,qt()),rn.createBatch()):We.log(2,e,qt()+": No report's to sync for this event."),0<rn.remoteLogs.length?(We.log(1,e,`Trigger Events: Created Batch of remote logs ${rn.remoteLogs.length} reports`,qt()),rn.createRemoteLogsBatch()):We.log(2,e,qt()+": No logs's to sync for remote logs.")}static periodicSync(e){var t=rn.baseLogTag+".periodicSync";0<rn.reports.length&&rn.shouldCreateNewBatch()?(We.log(1,t,`Periodic sync: Created Batch of ${rn.reports.length} reports`,qt()),rn.createBatch()):We.log(2,t,qt()+`: No report's to sync at this interval. The next sync will attempt in ${e} seconds`),0<rn.remoteLogs.length&&rn.shouldCreateNewBatchForRemoteLogs()?(We.log(1,t,`Periodic sync: Created Batch of remote logs ${rn.reports.length} reports`,qt()),rn.createRemoteLogsBatch()):We.log(2,t,qt()+`: No report's to sync at this interval for remote logs. The next sync will attempt in ${e} seconds`)}static clearInterval(){clearInterval(rn.periodicSyncInterval),rn.lastbatchCreatedAt=null}static init(e){ft.getInstance().then((t=>an(this,void 0,void 0,(function*(){(rn.isOfflineBatchingSupported(t,e)||e.configs.remoteLogTracking)&&(yield en.initialize(),rn.periodicSyncInterval&&rn.clearInterval(),rn.periodicSyncInterval=window.setInterval(rn.periodicSync.bind(this,e.configs.periodicFlushTime),1e3*e.configs.periodicFlushTime),Zt.addListeners())}))))}static sendBatch(e){const t=rn.baseLogTag+".sendBatch";return new Promise((n=>{try{vn.sendBatchOfReports(e).then((()=>{rn.lastbatchCreatedAt=(new Date).getTime(),n(!0)}))}catch(e){We.error(1,t,"Error in sending batch",e),n(!1)}}))}static sendRemoteLogs(e){const t=rn.baseLogTag+".sendRemoteLogs";return new Promise((n=>{try{tn.sendBatchOfLogs(e).then((()=>{rn.lastRemoteLogsbatchCreatedAt=(new Date).getTime(),n(!0)}))}catch(e){We.error(1,t,"Error in sending batch of remote logs",e),n(!1)}}))}static createBatch(e){0<rn.reports.length&&(e=rn.spliceReports(e),rn.sendBatch(e))}static createRemoteLogsBatch(e){0<rn.remoteLogs.length&&(e=rn.spliceRemoteLogs(e),rn.sendRemoteLogs(e))}static addReport(e,t){var n=rn.baseLogTag+".addReport";return e=new Jt(e),Kt(e)?(We.error(1,n,Vt(e.EVENT_ACTION)),!1):(rn.reports.push(e),Kt(rn.reports)?(rn.reports.pop(),We.log(1,n,`Created Batch of ${rn.reports.length} reports as payload size would have breached after adding new event to this batch: "${e.EVENT_ACTION}"`,qt()),rn.createBatch(),rn.reports.push(e),rn.updateEventStore()):(rn.updateEventStore(),rn.reports.length===t&&(We.log(1,n,`Created Batch of ${t} reports`,qt()),rn.createBatch(t))),!0)}static sendBeacon(){var e=rn.baseLogTag+".sendBeacon";0<rn.reports.length&&(We.log(1,e,`Window Unload: Created batch of ${rn.reports.length} reports`,qt()),vn.sendBeacon(rn.spliceReports())),0<rn.remoteLogs.length&&(We.log(1,e,`Window Unload: Created Remote Logs batch of ${rn.remoteLogs.length} reports`,qt()),tn.sendBeacon(rn.spliceRemoteLogs()),rn.lastRemoteLogsbatchCreatedAt=(new Date).getTime())}static flushReports(e=!1){return an(this,void 0,void 0,(function*(){var t=rn.baseLogTag+".flushReports";try{e&&Zt.removeEventListeners(),0<rn.reports.length&&(We.log(1,t,`Flushed ${rn.reports.length} reports`,qt()),yield rn.sendBatch(rn.spliceReports())),0<rn.remoteLogs.length&&(We.log(1,t,`Flushed ${rn.remoteLogs.length} remote logs`,qt()),yield rn.sendRemoteLogs(rn.spliceRemoteLogs()))}catch(e){We.error(1,t,"Error in flushing reports",e)}}))}static isOfflineBatchingSupported(e,t){return t=t||nt.get(s.WEB_SETTINGS),rn.isBatchingSupported(t,e)}static addRemoteLogs(e,t=15){var n=rn.baseLogTag+".addRemoteLogs";rn.remoteLogs.push(e),rn.remoteLogs.length===t&&(We.log(1,n,`Created Batch of ${t} reports`,qt()),rn.createRemoteLogsBatch(t))}static isBatchingSupported(e,t){try{var n=ct();return!(null==e||!e.configs.isBatchingEnabled||("web"!==n||t.name!==ft.BROWSER_NAMES.CHROME&&t.name!==ft.BROWSER_NAMES.EDGE&&t.name!==ft.BROWSER_NAMES.OPERA)&&("mobile"!==n||ft.isIOS()||t.name!==ft.BROWSER_NAMES.CHROME&&t.name!==ft.BROWSER_NAMES.OPERA)||!navigator.sendBeacon)}catch(e){We.error(1,"BatchManager.isBatchingSupported",e)}}}rn.baseLogTag="BatchManager",rn.reports=[],rn.remoteLogs=[],rn.lastbatchCreatedAt=null,rn.lastRemoteLogsbatchCreatedAt=null;const on=rn;class sn{constructor(e){var t=sn.baseLogTag+".constructor";let n=Ot.getSync().getAttribute("id");n=n?n.toString():void 0;const i=window.analytics;let a,r;if(i){r=i._VERSIONS;try{a=i.user().anonymousId()}catch(e){We.error(1,t,"Error getting anonymous id from segment api",e)}}this.c=void 0,this.h="",t=pt.getIdentityMap(),(n||a||null!=t&&t.userIdentities)&&(this.identifiers={moe_user_id:n,segment_id:a,user_identities:(null==t?void 0:t.userIdentities)||void 0,previous_identities:(null==t?void 0:t.previousIdentities)||void 0}),this.meta={bid:(0,rt.v4)(),segmentSdkData:i?r:void 0}}}sn.baseLogTag="ReportPostData";class ln{constructor(e,t,n,i){ln.baseLogTag,this.type=e,this.getParams=t,this.event=n,this.postData=new sn(i);const a={},r={};for(const e of n.attributes)if(e&&null!=e.key&&(this.status=ln.STATUS.VALID,null!=e.value))if("function"==typeof e.value.getMonth){const t={};t[e.key]=Math.round(e.value.getTime()-6e4*e.value.getTimezoneOffset()),null==r.timestamp&&(r.timestamp=[]),r.timestamp.push(t)}else a[e.key]=e.value;this.postData.e=n.name,this.postData.a=a,this.postData.c=(n=r,0===Object.keys(n).length&&n.constructor===Object?void 0:r),window&&window.location&&null!=window.location.href&&(this.postData.url=window.location.href)}}ln.baseLogTag="ReportClass",(nn=(kn=ln=ln||{}).STATUS||(kn.STATUS={}))[nn.INVALID=0]="INVALID",nn[nn.VALID=1]="VALID",(kn=kn.REPORT_ADD_TYPE||(kn.REPORT_ADD_TYPE={}))[kn.USER_ATTRIBUTE=0]="USER_ATTRIBUTE",kn[kn.EVENT=1]="EVENT";const dn=ln;class cn{constructor(e,t,n=!0){this.name=e,this.attributes=t,this.timestamp=(new Date).getTime(),n&&this.attributes.push(new yt("URL",location.href))}static createUserAttributeEvent(e){return new Promise(((t,n)=>{const i=[];var a=e.key;switch(e.key){case"id":e.key=P;break;case"email":e.key=N;break;case"name":e.key=C;break;case"first_name":e.key=R;break;case"last_name":e.key=L;break;case"mobile":e.key=k;break;case"gender":e.key=M;break;case"birthday":e.key=x}i.push(e),e.key!==a&&We.log(2,"Event.createUserAttributeEvent","Key changed to MoE reserved keyname: ",e.key),t(new cn("EVENT_ACTION_USER_ATTRIBUTE",i,!1))}))}static createEvent(e,t,n){return new Promise(((i,a)=>{Ot.get().then((a=>function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){try{var r=new yt("moe_logged_in_status",!!a.getAttribute("id"));const s=new zt;var o=new yt("moe_first_visit",s.getNumberOfSessions()<=1);t.push(r,o),i(new cn(e,t,n))}catch(r){We.error(1,"Event.createEvent","Error occurred in create events ",r)}}))))}))}}class un{static addEvent(e){un.history.push(e),un.listeners.forEach((t=>{t(e)}))}static getHistory(){return un.history}static addEventListener(e){un.listeners.push(e)}static clear(){un.history=[]}static clearAll(){un.history=[],un.listeners=[]}}var gn;un.history=[],un.listeners=[];class mn{static track(e,t,n){const i="MoEngage.event.trackEvent";return new Promise(((a,r)=>function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){var r,o;if(!xt())return We.warn(2,i,`Not tracking the event "${e}" as Web SDK has been disabled.`),void a(!1);let s;n=!!n;try{s=yield St()}catch(o){return We.warn(1,i,"SDK not yet initialized. Caching event and will track when SDK is initialized.",o),null!==(r=window.moengage_q)&&void 0!==r&&r.push({f:"track_event",a:[e,t]}),void a(!1)}if("string"==typeof e&&e)if(s.configs.blacklistedEvents&&s.configs.blacklistedEvents.includes(e))We.error(1,i,`This event "${e}" is blacklisted. Please contact Moengage team to whitelist it.`),a({error:5001,message:`Event "${e}" is blacklisted.`});else if(!fe.includes(e)||s.configs.whitelistedEvents&&s.configs.whitelistedEvents.includes(e))try{const r=[];if(null==t||null!==t&&t===Object(t)&&"[object Object]"===Object.prototype.toString.call(t)){for(const e in t=null==t?{}:t)t.hasOwnProperty(e)&&r.push(new yt(e,t[e]));const i=new zt;yield i.initiateSessionAndSource(s);const l=yield cn.createEvent(e,r);un.addEvent(l),null!=s&&s.configs.isWebPersonalizationModuleEnabled&&null!==(o=window.MoeWebP)&&void 0!==o&&o.handleInSessionEvent(l),vn.collectGetParams().then((t=>{Ft(e)&&delete t.push_id;const r=new dn(dn.REPORT_ADD_TYPE.EVENT,t,l);var o={session_id:i.getSessionKey(),start_time:i.getSessionStartTime(),background_initiated:0};const s=[];(t=i.getActiveSource())&&(i.setCurrentSource(t),s.push(t)),r.postData.meta.session=o,s.length&&(r.postData.meta.source=s),i.isNonEventInteractive(l)&&(r.postData.nie=1),vn.reportAdd(r,n).then((()=>{i.isNonEventInteractive(l)||i.extendSession(),a(!0)}))}))}else We.error(1,i,"Event attributes were not passed a key-value pair object for event: "+e),a({error:5002,message:"Event value needs to be a key-value pair object"})}catch(o){We.error(1,i,"Error occurred in tracking events ",o)}else We.error(1,i,`This event "${e}" has not been whitelisted. Please contact Moengage team to whitelist it.`),a({error:5001,message:`Event "${e}" is not whitelisted.`});else We.error(1,i,"Event name not a string or null or empty string:",e),a({error:5001,message:"Event name can not be null"})}))))}}(kn=gn=gn||{}).PROMPT="prompt",kn.GRANTED="granted",kn.DENIED="denied",kn.DISMISSED="dismissed";var pn,hn=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class vn{static deviceAdd(){var e=vn.baseLogTag+".deviceAdd";return vn.isExecutingDeviceAdd?(We.warn(2,e,"Device add is already in progress. Skipping this call."),Promise.resolve(!1)):(vn.isExecutingDeviceAdd=!0,new Promise(((e,t)=>hn(this,void 0,void 0,(function*(){if(xt()){const n=He.get();return vn.collectGetParams(be).then((i=>{i={queryParams:i=Object.assign(Object.assign({},i),{url:window.location.href})},lt.post(n.baseDomainName+be,i).then((()=>{Ot.get().then((e=>{e.deviceAdded=!0,e.save().then((()=>{En.startPeriodicClear(s.Q.REPORT),vn.onDeviceAdd.res()}))})).then((()=>{this.trackDeviceAttributes(),vn.isExecutingDeviceAdd=!1,e(!0)}))})).catch((e=>{it.enqueue(s.Q.DEVICE,!0),vn.isExecutingDeviceAdd=!1,t(!1)}))}))}e(!1)})))))}static trackDeviceAttributes(){const e=vn.baseLogTag+".trackDeviceAttributes";return new Promise(((t,n)=>hn(this,void 0,void 0,(function*(){try{let t=ct().toUpperCase();t="WEB"===t?"DESKTOP":t,mn.track(T,{deviceType:t});let n=!1;ft.getInstance().then((t=>{St().then((i=>hn(this,void 0,void 0,(function*(){if(Fe(i,t)){let t=bt();if(!t)try{const e=Me()||{};let n="";"function"==typeof e.getPermissionState&&(n=yield e.getPermissionState()),n===gn.GRANTED&&(t=!0)}catch(t){We.error(2,e,"Failed to get push notification permission state.",t)}n=t}})))).then((()=>{mn.track(T,{[Ee]:!!n,source:"deviceAdd"}),nt.set(s.OPTED_STATUS_TRACK_TIME,Date.now())}))}))}catch(t){We.error(2,e,"Failed to track device attributes.",t)}t(null)}))))}static reportAdd(e,t){const n=vn.baseLogTag+".reportAdd";return new Promise(((i,a)=>(t=!!t,St().then((r=>{r.isPushSubBilling?Ot.get().then((o=>{o.deviceAdded?vn.reportAddInternal(e,t).then((()=>{this.sendBroadcast(e),i(!0)})).catch((()=>{a(!1)})):(it.enqueue(s.Q.REPORT,e),We.log(1,n,"Report added to queue as device not added yet:",e.event.name),We.log(2,n,"Event Queued:",e.event.name),e.type===dn.REPORT_ADD_TYPE.USER_ATTRIBUTE&&(Ve(e.event.attributes[0].key,null===(o=null==r?void 0:r.configs)||void 0===o?void 0:o.subscriberBasedBillingAttributes)?(We.log(1,n,"Attribute accepted for push sub billing."),vn.deviceAdd()):We.log(2,n,"Attribute NOT accepted for push sub billing.")),i(!0))})):vn.reportAddInternal(e,t).then((()=>{this.sendBroadcast(e),i(!0)})).catch((()=>{a(!1)}))})).catch((e=>{We.error(1,n,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),a(!1)})))))}static sendBroadcast(e){ve.NAMES.includes(e.event.name)&&Ht.broadcastToWindow({topic:ve.TOPIC,name:e.event.name,data:e.event.attributes})}static getSegmentId(){const e=window.analytics;if(e&&e.user)return e.user().anonymousId()}static getBatchRequestOptions(e){return new Promise((t=>{vn.collectGetParams(me).then((n=>hn(this,void 0,void 0,(function*(){var i=vn.getSegmentId()||"";const a=Ot.getSync();var r=He.get();const o=new zt;var s={session_id:o.getSessionKey(),start_time:o.getSessionStartTime(),background_initiated:0};const l=[];(u=o.getActiveSource())&&(o.setCurrentSource(u),l.push(u));var{userIdentities:d,previousIdentities:c}=yield pt.getIdentifiersFromIdentities(),u={user_identities:d||void 0,previous_identities:c||void 0},c=yield this.getParamsFromCookie();let g=null;const m=Object.assign({},n);null!==c&&"object"==typeof c&&(g=c.moe_user_id,null!==c.push_id&&(m.push_id=c.push_id),null!==c.unique_id&&(m.unique_id=c.unique_id)),r={query_params:m,identifiers:Object.assign(Object.assign({moe_user_id:null!==g?g:a.getAttribute("id")||(null==d?void 0:d.uid)||void 0,segment_id:i||void 0},u),{moe_aid:Mt()}),meta:{bid:(0,rt.v4)(),request_time:(new Date).toISOString(),session:s,source:l.length?l:void 0,initiator:null!==(r=null===(r=null==r?void 0:r.proxyDomains)||void 0===r?void 0:r.api)&&void 0!==r&&r.length?"proxy_server":void 0},viewsCount:e.length,viewsInfo:[...e]},t(r)}))))}))}static getParamsFromCookie(){const e=this.baseLogTag+".getMoeUserIdFromCookies",t={moe_user_id:null,unique_id:null,push_id:null};return new Promise((n=>{St().then((e=>{var i;if(null!=e&&e.isDomainLevelStorage){const n=et.get(s.USER_DATA);e=null===(i=et.get(s.SUBSCRIPTION_DETAILS))||void 0===i?void 0:i.token,n&&(null!==(i=n.attributes)&&void 0!==i&&i.length&&n.attributes.find((e=>e.key===P))?t.moe_user_id=n.attributes.find((e=>e.key===P)).value:t.moe_user_id=void 0,null!==(i=n.deviceUuid)&&void 0!==i&&i.length&&(t.unique_id=n.deviceUuid)),null!=e&&e.length&&Ut(e)?t.push_id=e:t.push_id=void 0}n(t)})).catch((i=>{We.error(2,e,"Error occurred while trying to fetch SDK Settings: ",i),n(t)}))}))}static addReportsToOfflineDB(e,t){return hn(this,void 0,void 0,(function*(){const n=vn.baseLogTag+".addReportsToOfflineDB";var i=yield vn.getBatchRequestOptions([]);yield en.offlineDataStore.setItem(t||"report_add_"+(new Date).getTime(),e),yield en.offlineDataStore.setItem("requestMetaData",i),yield en.offlineDataStore.setItem(t||"batch_"+(new Date).getTime(),Object.assign(Object.assign({},i),{viewsCount:e.length,viewsInfo:e})),navigator.serviceWorker&&navigator.serviceWorker.ready.then((e=>{e.sync?e.sync.register("moe_offline_data_sync").then((()=>{We.log(2,n,"offline sync event registered")})).catch((e=>{We.error(1,n,"Service worker sync error",e)})):We.log(2,n,"Service worker sync unavailable")}))}))}static sendReportBeacon(e,t,n){var i=vn.baseLogTag+".sendReportBeacon";try{if(!e&&navigator.sendBeacon&&navigator.sendBeacon(t,new Blob([JSON.stringify(n)],{type:"text/plain;charset=UTF-8"})))return!0}catch(e){We.error(2,i,"Failed to send Report call with Beacon:",e)}return!1}static sendBatchOfReports(e){const t=vn.baseLogTag+".sendBatchOfReports";return new Promise(((n,i)=>{vn.getBatchRequestOptions(e).then((a=>{var r=He.get();const o=r.baseDomainName+me+r.appId;St().then((i=>window.navigator.onLine?vn.sendReportBeacon(i.configs.isBeaconDisabled,o,a)?(We.log(1,t,"[sendBatchOfReports] batch payload: "+JSON.stringify(e)),We.log(1,t,"Batch sent to MoEngage successfully through beacon"),void n(!0)):void lt.post(o,{postData:a}).then((()=>{We.log(1,t,"[sendBatchOfReports] batch payload: "+JSON.stringify(e)),We.log(1,t,"Batch sent to MoEngage successfully"),n(!0)})).catch((a=>{We.error(1,t,"Batch Report add API failed",a),n(this.sendToOfflineTracking(e,a,i))})):this.sendToOfflineTracking(e,Ae,i))).catch((e=>{e!==Ae&&We.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),i(e)}))}))}))}static sendToOfflineTracking(e,t,n){const i=vn.baseLogTag+".sendToOfflineTracking";return new Promise(((a,r)=>{if(!xt())return We.warn(2,i,"Not adding report(s) to offline db as SDK has been disabled."),void r(t);ft.getInstance().then((o=>{on.isOfflineBatchingSupported(o,n)?(We.error(1,i,"Add Report API failed, adding reports to offline db. ",t),vn.addReportsToOfflineDB(e).then((()=>{We.log(2,i,"Network offline: Batch added to offline db")})),a(!0)):(We.warn(1,i,"Report not added to offline db. Offline tracking is supported only if batching is enabled. It is supported only on Chrome, Edge and Opera browsers on desktop web and Chrome and Opera browsers on Android web."),r(t))})).catch((()=>{r(t)}))}))}static reportAddInternal(e,t){const n=vn.baseLogTag+".reportAddInternal";return new Promise(((i,a)=>{St().then((a=>{ft.getInstance().then((r=>{if(t){const t=vn.getUpdatedPushDetails();for(const n in t)!t.hasOwnProperty(n)||Ft(e.event.name)&&"push_id"===n||(e.getParams[n]=t[n]);var o=ut();const n={queryParams:Object.assign(Object.assign({},e.getParams),o)};if(e.postData.nie){const t=Object.assign({},e);delete t.postData.meta.source,delete t.postData.meta.session,n.postData=t.postData}else n.postData=e.postData;o=He.get().baseDomainName,o+=be,lt.post(o,n).then((()=>{let t=ct().toUpperCase();t="WEB"===t?"DESKTOP":t,mn.track(T,{deviceType:t}),i(vn.handleReportAddSuccess(e))})).catch((t=>{on.isBatchingSupported(a,r)?it.enqueue(s.Q.DEVICE,e):vn.handleReportAddFailure(e,t)}))}else on.isBatchingSupported(a,r)?(on.addReport(e,a.configs.eventBatchCount)&&(We.log(1,n,"Event batched successfully:",e.event),this.addEventsToIDB(e.event)),i(!0)):(o=new Jt(e),Kt(o)?(We.error(1,n,Vt(o.EVENT_ACTION)),i(!1)):vn.sendBatchOfReports([o]).then((()=>{i(vn.handleReportAddSuccess(e))})).catch((t=>{vn.handleReportAddFailure(e,t)})))}))})).catch((e=>{We.error(1,n,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),a(!1)}))}))}static handleReportAddSuccess(e){var t=vn.baseLogTag+".handleReportAddSuccess";return e.type===dn.REPORT_ADD_TYPE.EVENT?(We.log(1,t,"Event tracked successfully:",e.event),this.addEventsToIDB(e.event)):e.type===dn.REPORT_ADD_TYPE.USER_ATTRIBUTE&&We.log(1,t,"User attribute added successfully:",e.event.attributes),vn.addReportApiRetries=1,!0}static handleReportAddFailure(e,t){var n=vn.baseLogTag+".handleReportAddFailure";We.error(1,n,"Add Report API failed",t),e.type===dn.REPORT_ADD_TYPE.EVENT?We.log(1,n,"Queueing unsuccessful event tracking:",e.event):e.type===dn.REPORT_ADD_TYPE.USER_ATTRIBUTE&&We.log(1,n,"Queueing unsuccessful user attribute add:",e.event.attributes),vn.addReportApiRetries<3&&setTimeout((()=>{vn.addReportApiRetries++,it.enqueue(s.Q.REPORT,e),En.startPeriodicClear(s.Q.REPORT)}),3e3*vn.addReportApiRetries)}static checkIfTokenValid(e){const t=He.get().baseDomainName+_e,n=He.get();return new Promise((i=>{e?Ot.get().then((a=>{a={queryParams:{app_id:n.appId,unique_id:a.deviceUuid,push_id:e}},lt.post(t,a).then((e=>{200===e.status?i(!0):i(!1)})).catch((e=>{i(!1)}))})):i(!1)}))}static collectGetParams(e){return new Promise(((t,n)=>{Ot.get().then((n=>hn(this,void 0,void 0,(function*(){let i=He.get();null!=i&&null!=i.appId||(i=new He(nt.get(s.INIT_DATA)));const a=yield St(),r=new Date,o=Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),r.getUTCHours(),r.getUTCMinutes(),r.getUTCSeconds(),r.getUTCMilliseconds());ft.getInstance().then((r=>{var l=this.getDeviceUniqueId(),d=ut(e,[Te,be,me]);const c=Object.assign({os:r.os,os_platform:r.osPlatform,is_incognito:r.isIncognito,app_id:i.appId,os_ver:r.name,sdk_ver:"2.56.1",model:r.name,app_ver:"1.0",device_ts:Number(o),device_tz_offset:(-6e4*(new Date).getTimezoneOffset()).toString(),unique_id:n.deviceUuid,device_tz:(new Date).getTimezoneOffset().toString(),device_unique_id:l},d);d=n.getAttribute("cart_token"),Ke()&&d&&null!=a&&a.configs.isMultiIdEnabled&&e!==be&&(c.cart_token=d),Ut(d=bt())&&(c.push_id=d),r.isWebPushCompatible()&&(Ge(a.webPushPlatformData,r)?(c.subscription_type="vapid",c.vapid_public=je(a.webPushPlatformData,r)):c.subscription_type="normal"),null!=i.environment&&(c.environment=i.environment);var u=nt.get(s.SUBSCRIPTION_DETAILS);if(null!=u&&null!=u.keys){for(const e in u.keys)c["keys_"+e]=encodeURI(u.keys[e]);null!=u.endpoint&&(c.endpoint=encodeURI(u.endpoint)),c.expirationTime=u.expirationTime}t(c)}))}))))}))}static getDeviceUniqueId(){var e;return(null===(e=nt.get(s.DEVICE_DATA))||void 0===e?void 0:e.deviceUniqueId)||void 0}static getUpdatedPushDetails(){const e={};var t=nt.get(s.SUBSCRIPTION_DETAILS);if(null!=t){var n=t.token;if(null!=n&&"NA"!==n&&""!==n&&"null"!==n&&(e.push_id=n),t.keys){for(const n in t.keys)e["keys_"+n]=encodeURI(t.keys[n]);null!=t.endpoint&&(e.endpoint=encodeURI(t.endpoint)),e.expirationTime=t.expirationTime}}return e}static sendBeacon(e){if(!window.navigator.onLine)return this.sendToOfflineTracking(e,Ae);vn.getBatchRequestOptions(e).then((e=>{var t=(t=He.get()).baseDomainName+me+t.appId+"?"+(new Date).getTime();We.log(1,"MoeApi.sendBeacon","[sendBeacon] batch payload: "+JSON.stringify(e)),navigator.sendBeacon(t,JSON.stringify(e))}))}static addEventsToIDB(t){if(ct()!==Ie.TV){const n=e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:ne,storeName:ie});null!=n&&n.setItem(t.name,t)}}}vn.baseLogTag="MoeApi",vn.onDeviceAdd=new gt,vn.webSdkApiRetries=1,vn.offlineEvents=[],vn.addReportApiRetries=1,vn.isExecutingDeviceAdd=!1;const fn=n(967),Sn=s.Q;class En{static clear(e){var t=En.baseLogTag+".clear";if(xt()){const n=[];for(;!it.isEmpty(e);)switch(e){case Sn.REPORT:const i=it.dequeue(Sn.REPORT);n.push((e=>{vn.reportAdd(i).then((()=>{e()}))}));break;case Sn.DEVICE:it.dequeue(Sn.DEVICE)&&n.push((e=>{vn.deviceAdd().then((()=>{e()}))}));break;default:We.error(1,t,"Do not know how to handle queue with name:",e)}setTimeout((()=>{En.processing[e]=!0,fn(n,5,((t,n)=>{En.processing[e]=!1}))}),0)}}static startPeriodicClear(e){const t=En.baseLogTag+".startPeriodicCleanQ";En.clearInterval(e);var n=()=>{it.isEmpty(e)?(We.log(1,t,"If you see multiple event tracks with same, they were captured over multiple visits or page refreshes."),Le(En.processing,e,!1)||En.clearInterval(e)):(En.clear(e),We.log(1,t,"Starting periodic queue clear for",e))};n(),En.intervals[e]=setInterval(n,6e3)}static clearInterval(e){null!=En.intervals[e]&&(clearInterval(En.intervals[e]),En.intervals[e]=null)}}En.baseLogTag="QManager",En.intervals={},En.processing={};const yn=class{constructor(e){this.isBeaconDisabled=this.parseSentryBooleanFlag(Le(e,"b_d",!1)),this.isCardsModuleEnabled=this.parseSentryBooleanFlag(Le(e,"c_s",!1)),this.isWebPersonalizationModuleEnabled=this.parseSentryBooleanFlag(Le(e,"c_w_p_e",!1)),this.eventBatchCount=Le(e,"e_b_c",15),this.logLevel=Le(e,"log_level"),this.periodicFlushTime=Le(e,"p_f_t",30),this.isBatchingEnabled=this.parseSentryBooleanFlag(Le(e,"s_e_b_e",!1)),this.sessionInactiveDuration=Le(e,"s_i_d",1800),this.isRemoteLoggingEnabled=this.parseSentryBooleanFlag(Le(e,"s_log",!1)),this.sourceExtraParams=Le(e,"src_ext",[]),this.whitelistedEvents=Le(e,"w_e",[]),this.blacklistedEvents=Le(e,"b_e",[]),this.isAppActive=this.parseSentryBooleanFlag(Le(e,"a_s",!0)),this.remoteLogTracking=this.isRemoteLoggingEnabled&&!!this.logLevel,this.subscriberBasedBillingAttributes=Le(e,"s_b_a",[]),this.isMultiIdEnabled=this.parseSentryBooleanFlag(Le(e,"m_i_e",!1)),this.userAttributeCacheTime=Le(e,"u_a_c_t",43200),this.identityAttributes=Le(e,"u_i_s",[])}parseSentryBooleanFlag(e="blocked"){return"allowed"===e||!0===e||"true"===e}};class bn{constructor(e){this.mobile=new _n(Le(e,"mobile",{})),this.web=new _n(Le(e,"web",{}))}}class _n{constructor(e){this.nudge=e.nudge?new Tn(e.nudge):void 0,this.banner=e.banner?new Tn(e.banner):void 0,this.allowButton=e.allow_button?new In(e.allow_button):void 0,this.dismissButton=e.dismiss_button?new In(e.dismiss_button):void 0,this.logo=e.logo?new wn(e.logo):void 0}}class Tn{constructor(e){this.title=new An(Le(e,"title",{})),this.body=null!=e&&e.body?new An(Le(e,"body",{})):void 0,this.backgroundColor=null==e?void 0:e.background_color,this.icon=null==e?void 0:e.icon,this.altText=(null==e?void 0:e.alt_text)||""}}class In{constructor(e){this.textColor=null==e?void 0:e.text_color,this.text=Le(e,"text",""),this.backgroundColor=null==e?void 0:e.background_color}}class An{constructor(e){this.textColor=null==e?void 0:e.text_color,this.text=Le(e,"text","")}}class wn{constructor(e){this.logoUrl=(null==e?void 0:e.logo_url)||"",this.logoColor=(null==e?void 0:e.logo_color)||"",this.altText=(null==e?void 0:e.alt_text)||""}}(kn=pn=pn||{}).ONE_STEP="1-step",kn.TWO_STEP="2-step",kn.SELF_HANDLED="self-handled";class Dn{constructor(e){this.subscriptionMode=Le(e,"subscription_mode","vapid"),this.vapidPublicKey=Le(e,"vapid_public_key",null)}}class On{constructor(e){this.chrome=new Dn(null==e?void 0:e.chrome),this.firefox=new Dn(null==e?void 0:e.firefox)}}class Pn{static getWebSDKSettings(){return Pn.BASE_LOG_TAG,new Promise(((e,t)=>{const n=Pn.getInitData();var i,a,r,o,l=n=>{Pn.isAppBlocked(n)?t(!1):(null!=n&&n.isDomainLevelStorage&&et.set(d,n.isDomainLevelStorage),e(n))};Pn.sdkSettings?l(Pn.sdkSettings):xt()?(i=(new Date).getTime(),o=()=>Pn.getAndPersistWebSettings(n).then((t=>e(t))).catch((e=>t(!1))),null==(a=nt.get(s.SETUP_TIME))||0<n.debugLevel||nt.get(s.SDK_VERSION)!==Me().getSdkVersion()||i-a>60*Pn.RESET_DURATION_IN_HOURS*60*1e3||!(r=nt.get(s.WEB_SETTINGS))?o():(Pn.sdkSettings=r,l(Pn.sdkSettings))):(o=nt.get(s.WEB_SETTINGS))&&(Pn.sdkSettings=o,l(Pn.sdkSettings))}))}static getAndPersistWebSettings(e){const t=Pn.BASE_LOG_TAG+".getAndPersistWebSettings";return new Promise(((n,i)=>function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){try{We.log(1,t,"Fetching latest settings for",e.appId);var a={queryParams:{app_id:e.appId}},r={postData:{query_params:{unique_id:(c=nt.get(s.USER_DATA))&&c.deviceUuid}}},o=lt.get(Pn.API_URLS.SETTINGS(e.baseDomainName),a),l=lt.post(Pn.API_URLS.CONFIG(e.baseDomainName,dt()?"mweb":"web",e.appId),r);Promise.all([o,l]).then((e=>{let t=e[0].responseText;"string"==typeof t&&(t=JSON.parse(t));let a=e[1].responseText;200===e[1].status&&"string"==typeof a&&(a=JSON.parse(a));var r=new class{constructor(e){this.isDomainLevelStorage=!1,this.configs=new yn({}),this.settingsVersion="V2",this.isDomainLevelStorage=Le(e,"domain_level_storage",!1),ct()===Ie.TV&&(this.isDomainLevelStorage=!1),this.toShowOverlay=Le(e,"show_overlay",!1),this.loadTime=Le(e,"load_time",0),this.promptAgain=Le(e,"prompt_again",24),this.optInType=Le(e,"opt_in_type",pn.TWO_STEP),this.isWebPushEnabled=Le(e,"is_enabled",!1),this.optInPreview=new bn(Le(e,"opt_in_preview",{})),this.overlay=Le(e,"overlay",null),this.webPushPlatformData=new On(e.web_push_platform_data),this.isPushSubBilling=Le(e,"sub_billing",!1),this.isBrandingHidden=Le(e,"hide_moe_branding",!1),this.configs=new yn(e)}}(Object.assign(Object.assign({},t.webData),a));Pn.updateLocalStorage(r),Pn.isAppBlocked(r)?i(!1):(Pn.sdkSettings=r,null!==(e=Pn.sdkSettings)&&void 0!==e&&e.isDomainLevelStorage&&et.set(d,Pn.sdkSettings.isDomainLevelStorage),n(r))})).catch((e=>{We.error(1,t,"Config API failed",e)}))}catch(a){We.error(1,t,"Settings APi Failed: ",a),Pn.webSdkApiRetries<Pn.WEB_SDK_API_MAX_RETRIES?setTimeout((()=>{Pn.webSdkApiRetries++,n(Pn.getAndPersistWebSettings(e))}),3e3*Pn.webSdkApiRetries):i(!1)}var c}))))}static isAppBlocked(e){return!(!e||!e.configs||!1!==e.configs.isAppActive)}static getInitData(){let e=He.get();return null!=e&&null!=e.appId||(e=new He(nt.get(s.INIT_DATA))),e}static updateLocalStorage(e){var t=(new Date).getTime();nt.set(s.WEB_SETTINGS,e),nt.set(s.SETUP_TIME,t),nt.set(s.SDK_VERSION,Me().getSdkVersion())}}Pn.BASE_LOG_TAG="CoreApi",Pn.RESET_DURATION_IN_HOURS=24,Pn.API_URLS={SETTINGS:e=>e+"v2/websdksettings",CONFIG:(e,t,n)=>e+`v3/sdkconfig/${t}/`+n},Pn.webSdkApiRetries=1,Pn.WEB_SDK_API_MAX_RETRIES=3;class Nn{addURLChangeObserver(e){const t=Nn.baseLogTag+".addURLChangeObserver";let n=document.location.href;(()=>{Nn.isObserverRunning=!0,We.log(2,t,"Start listening to URL changes for SPA");var i=document.querySelector("body");Nn.observer=new MutationObserver((i=>{i.forEach((i=>{n===window.location.href||Pe.some((e=>window.location.href.includes(e)))||(n=window.location.href,We.log(1,t,"URL Change detected",n),Nn.pageChangeHandler(e))}))})),Nn.observer.observe(i,{childList:!0,subtree:!0})})()}static pageChangeHandler(e){Ht.broadcastToWindow({topic:V,name:j.PAGE_CHANGED}),un.clearAll(),Me().track_page_view(),e&&nt.copyKeysFromCookie()}static removeURLChangeObserver(){var e,t=this.baseLogTag+".removeURLChangeObserver";this.isObserverRunning=!1,null!==(e=this.observer)&&void 0!==e&&e.disconnect(),We.log(2,t,"SPA URL Change Observer removed.")}}Nn.baseLogTag="SPAManager";class Cn{constructor(){Cn.handlePublicFunctions()}trackClick(e,t){return Cn.track("MOE_LANDING_PAGE_CLICKED",e,{widget_id:t})}trackImpression(e){return Cn.track("MOE_LANDING_PAGE_SHOWN",e)}trackFormSubmit(e,t){return Cn.track("MOE_RESPONSE_SUBMITTED",e,t)}trackEvent(e,t,n){return Cn.track(e,t,n)}static track(e,t,n){const i=Cn.baseLogTag+".track";if("string"==typeof t)try{t=JSON.parse(t)}catch(n){return void We.error(2,i,"Error parsing JSON string:",n)}if(n){if("string"==typeof n)try{n=JSON.parse(n)}catch(n){return void We.error(2,i,"Error parsing attributes JSON string:",n)}t=Object.assign(Object.assign({},n),t)}try{return Me()?(We.log(1,i,e+": Event Tracked"),Me().track_event(e,Object.assign({},t))):(window.addEventListener(W,(n=>{if(n.detail.name===H.MOE_INIT)return We.log(1,i,e+": Event Tracked"),Me().track_event(e,Object.assign({},t))})),Promise.resolve())}catch(n){We.error(2,i,"Failed Tracking expression",n)}}static handlePublicFunctions(){(Me()||{}).landingPages=Cn}}Cn.baseLogTag="Landing Pages Tracking";class Rn{}Rn.baseLogTag="MoEngage",Rn.landingPages=new Cn,Rn.getSdkVersion=()=>"2.56.1",Rn.setDebugLevel=e=>function(e,t,n,i){return new(n=n||Promise)((function(e,t){function a(e){try{o(i.next(e))}catch(e){t(e)}}function r(e){try{o(i.throw(e))}catch(e){t(e)}}function o(t){var i;t.done?e(t.value):((i=t.value)instanceof n?i:new n((function(e){e(i)}))).then(a,r)}o((i=i.apply(undefined,[])).next())}))}(0,0,void 0,(function*(){var t;const n=Rn.baseLogTag+".setDebugLevel",i=Me();try{"number"==typeof e&&(We.setLogLevel(e,!0),!He.get().disableOnsite&&null!==(t=null==i?void 0:i.onsite)&&void 0!==t&&t.setLogLevel&&i.onsite.setLogLevel(e),Pn.getWebSDKSettings().then((t=>{null!=t&&t.configs.isCardsModuleEnabled&&null!=i&&i.cards&&i.cards.setLogLevel(e),null!=t&&t.configs.isWebPersonalizationModuleEnabled&&window.MoeWebP&&window.MoeWebP.setLogLevel&&window.MoeWebP.setLogLevel(e)})).catch((e=>{We.error(1,n,"Error in getting Web SDK Settings. This might indicate that the App is blocked.")})))}catch(t){We.error(0,n,"Error changing log level:",t)}})),Rn.vitals=()=>{var e=nt.get(s.USER_DATA);return{userDetails:e,deviceUuid:null==e?void 0:e.deviceUuid,pushToken:nt.get(s.PUSH_TOKEN),softAskStatus:nt.get(s.SOFT_ASK_STATUS),hardAskStatus:nt.get(s.HARD_ASK_STATUS)}},Rn.help=()=>{for(const e in Z)Z.hasOwnProperty(e)&&We.log(0,"Moengage.help",e,"-",Z[e])},Rn.getBranch=()=>"master",Rn.handle_page_change=()=>{Pn.getWebSDKSettings().then((e=>{Nn.pageChangeHandler(e.isDomainLevelStorage)}))};const Ln={getData:(e,t)=>{window.addEventListener(W,(n=>{var i;n.detail.name===H.OSM_INIT&&null!==(i=Me())&&void 0!==i&&i.onsite.getData(e,t)}))},registerCallback:(e,t)=>{window.addEventListener(W,(n=>{var i;n.detail.name===H.OSM_INIT&&null!==(i=Me())&&void 0!==i&&i.onsite.registerCallback(e,t)}))},getSelfHandledOSM:e=>{window.addEventListener(W,(t=>{var n;t.detail.name===H.OSM_INIT&&null!==(n=Me())&&void 0!==n&&n.onsite.getSelfHandledOSM(e)}))}};var kn=()=>{};const Mn={track_event:kn,add_user_attribute:kn,add_first_name:kn,add_last_name:kn,add_email:kn,add_mobile:kn,add_user_name:kn,add_gender:kn,add_birthday:kn,destroy_session:kn,add_unique_user_id:kn,moe_events:kn,location_type_attribute:kn,call_web_push:kn,setDebugLevel:kn};var xn=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class Bn{static initialize(){return xn(this,void 0,void 0,(function*(){var t;return null==Bn.ready&&(Bn.serviceMetaStore=e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:de.DATABASE_NAME,storeName:de.STORES.SERVICE_META.NAME}),Bn.campaingsMetaStore=e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:de.DATABASE_NAME,storeName:de.STORES.CAMPAIGNS_META.NAME}),Bn.pendingSecondaryEvents=e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:de.DATABASE_NAME,storeName:de.STORES.PENDING_SECONDARY_EVENTS.NAME}),Bn.pendingTimerCampaigns=e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:de.DATABASE_NAME,storeName:de.STORES.PENDING_TIMER_CAMPAIGNS.NAME}),Bn.triggeringPrimaryEvents=e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:de.DATABASE_NAME,storeName:de.STORES.TRIGGERING_PRIMARY_EVENTS.NAME}),Bn.campaingsTagsStore=e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:de.DATABASE_NAME,storeName:de.STORES.CAMPAIGNS_TAGS.NAME}),Bn.campaingsStatsStore=e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:de.DATABASE_NAME,storeName:de.STORES.CAMPAIGNS_STATS.NAME}),Bn.exitIntentCampaignStore=e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:de.DATABASE_NAME,storeName:de.STORES.EXIT_INTENT_CAMPAIGN_STORE.NAME}),t=[Bn.serviceMetaStore.ready(),Bn.campaingsMetaStore.ready(),Bn.pendingSecondaryEvents.ready(),Bn.pendingTimerCampaigns.ready(),Bn.triggeringPrimaryEvents.ready(),Bn.campaingsTagsStore.ready(),Bn.campaingsStatsStore.ready(),Bn.exitIntentCampaignStore.ready()],Bn.ready=Promise.all(t)),Bn.ready}))}static clear(e=!1){return xn(this,void 0,void 0,(function*(){var t=Bn.baseLogTag+".clear";try{yield Bn.initialize(),yield Promise.all([Bn.campaingsMetaStore.clear(),Bn.campaingsTagsStore.clear(),Bn.exitIntentCampaignStore.clear(),Bn.triggeringPrimaryEvents.clear()]),e&&(yield Promise.all([Bn.serviceMetaStore.clear(),Bn.campaingsStatsStore.clear(),Bn.pendingSecondaryEvents.clear(),Bn.pendingTimerCampaigns.clear()]));const t=[Bn.campaingsMetaStore.ready(),Bn.campaingsTagsStore.ready(),Bn.exitIntentCampaignStore.ready(),Bn.triggeringPrimaryEvents.ready(),e?Bn.campaingsStatsStore.ready():Promise.resolve()];e&&t.push(Bn.serviceMetaStore.ready(),Bn.campaingsStatsStore.ready(),Bn.pendingSecondaryEvents.ready(),Bn.pendingTimerCampaigns.ready()),Bn.ready=Promise.all(t)}catch(e){We.error(1,t,"Error clearing onsite stores:",e)}return Bn.ready}))}static sdkOptOut(){return xn(this,void 0,void 0,(function*(){yield Promise.all([Bn.pendingSecondaryEvents.clear(),Bn.pendingTimerCampaigns.clear(),Bn.triggeringPrimaryEvents.clear()])}))}}Bn.baseLogTag="MOE_ONSITE_STORES";var Un,Wn,Hn,Fn,Gn,Kn=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};const Vn=(e,t,n)=>null==e.campaignId?()=>{}:()=>(Bn.campaingsStatsStore.getItem(e.campaignId).then((t=>{t=null!=t?Object.assign(Object.assign({},t),{clicks:Le(t,"clicks",0)+1}):{clicks:1},Bn.campaingsStatsStore.setItem(e.campaignId,t)})),null==n&&(n={}),$n().track_event(de.EVENT_NAMES[t].CLICK,Object.assign(Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName,type:de.EVENT_NAMES[t].TYPE},n),e.campaignContext))),jn=(e,t,n=!1)=>{return null==e.campaignId?()=>{}:((i=e).templateType!==Gn.SELF_HANDLED&&(ni(i,w)||ni(i,D))&&(Ea.onScrollOrExitIntentCampaigns[i.campaignId]=!0),()=>{if(Yn(e.campaignId),!n)return $n().track_event(de.EVENT_NAMES[t].IMPRESSION,Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName,type:de.EVENT_NAMES[t].TYPE,templateType:e.templateType},e.campaignContext))});var i},Yn=e=>{Bn.initialize().then((()=>{Bn.campaingsStatsStore.getItem(e).then((t=>{t=null!=t?Object.assign(Object.assign({},t),{impressions:Le(t,"impressions",0)+1,lastImpression:new Date}):{impressions:1,lastImpression:new Date},Bn.campaingsStatsStore.setItem(e,t)}))}))},zn=(e,t,n)=>{n=n?de.EVENT_NAMES[t].AUTO_DISMIS:de.EVENT_NAMES[t].DISMISS,$n().track_event(n,Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName,type:de.EVENT_NAMES[t].TYPE},e.campaignContext))},qn=(e,t)=>{$n().track_event(de.EVENT_NAMES[t].DELIVERED,Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName,type:de.EVENT_NAMES[t].TYPE},e.campaignContext))},$n=()=>{var e=window.moengage_object||"Moengage";return window[e]};class Jn{static isValid(e,t){return!Jn.isCampaignExpired(e)&&Jn.isCampaignActive(e)&&Jn.isUserInCampaignSegment(e)&&Jn.isCampaignWithinFC(e,t)}static isCampaignExpired(e){return(new Date).getTime()>new Date(e.expiryTime).getTime()}static isValidMessagingCampaign(e,t,n,i,a){return Jn.canCampaignBeRenderedOverExisting(e,a.length)&&Jn.hasCampaignClearedSelfDelay(e,t)&&Jn.hasCampaignClearedGlobalDelay(e,n,i)}static isCampaignActive(e){var t=Jn.baseLogTag+".isValid";return e.status===Hn.ACTIVE||(We.warn(1,t,`Campaign ${e.campaignId} : Status is `+e.status),!1)}static isUserInCampaignSegment(e){var t=Jn.baseLogTag+".isValid";return!!e.userInSegment||(We.warn(1,t,`Campaign ${e.campaignId} : User is not in segment`),!1)}static isCampaignWithinFC(e,t){var n=Jn.baseLogTag+".isValid";if([Gn.SELF_HANDLED].indexOf(e.templateType)<0){var i=Le(e,"delivery.fc_meta.count",0);if(0<i){var a=Le(t,"impressions",0);if(null!=t)return!(i<=a&&(We.warn(1,n,`Campaign ${e.campaignId} : FC reached. ${t.impressions} times shown`),1))}}return!0}static hasCampaignClearedGlobalDelay(e,t,n){var i=Jn.baseLogTag+".isValid",a=Le(e,"delivery.fc_meta.ignore_global_delay",!1);try{if(!a){const a=new Date;if(n){var r=(a.getTime()-new Date(n).getTime())/1e3;if(t&&r<=t)return We.remoteLogTracking(1,"info",i,`Can't render ${e.campaignId} as last global campaign was rendered ${r} seconds ago.`),!1}}}catch(e){return We.error(1,i,"Error checking global delay:",e),!1}return!0}static hasCampaignClearedSelfDelay(e,t){var n=Jn.baseLogTag+".hasCampaignClearedSelfDelay",i=Le(e,"delivery.fc_meta.delay",0);try{if(0<i&&null!=t&&t.lastImpression){var a=t.lastImpression,r=((new Date).getTime()-new Date(a).getTime())/1e3;if(r<=Le(e,"delivery.fc_meta.delay",0))return We.warn(1,n,`Can't render ${e.campaignId} as it was rendered ${r} seconds ago.`),!1}}catch(t){return We.error(1,n,"Can't check self delay for "+e.campaignId,t),!1}return!0}static doCampaignPayloadHasMandatoryParams(e){var{payload:t,payloadType:n,htmlJsonPayload:e}=e;return!(!t&&!e||!n)}static canCampaignBeRenderedOverExisting(e,t){var n=Jn.baseLogTag+".canCampaignBeRenderedOverExisting";return!(0<t&&!e.display.config.showOverOtherCampaigns&&(We.warn(1,n,`Can not show ${e.campaignId} over other existing campaigns`),1))}static comparator(e,t){return t.delivery.priority>e.delivery.priority||!(t.delivery.priority<e.delivery.priority)&&t.updatedTime>e.updatedTime?1:-1}}Jn.baseLogTag="CampaignUtils";const Xn=e=>Kn(void 0,void 0,void 0,(function*(){var t=e.map((e=>Bn.campaingsStatsStore.getItem(e.campaignId)));let n;try{n=yield Promise.all(t);const i=e.filter(((e,t)=>Jn.isValid(e,n[t])));return i.sort(Jn.comparator)}catch(t){return We.error(1,"filterAndSortCampaigns","Error filtering and sorting campaigns: ",t),[]}}));class Qn{}Qn.REMOVE_TRAIL_CHARS=/[^\w\s]+$/gi;const Zn=e=>{var t;null!==(t=null===(t=e.primaryEventsHash)||void 0===t?void 0:t.MOE_PAGE_SCROLL)&&void 0!==t&&t.length&&window.removeEventListener("scroll",e.getScrollListenerCallback())},ei=e=>{Object.keys(e.campaignRenderMap).forEach((t=>{document.getElementById("moe-onsite-campaign-"+t)&&document.getElementById("moe-onsite-campaign-"+t).remove(),e.campaignRenderMap[t].isActive()&&e.dismissInapp(t),clearTimeout(e.campaignRenderMap[t].delayTimer),delete e.campaignRenderMap[t],e.campaignRenderOrder=e.campaignRenderOrder.filter((e=>e!==t))}))},ti=e=>{setTimeout((()=>{e&&(dt()?e.windowEventManager.isPopStateEventBound&&(e.windowEventManager.setHistoryState(),e.windowEventManager.isExitIntentShown=!1,e.windowEventManager.scrollExitIntentInterval=null):document.removeEventListener("mouseout",e.windowEventManager.exitIntentListener))}),0)},ni=(e,t)=>{const n=Le(e,"triggerData.primary_condition.included_filters",null);return(null==n?void 0:n.filter_operator)===Fn.OR&&-1<(null==n?void 0:n.filters.findIndex((e=>e.action_name===t)))},ii=e=>Kn(void 0,void 0,void 0,(function*(){var t=yield Bn.exitIntentCampaignStore.getItem(e.campaignId);if(t)return t.error?t:(e.onsitePayload=t,We.log(1,"getPrefetchedCampaign","Prefetched exit intent campaign found: "+e.campaignId),e)})),ai=e=>Kn(void 0,void 0,void 0,(function*(){try{return yield Bn.campaingsMetaStore.getItem(e)}catch(e){return We.error(2,"getCampaignById","Error getting campaign from store: ",e),null}})),ri=()=>new Promise((e=>{setTimeout((()=>Kn(void 0,void 0,void 0,(function*(){const t=[];yield Bn.campaingsMetaStore.iterate((e=>{t.push(e)})),e(t)}))),0)})),oi=e=>null===(e=Le(e,"triggerData.secondary_condition.included_filters.filters"))||void 0===e?void 0:e.length,si=e=>"moe-onsite-campaign-"+e;function li(e){var t,n;e.detail.name===j.PAGE_CHANGED&&(window.Moengage.pageChangeHandlerCallingTime=(new Date).getTime(),window.MoeFocusHandler&&window.MoeFocusHandler(),(()=>{var e;if(null!==(e=$n())&&void 0!==e&&e.onsite){const e=$n().onsite,{triggerManager:t,displayManager:n,sendDelayCampaignStats:i,funnelManager:a}=e;n&&(i(n,a),ei(n)),t&&(Zn(t),ti(t)),Ea.onScrollOrExitIntentCampaigns={},Ht.resetListeners(),e.initializationPomise=null,e.selfHandledWebpTriggerListeners={},e.initialize&&e.initialize()}})(),window.Moengage.shouldClearPrevEvents=(new Date).getTime(),e=(null===(t=$n())||void 0===t?void 0:t.onsite).triggerManager,0<(null===(t=null==e?void 0:e.exitIntentCampaigns)||void 0===t?void 0:t.length)&&dt()&&null!==(n=null==e?void 0:e.windowEventManager)&&void 0!==n&&n.onMobileScrollAndExit(e.onExit))}class di{constructor(e,t,n,i){this.dataType=e,this.availableOperations=t,this.event=n,this.filter=i}validate(){return!(this.availableOperations.indexOf(this.filter.operator)<0)}checkEq(){let e=!1;return this.event.attributes.forEach((t=>{let n=t.value,i=this.filter.value;this.dataType===Un.STRING&&typeof n===Un.STRING&&(n=this.removeSpecialChars(n),i=this.removeSpecialChars(i)),t.key===this.filter.name&&(this.dataType!==Un.STRING||this.filter.case_sensitive?n===i&&(e=!0):n.toLowerCase()===i.toLowerCase()&&(e=!0))})),e}checkExists(){let e=!1;return this.event.attributes.forEach((t=>{t.key===this.filter.name&&(e=!0)})),e}removeSpecialChars(e){return e.replace(Qn.REMOVE_TRAIL_CHARS,"")}}(kn=Un=Un||{}).BOOL="bool",kn.STRING="string",kn.DATE="datetime",kn.NUMBER="double",kn.LONG="long",kn.ARRAY_BOOL="array_bool",kn.ARRAY_NUMBER="array_double",kn.ARRAY_STRING="array_string",kn.ARRAY_DATETIME="array_datetime",kn.OBJECT="object",(kn=Wn=Wn||{}).ALLOF="all_of",kn.ANYOFF="any_of";const ci=["is","exists","contains","startsWith","endsWith","in","containsInTheFollowing","startsWithInTheFollowing","endsWithInTheFollowing"];class ui extends di{constructor(e,t){super(Un.STRING,ci,e,t)}evaluate(){ui.baseLogTag;let e=!1;var t=this.event.attributes.filter((e=>e.key===this.filter.name)),n=0<t.length?t[0]:null;if(null!=n&&jt(n.value))switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"contains":case"containsInTheFollowing":e=this.checkContains(n);break;case"startsWith":case"startsWithInTheFollowing":e=this.checkStartsWith(n);break;case"endsWith":case"endsWithInTheFollowing":e=this.checkEndsWith(n);break;case"in":e=this.checkIn(n)}return this.filter.negate?!e:e}checkContains(e){var t=t=>this.filter.case_sensitive?0<=e.value.indexOf(t):0<=e.value.toLowerCase().indexOf(t.toLowerCase());return Array.isArray(this.filter.value)?this.filter.array_filter_type===Wn.ALLOF?this.checkInTheFollowing(t).every((e=>!0===e)):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkStartsWith(e){var t=t=>{var n=(e,t)=>e.substr(0,t.length)===t;return this.filter.case_sensitive?n(e.value,t):n(e.value.toLowerCase(),t.toLowerCase())};return Array.isArray(this.filter.value)?this.filter.array_filter_type===Wn.ALLOF?this.checkInTheFollowing(t).every((e=>!0===e)):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkEndsWith(e){var t=t=>{var n=(e,t,n)=>((void 0===n||n>e.length)&&(n=e.length),e.substring(n-t.length,n)===t);if(this.filter.case_sensitive)return n(e.value,t);const i=this.removeSpecialChars(e.value),a=this.removeSpecialChars(t);return n(i.toLowerCase(),a.toLowerCase())};return Array.isArray(this.filter.value)?this.filter.array_filter_type===Wn.ALLOF?this.checkInTheFollowing(t).every((e=>!0===e)):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkIn(e){let t=!1;if(Array.isArray(this.filter.value))for(let n=this.filter.value.length-1;0<=n;n--)if(this.filter.case_sensitive){if(this.filter.value[n]===e.value){t=!0;break}}else if(this.filter.value[n].toLowerCase()===e.value.toLowerCase()){t=!0;break}return t}checkInTheFollowing(e){return this.filter.value.map((t=>e(t)))}}ui.baseLogTag="StringDataType";const gi=["is","exists"];class mi extends di{constructor(e,t){super(Un.BOOL,gi,e,t)}evaluate(){let e=!1;switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists()}return this.filter.negate?!e:e}}mi.baseLogTag="BooleanDataType";const pi=["is","exists","greaterThan","lessThan","between","in"];class hi extends di{constructor(e,t){super(Un.NUMBER,pi,e,t)}evaluate(){hi.baseLogTag;let e=!1;var t=this.event.attributes.filter((e=>e.key===this.filter.name)),n=0<t.length?t[0]:null;if(null!=n&&"number"==typeof n.value)switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"greaterThan":e=this.checkGreaterThan(n);break;case"lessThan":e=this.checkLessThan(n);break;case"between":e=this.checkBetween(n);break;case"in":e=this.checkIn(n)}return this.filter.negate?!e:e}checkGreaterThan(e){return e.value>this.filter.value}checkLessThan(e){return e.value<this.filter.value}checkBetween(e){return this.filter.value2?this.filter.value&&this.filter.value2&&this.filter.value<=e.value&&e.value<this.filter.value2:this.filter.value&&this.filter.value1&&this.filter.value<=e.value&&e.value<this.filter.value1}checkIn(e){return Array.isArray(this.filter.value)&&0<=this.filter.value.indexOf(e.value)}}hi.baseLogTag="NumberDataType";const vi=["exists","on","between","before","after","inTheLast","inTheNext","today"];class fi extends di{constructor(e,t){!Yt(t.value)&&jt(t.value)&&(t.value=new Date(t.value.split("Z").join(""))),!Yt(t.value2)&&jt(t.value2)&&null!=t.value2&&(t.value2=new Date(t.value2.split("Z").join(""))),!Yt(t.value1)&&jt(t.value1)&&null!=t.value1&&(t.value1=new Date(t.value1.split("Z").join(""))),super(Un.DATE,vi,e,t)}evaluate(){fi.baseLogTag;let e=!1;var t=this.event.attributes.filter((e=>e.key===this.filter.name));const n=0<t.length?t[0]:null;if(null!=n)switch(n.value.setHours(0,0,0,0),this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"on":e=this.checkOn(n);break;case"between":e=this.checkBetween(n);break;case"before":e=this.checkBefore(n);break;case"after":e=this.checkAfter(n);break;case"inTheLast":e=this.checkLastX(n);break;case"inTheNext":e=this.checkNextX(n);break;case"today":e=this.checkToday(n)}return this.filter.negate?!e:e}checkOn(e){return e.value.setHours(0,0,0,0)===this.filter.value.setHours(0,0,0,0)}checkBetween(e){return this.filter.value2?this.filter.value.getTime()<=e.value.getTime()&&e.value.getTime()<this.filter.value2.getTime():this.filter.value.getTime()<=e.value.getTime()&&e.value.getTime()<this.filter.value1.getTime()}checkBefore(e){const{value:t}=this.filter;return typeof t===he?((new Date).setHours(0,0,0,0)-e.value.setHours(0,0,0,0))/864e5>t:e.value.setHours(0,0,0,0)<t.setHours(0,0,0,0)}checkAfter(e){const{value:t}=this.filter;return typeof t===he?(e.value.setHours(0,0,0,0)-(new Date).setHours(0,0,0,0))/864e5>t:e.value.setHours(0,0,0,0)>t.setHours(0,0,0,0)}checkLastX(e){var t=(new Date).setHours(0,0,0,0);return 0<t-(e=e.value.setHours(0,0,0,0))&&(t-e)/864e5<=this.filter.value}checkNextX(e){var t=(new Date).setHours(0,0,0,0);return 0<(e=e.value.setHours(0,0,0,0))-t&&(e-t)/864e5<=this.filter.value}checkToday(e){return e.value.setHours(0,0,0,0)===(new Date).setHours(0,0,0,0)}}fi.baseLogTag="DateTimeDataType";const Si=["is","exists","contains","startsWith","endsWith","in","lessThan","greaterThan","between","inTheLast","inTheNext","after","before","on","today"];class Ei extends di{constructor(e,t){super(t.data_type,Si,e,t)}evaluate(){let e=!1;var t=this.event.attributes.filter((e=>e.key===this.filter.name));return null!=(t=0<t.length?t[0]:null)&&(e=>Array.isArray(e))(t.value)&&(e=this.filter.array_filter_type&&this.filter.array_filter_type===Wn.ANYOFF?this.checkAnyOf(t):this.checkAllOf(t)),e}checkAllOf(e){return e.value.every((t=>this.getFilterResult(t,e)))}checkAnyOf(e){return e.value.some((t=>this.getFilterResult(t,e)))}getFilterResult(e,t){let n=!1;e=this.createCustomEvent(t.key,e);const i=this.getDataType(e);return i.validate()&&(n=i.evaluate()),n}createCustomEvent(e,t){return t=new yt(e,t),new cn(this.event.name,[t])}getDataType(e){let t;switch(this.filter.data_type){case Un.ARRAY_BOOL:t=new mi(e,this.filter);break;case Un.ARRAY_DATETIME:t=new fi(e,this.filter);break;case Un.ARRAY_NUMBER:t=new hi(e,this.filter);break;case Un.ARRAY_STRING:t=new ui(e,this.filter)}return t}}class yi{constructor(e,t){this.event=e,this.filter=t}evaluate(){let e;var t=this.event.attributes.filter((e=>e.key===this.filter.name));const n=0<t.length?t[0]:null;if(!n)return!1;var i=this.filter.filters.map((e=>{if("exists"===e.operator){var t=(null==e?void 0:e.name)in(null==n?void 0:n.value);return e.negate?!t:t}return(null==e?void 0:e.name)in(null==n?void 0:n.value)&&(t=new yt(e.name,n.value[e.name]),t=new cn(e.name,[t]),bi.doesEventMatchFilters(t,e))})),a=this.filter.filter_operator;e=(null==i?void 0:i[0])||!1;for(let t=1;t<i.length;t++)if(a===Fn.AND){if(e=e&&i[t],!1===e)break}else if(a===Fn.OR&&(e=e||i[t],!0===e))break;return e}}class bi{static doesEventMatchFilters(e,t){bi.baseLogTag;let n=!1,i=null;switch(t.data_type){case Un.BOOL:i=new mi(e,t),i.validate()&&(n=i.evaluate());break;case Un.STRING:i=new ui(e,t),i.validate()&&(n=i.evaluate());break;case Un.NUMBER:case Un.LONG:i=new hi(e,t),i.validate()&&(n=i.evaluate());break;case Un.DATE:i=new fi(e,t),i.validate()&&(n=i.evaluate());break;case Un.OBJECT:i=new yi(e,t),n=i.evaluate();break;case Un.ARRAY_STRING:case Un.ARRAY_DATETIME:case Un.ARRAY_BOOL:case Un.ARRAY_NUMBER:i=new Ei(e,t),i.validate()&&(n=i.evaluate())}return n}static doesValueMatchFilter(e,t){return e=new yt(t.name,e),e=new cn("Sample event",[e]),bi.doesEventMatchFilters(e,t)}}bi.baseLogTag="TriggerEvaluator";class _i{constructor(e){var t=_i.baseLogTag+".constructor";this.campaignId=Le(e,"campaign_id",null),this.campaignName=Le(e,"campaign_name",null),this.templateType=Le(e,"template_type",null),this.campaignContext=Le(e,"campaign_context",null);var n=Le(e,"status",null);const i=[Hn.ACTIVE,Hn.EXPIRED,Hn.PAUSED];i.indexOf(n)<0?this.status=Hn.ACTIVE:this.status=i[i.indexOf(n)],this.tag=Le(e,"tag",null),this.triggerData=null,Ti.validate(Le(e,"trigger"))?this.triggerData=new Ti(Le(e,"trigger")):We.log(2,t,"Rejecting trigger data for :",e),this.expiryTime=Lt(Le(e,"expiry_time")+"Z"),this.updatedTime=Lt(Le(e,"updated_time")+"Z"),this.delivery=new Pi(Le(e,"delivery")),this.userInSegment=Le(e,"user_in_segment",!0),n=Le(e,"display",this.display=null),t=Le(e,"display_filter",null),this.templateType!==Gn.SELF_HANDLED&&(null!=t?this.display=new Ri({rules:{uri_filters:t}},this.templateType):null!=n&&(this.display=new Ri(n,this.templateType))),this.stats={},this.onsitePayload=null,this.editorVersion=Le(e,"editor_version",null)}static isValidMetaJSON(e){_i.baseLogTag;let t=!0;var n=["campaign_id","campaign_name","template_type","status","expiry_time","updated_time","delivery","user_in_segment"];for(let i=0;i<n.length;i++)if(null==e[n[i]]){t=!1;break}return t}static getTriggerEvent(e,t,n){const i=Le(t,`triggerData.${n}_condition.included_filters`,null);return null==i?void 0:i.filters.filter((t=>t.action_name===e||t.action_name===w&&"MOE_EXIT"===e))}static areFiltersAbsent(e){return!(null==e||!e.action_name||null!==(e=null==e?void 0:e.attributes)&&void 0!==e&&e.filters)}static getFilters(e){return(null==e?void 0:e.action_name)&&(null===(e=null==e?void 0:e.attributes)||void 0===e?void 0:e.filters)||null}static getFilterOperator(e){return(null==e?void 0:e.action_name)&&(null===(e=null==e?void 0:e.attributes)||void 0===e?void 0:e.filterOperator)||Fn.AND}static isTriggered(e,t,n,i){let a=!0;if(0<(null==t?void 0:t.length)){let o;o=i||_i.getFilterOperator(n);var r=t.map((t=>bi.doesEventMatchFilters(e,t)));a=r[0]||!1;for(let e=1;e<r.length;e++)if(o===Fn.AND){if(a=a&&r[e],!1===a)break}else if(o===Fn.OR&&(a=a||r[e],!0===a))break}return a}static getFilterResult(e,t){return this.didPrimaryEventFilterTrigger(e,t)&&this.getURLFilterResult(t)}static didPrimaryEventFilterTrigger(e,t){var n=this.getTriggerEvent(e.name,t,"primary");for(let t=0;t<n.length;t++){var i=n[t],a=_i.getFilters(i);if(_i.areFiltersAbsent(i)||_i.isTriggered(e,a,i))return!0}return!1}static getURLFilterResult(e){var t=new cn(O,[]);const n=_i.getTriggerEvent(t.name,e,"url");if(n){var i=n.find((e=>e.action_name===O));return e=_i.getFilters(i),_i.isTriggered(t,e,i)}return!0}}_i.baseLogTag="OnsiteCampaignMeta";class Ti{constructor(e){this.cs_id=e.cs_id,this._id=e._id,this.references=e.references,this.trigger_wait_time=e.trigger_wait_time||null,Ai.validate(e.primary_condition)?this.primary_condition=new Ai(e.primary_condition):this.primary_condition=null,Ai.validate(e.secondary_condition)?this.secondary_condition=new Ai(e.secondary_condition):this.secondary_condition=null,Ai.validate(e.url_condition)?this.url_condition=new Ai(e.url_condition):this.url_condition=null,this.description=e.description,null!=e.trigger_delay?this.trigger_delay=new Ii(e.trigger_delay):this.trigger_delay=null}static validate(e){let t=!1;return["primary_condition"].forEach((n=>{null!=Le(e,n,null)&&(t=!0)})),t}}class Ii{constructor(e){if(this.delay=Le(e,"delay",0),this.unit=Le(e,"unit","seconds"),this.delay_type=Le(e,"delay_type",""),this.attribute=Le(e,"attribute",""),Le(e,"delay",null)&&Le(e,"unit",null)){let e=this.delay;"minutes"!==this.unit&&"hours"!==this.unit&&"days"!==this.unit||(e*=60),"hours"!==this.unit&&"days"!==this.unit||(e*=60),"days"===this.unit&&(e*=24),this.delayInSeconds=e}else this.delayInSeconds=0}}class Ai{constructor(e){this.included_filters=new wi(Le(e,"included_filters",null)),this.excluded_filters=new wi(Le(e,"excluded_filters",null))}static validate(e){return!!(e&&(e=e.included_filters)&&Array.isArray(e.filters)&&e.filters.length&&null!=e.filter_operator)}}class wi{constructor(e){this.filter_operator=Le(e,"filter_operator",Fn.AND),this.filters=null===(e=Le(e,"filters",[]))||void 0===e?void 0:e.map((e=>new Di(e)))}}class Di{constructor(e){const t=Le(e,"action_name",null);"string"==typeof t&&(t.includes("．")?this.action_name=Rt(t):this.action_name=t);var n=Le(e,"executed",null);"boolean"==typeof n&&(this.executed=n),this.filter_type=Le(e,"filter_type",null),n=Le(e,"attributes",null),Oi.validateJson(n)&&(this.attributes=new Oi(n)),"nested_filters"===this.filter_type&&(this.filters=new wi(e))}}class Oi{constructor(e){this.filters=[],this.filterOperator=Le(e,"filter_operator",Fn.AND),this.filters=Le(e,"filters",[]),this.filters.length&&this.filters.forEach((e=>{var t;null!==(t=null==e?void 0:e.name)&&void 0!==t&&t.includes("．")&&(e.name=Rt(e.name))}))}static validateJson(e){if(null==e)return!1;var t=["filters"];for(let n=0;n<t.length;n++)if(null==e[t[n]])return!1;return!0}}(kn=Hn=Hn||{}).ACTIVE="ACTIVE",kn.PAUSED="PAUSED",kn.EXPIRED="EXPIRED",(kn=Fn=Fn||{}).AND="and",kn.OR="or";class Pi{constructor(e){this.priority=Le(e,"priority",0),this.dismiss_interval=Le(e,"dismiss_interval",0),this.fc_meta=new Ni(Le(e,"fc_meta",null))}}class Ni{constructor(e){this.count=0,this.delay=0,this.ignore_global_delay=!1,null!=e&&(this.count=Le(e,"count",0),this.delay=Le(e,"delay",0),this.ignore_global_delay=Le(e,"ignore_global_delay",!1))}}class Ci{constructor(e){this.aggregations=[],this.filters=[],this.aggregations=Le(e,"aggregations",[]),this.filter_operator=Le(e,"filter_operator",Fn.AND),this.filters=Le(e,"filters",[])}}class Ri{constructor(e,t){this.config={blocking:Le(e,"config.blocking",Ri.getDefaultValue("blocking",t)),pushPage:Le(e,"config.push_page",Ri.getDefaultValue("push_page",t)),sticky:Le(e,"config.sticky",Ri.getDefaultValue("sticky",t)),scrollable:Le(e,"config.scrollable",Ri.getDefaultValue("scrollable",t)),showOverOtherCampaigns:Le(e,"config.show_over_campaigns",Ri.getDefaultValue("show_over_campaigns",t))},this.rules={uriFilters:new Ci(Le(e,"rules.uri_filters",{}))}}static getDefaultValue(e,t){return{blocking:{POP_UP:!0,BANNER:!1},push_page:{POP_UP:!1,BANNER:!0},sticky:{POP_UP:!1,BANNER:!0},scrollable:{POP_UP:!1,BANNER:!0},show_over_campaigns:{POP_UP:!1,BANNER:!1}}[e][t]}}(kn=Gn=Gn||{}).SELF_HANDLED="SELF_HANDLED",kn.SELF_HANDLED_OSM="SELF_HANDLED_OSM",kn.POP_UP="POP_UP",kn.BANNER="BANNER";class Li{constructor(e){this.templateType=Le(e,"template_type",null),this.payloadType=Le(e,"payload_type",null),this.payload=Le(e,"payload",null),this.position=Le(e,"position",null),this.campaignContext=Le(e,"campaign_context",null),this.editorVersion=Le(e,"editor_version",null),this.htmlJsonPayload=JSON.parse(kt(Le(e,"html_json_payload",null))),this.updatedTime=Lt(Le(e,"updated_time")+"Z")}}var ki=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class Mi{constructor(t){this.appId=t.appId,this.store=e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:de.DATABASE_NAME,storeName:de.STORES.SERVICE_META.NAME}),this.host=t.baseDomainName}getUserSessionAttributes(){var e=function(){const e=new Date;return{day:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e.getDay()],hours:String(e.getHours()).padStart(2,"0")}}();const t=new zt;var n=ot(window.location.href);return Object.assign(Object.assign({},n),{USER_TYPE:1<t.getNumberOfSessions()?"Returning":"New",DAY_OF_THE_WEEK:e.day,TIME_OF_THE_DAY:e.hours})}getCampaignsMeta(){return ki(this,void 0,void 0,(function*(){var e=Mi.baseLogTag+".getCampaignsMeta";try{var t=yield this.getRequestOptions();const e=yield this.store.getItem(de.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME);var n=yield lt.post(this.host+de.API.META,Object.assign(Object.assign({},t),{postData:Object.assign(Object.assign({},t.postData),{campaign_ids:[],user_session_attributes:this.getUserSessionAttributes()}),last_fetch_time:e&&"object"==typeof e?e.toISOString():e}));this.store.setItem(de.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME,new Date),this.store.setItem(de.STORES.SERVICE_META.KEYS.UNIQUE_ID,t.queryParams.unique_id);const i=JSON.parse(n.responseText),a=[];return i.campaigns.forEach((e=>{_i.isValidMetaJSON(e)&&a.push(new _i(e))})),{campaignsMeta:a,globalDelayBetweenInapps:Le(i,"min_delay_btw_inapps",0)}}catch(t){throw We.error(1,e,"Error getting meta for inapp: ",t),new Error("Could not get meta payload")}}))}getCampaignPayload(e,t){return ki(this,void 0,void 0,(function*(){var n=Mi.baseLogTag+".getCampaignPayload";let i;try{const n={contexts:["string"],campaign_context:e.campaignContext,user_session_attributes:this.getUserSessionAttributes()};if(t){const a={};for(let e=0;e<t.attributes.length;e++)a[t.attributes[e].key]=t.attributes[e].value;n.event={name:t.name,attributes:a,time:(new Date).toISOString()},i=yield lt.post(this.host+de.API.CAMPAIGN_PAYLOAD+e.campaignId,yield this.getRequestOptions(n))}else i=yield lt.post(this.host+de.API.CAMPAIGN_PAYLOAD+e.campaignId,yield this.getRequestOptions(n));return i=JSON.parse(i.responseText),i.code===de.GCG_ERROR_CODE&&(i={payload:i}),new Li(i)}catch(i){if(We.error(1,n,"Error geting payload",i),i.code&&(409===i.code||400===i.code)&&i.reason)return{error:!0,reason:JSON.parse(i.reason).description||""};throw new Error("Could not get payload for "+e.campaignId)}}))}getCampaignsPayload(e,t){return ki(this,void 0,void 0,(function*(){var n=Mi.baseLogTag+".getCampaignsPayload";let i;try{if(t){const n={};for(let e=0;e<t.attributes.length;e++)n[t.attributes[e].key]=t.attributes[e].value;var a={event:{name:t.name,attributes:n,time:(new Date).toISOString()},contexts:["string"],campaign_ids:e};i=yield lt.post(this.host+de.API.CAMPAIGNS_PAYLOAD,this.getRequestOptions(a))}else i=yield lt.post(this.host+de.API.CAMPAIGNS_PAYLOAD,this.getRequestOptions());const n=[];return JSON.parse(i.responseText).forEach((e=>{n.push(new Li(e))})),n}catch(i){throw We.error(1,n,"Error geting payload",i),new Error("Could not get payload for "+e)}}))}getDraftCampaign(e){return ki(this,void 0,void 0,(function*(){var t=Mi.baseLogTag+".getDraftCampaign";try{const t=yield this.getRequestOptions();t.queryParams=Object.assign({},t.queryParams,{locale:e.locale,variation:e.variation});var n=yield lt.post(this.host+de.API.DRAFT_CAMPAIGN_PAYLOAD+e.draftId,t);const i=JSON.parse(n.responseText);return"JSON"===i.payload_type&&(i.payload=JSON.parse(i.payload)),new Li(i)}catch(n){return We.error(1,t,"Error geting test campaign payload",n),null}}))}getRequestOptions(e={}){const t=Me();return St().then((n=>ki(this,void 0,void 0,(function*(){nt.get(s.USER_DATA);var n=yield function(){return Pt(this,void 0,void 0,(function*(){const e={};var t=pt.getIdentityMap(),n=yield function(){return Pt(this,void 0,void 0,(function*(){const e=yield Ot.get();var t=e.getAttribute(P)||"";return{uniqueId:e.deviceUuid,uid:t}}))}();return t&&(t.userIdentities&&(e.user_identities=t.userIdentities),t.previousIdentities&&(e.previous_identities=t.previousIdentities)),n.uid&&(e.uid=n.uid),{identifiers:e,uniqueId:n.uniqueId}}))}();if(!n.uniqueId)throw new Error("uniqueId not found in localStorage.");var i=dt()?"mweb":"web",a=ut();return{headers:{"Content-Type":"application/json","MOE-APPKEY":this.appId},queryParams:Object.assign({sdk_ver:t.getSdkVersion(),unique_id:null==n?void 0:n.uniqueId,os:i},a),postData:Object.assign(Object.assign({},e),{identifiers:n.identifiers})}})))).catch((e=>{throw new Error("Error in getting Web SDK Settings. This might indicate that the App is blocked.")}))}callStatsAPI(e,t){const n=Mi.baseLogTag+".callStatsAPI";this.getRequestOptions().then((t=>{var i=this.host+de.API.STATS;t.queryParams.app_id=t.headers["MOE-APPKEY"],delete t.queryParams.uid,i=st(i,t.queryParams),We.log(1,n,"[sendBeacon] payload: "+JSON.stringify(e)),t=new Blob([JSON.stringify(e)],{type:"text/plain;charset=UTF-8"}),navigator.sendBeacon(i,t)}))}}Mi.baseLogTag="OnsiteApi";class xi{constructor(){this.isExitIntentShown=!1,this.isPopStateEventBound=!1}onScroll(e){const t=xi.baseLogTag+".onScroll";null==e&&(e=()=>{});var n=xi.throttle((()=>{We.remoteLogTracking(1,"info",t,"Scrolled percent:",xi.getScrollPercent()),e(xi.getScrollPercent())}),de.SCROLL_CAMPAIGN_THROTTLING_TIME);return e(xi.getScrollPercent()),window.addEventListener("scroll",n),n}onMobileTabChange(e){const t=xi.baseLogTag+".onMobileTabChange";document.addEventListener("visibilitychange",(()=>{this.isExitIntentShown||"hidden"!==document.visibilityState||(We.log(1,t,"TRIGGERED: MOBILE EXIT INTENT"),e(),this.isExitIntentShown=!0)}))}onMobileBackHit(e){const t=xi.baseLogTag+".onMobileBackHit";setTimeout((()=>{this.isPopStateEventBound=!0,window.addEventListener("popstate",(n=>{!this.isExitIntentShown&&n.state&&"exit_intent"===n.state.moeIntent&&(We.log(1,t,"TRIGGERED: MOBILE EXIT INTENT"),e("onBackClick"),this.isExitIntentShown=!0)}))}),1e3),this.setHistoryState()}setHistoryState(){window.history.state&&"no_intent"===window.history.state.moeIntent||(window.history.replaceState(Object.assign(Object.assign({},window.history.state),{moeIntent:"exit_intent"}),""),window.history.pushState(Object.assign(Object.assign({},window.history.state),{moeIntent:"no_intent"}),""))}onMobileScrollAndExit(e){const t=xi.baseLogTag+".onMobileScrollAndExit",n=document.documentElement.offsetHeight;let i,a=xi.getScrollY();0<n&&(this.scrollExitIntentInterval=window.setInterval((()=>{let r=a-xi.getScrollY();r<0&&(r=0,a=xi.getScrollY()),i=xi.getScrollPercent()>de.EXIT_INTENT.CONFIG.SCROLL_DOWN_THRESHOLD,i&&r/n>de.EXIT_INTENT.CONFIG.SCROLL_UP_THRESHOLD/100&&(clearInterval(this.scrollExitIntentInterval),this.scrollExitIntentInterval=null,this.isExitIntentShown||(We.log(1,t,"TRIGGERED: MOBILE EXIT INTENT"),e(),this.isExitIntentShown=!0))}),de.EXIT_INTENT.CONFIG.SCROLL_INTERVAL))}mobileExitIntent(e){this.onMobileScrollAndExit(e),this.onMobileBackHit(e),this.onMobileTabChange(e)}onExit(e){const t=xi.baseLogTag+".onExit";dt()?this.mobileExitIntent(e):(this.exitIntentListener=n=>function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){var i=window.innerWidth,a=window.innerHeight;(n.clientY<0||n.clientX<0||n.clientY>=a||n.clientX>=i)&&(We.log(1,t,"TRIGGERED: EXIT INTENT"),e())})),document.addEventListener("mouseout",this.exitIntentListener,!1))}static getScrollPercent(){const e=window,t=document,n=t.documentElement,i=t.getElementsByTagName("body")[0],a=e.innerHeight||n.clientHeight||i.clientHeight;var r=document.body,o=document.documentElement;return a<(o=Math.max(r.scrollHeight,r.offsetHeight,o.clientHeight,o.scrollHeight,o.offsetHeight))?100*xi.getScrollY()/(o-a):100}static getScrollY(){let e=0;return"number"==typeof window.pageYOffset?e=window.pageYOffset:document.body&&document.body.scrollTop&&(e=document.body.scrollTop),e}static throttle(e,t){let n;return(...i)=>{n=n||window.setTimeout((()=>{n=null,e.apply(null,i)}),t)}}static setOnlineEventListner(e){window.addEventListener("online",e,{once:!0})}}xi.baseLogTag="WindowEventManager";var Bi=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class Ui{static getPendingSecondaryEventCampaign(e){return Bi(this,void 0,void 0,(function*(){return yield Bn.pendingSecondaryEvents.getItem(e)}))}static setPendingSecondaryEventCampaign(e,t){return Bi(this,void 0,void 0,(function*(){yield Bn.pendingSecondaryEvents.setItem(e,t)}))}static removePendingSecondaryEventCampaign(e){return Bi(this,void 0,void 0,(function*(){yield Bn.pendingSecondaryEvents.removeItem(e)}))}static getPendingSecondaryEventKeys(){return Bi(this,void 0,void 0,(function*(){return yield Bn.pendingSecondaryEvents.keys()}))}static getPendingTimerCampaign(e){return Bi(this,void 0,void 0,(function*(){return yield Bn.pendingTimerCampaigns.getItem(e)}))}static setPendingTimerCampaign(e,t){return Bi(this,void 0,void 0,(function*(){yield Bn.pendingTimerCampaigns.setItem(e,t)}))}static removePendingTimerCampaign(e){return Bi(this,void 0,void 0,(function*(){yield Bn.pendingTimerCampaigns.removeItem(e)}))}static getPendingTimerKeys(){return Bi(this,void 0,void 0,(function*(){return yield Bn.pendingTimerCampaigns.keys()}))}static getTriggeringPrimaryEvent(e){return Bi(this,void 0,void 0,(function*(){return yield Bn.triggeringPrimaryEvents.getItem(e)}))}static setTriggeringPrimaryEvent(e,t){return Bi(this,void 0,void 0,(function*(){yield Bn.triggeringPrimaryEvents.setItem(e,t)}))}static removeTriggeringPrimaryEvent(e){return Bi(this,void 0,void 0,(function*(){yield Bn.triggeringPrimaryEvents.removeItem(e)}))}static getTriggeringPrimaryEventKeys(){return Bi(this,void 0,void 0,(function*(){return yield Bn.triggeringPrimaryEvents.keys()}))}static removeCampaignFromStores(e){return Bi(this,void 0,void 0,(function*(){yield Ui.removePendingSecondaryEventCampaign(e),yield Ui.removePendingTimerCampaign(e)}))}}var Wi=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class Hi{static setListener(e){this.listener=e}static destroy(){this.listener=null,this.deliveryStats=null}static setDeliveryStats(e){this.deliveryStats=e}static createNewTimers(){return Wi(this,void 0,void 0,(function*(){var e=this.baseLogTag+".createNewTimers",t=yield Ui.getPendingTimerKeys();for(let a=0;a<t.length;a++){var n=t[a],i=(i=yield Ui.getPendingTimerCampaign(n)).timer-(Date.now()-i.startTime);We.log(1,e,`Creating new setTimeout with time: ${i} ms for the campaign: `+n),yield this.createPendingTimerCampaign(n,i)}}))}static deletePendingTimer(e){return Wi(this,void 0,void 0,(function*(){var t=this.baseLogTag+".deletePendingTimer",n=yield Ui.getPendingTimerCampaign(e);null!=n&&n.timerId&&(We.log(1,t,`There was an existing setTimeout associated to the campaign: ${e}. Clearing it`),clearTimeout(n.timerId))}))}static deleteAllPendingTimers(){return Wi(this,void 0,void 0,(function*(){var e=this.baseLogTag+".deleteAllPendingTimers";We.log(1,e,"Clearing all setTimeout's associated to different campaign(s)");var t=yield Ui.getPendingTimerKeys();for(let e=0;e<t.length;e++){var n=t[e];n=yield Ui.getPendingTimerCampaign(n),clearTimeout(n.timerId)}}))}static createPendingTimerCampaign(e,t){return Wi(this,void 0,void 0,(function*(){yield this.deletePendingTimer(e);var n=setTimeout((()=>Wi(this,void 0,void 0,(function*(){yield this.checkAndInvokeListener(e),yield Ui.removeCampaignFromStores(e)}))),t);n={startTime:Date.now(),timerId:n,timer:t},yield Ui.setPendingTimerCampaign(e,n)}))}static checkAndInvokeListener(e){return Wi(this,void 0,void 0,(function*(){var t=this.baseLogTag+".checkAndInvokeListener",n=yield ai(e);null!=n&&n.campaignId&&((yield this.isSatisfyingEventsArray(e))?_i.getURLFilterResult(n)&&(We.log(1,t,`Campaign ${e} satisfies the secondary_condition and the url_condition after timer has elapsed`),this.closeProximityTimerCampaigns.push(n),this.closeProximityCampaignsTimeout||(this.closeProximityCampaignsTimeout=setTimeout((()=>{this.listener(this.closeProximityTimerCampaigns),this.closeProximityTimerCampaigns=[],this.closeProximityCampaignsTimeout=null}),500))):(We.warn(1,t,`Campaign: ${e} does not satisfy secondary_condition after its timer has elapsed. Removing its entry from secondary stores`),this.deliveryStats.setStats(n,de.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(n,de.DELIVERY_FUNNEL.EVALUATION.CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED),this.deliveryStats.sendDeliveryStats([n])))}))}static checkIfPendingAction(e,t){return t===Fn.AND&&!e.events.some((e=>1===e.filters.length&&!e.filters[0].executed))}static isSatisfyingEventsArray(e){return Wi(this,void 0,void 0,(function*(){var t=yield Ui.getPendingSecondaryEventCampaign(e);if(null!=t&&t.events){if(!t.events.length)return!0;var n=t.operator;for(let e=0;e<t.events.length;e++){var i=t.events[e],a=i.operator;let r=!1,o=!1;for(let e=0;e<i.filters.length;e++)if(i.filters[e].executed){if(this.checkIfPendingAction(t,a))return!1;r=!0}else o=!0;if(n===Fn.AND&&a===Fn.OR&&r&&!o)return!1}return!0}return!1}))}static logDeliveryFunnelForExpiredTimerCampaigns(){return Wi(this,void 0,void 0,(function*(){var e=this.baseLogTag+".logDeliveryFunnelForExpiredTimerCampaigns",t=yield Ui.getPendingTimerKeys(),n=Date.now();const i=[];for(let o=0;o<t.length;o++){var a=t[o],r=yield Ui.getPendingTimerCampaign(a);n-r.startTime>=r.timer&&(yield this.isSatisfyingEventsArray(a))&&null!=(r=yield ai(a))&&r.campaignId&&(We.warn(1,e,`Campaign: ${a} contained 'has not executed' event(s) and had satisfied secondary_condition, but the website was closed when the timer elapsed`),i.push(r),yield this.deleteTimerAndRemoveFromStores(a))}this.sendUserNotOnAppStat(i)}))}static sendUserNotOnAppStat(e){var t;for(let t=0;t<e.length;t++){var n=e[t];this.deliveryStats.setStats(n,de.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(n,de.DELIVERY_FUNNEL.EVALUATION.CAMPAIGN_EVALUATION_USER_NOT_ON_APP)}null!==(t=this.deliveryStats)&&void 0!==t&&t.sendDeliveryStats(e)}static deleteTimerAndRemoveFromStores(e){return Wi(this,void 0,void 0,(function*(){yield this.deletePendingTimer(e),yield Ui.removeCampaignFromStores(e)}))}}Hi.baseLogTag="CampaignTimerManager",Hi.listener=null,Hi.deliveryStats=null,Hi.closeProximityTimerCampaigns=[],Hi.closeProximityCampaignsTimeout=null;var Fi=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class Gi{static setDeliveryStats(e){this.deliveryStats=e}static destroy(){this.deliveryStats=null}static createPendingSecondaryEvents(e,t){return Fi(this,void 0,void 0,(function*(){var n=this.baseLogTag+".createPendingSecondaryEvents";for(let o=0;o<e.length;o++){var i,a,r=e[o];oi(r)&&(({campaignEntry:i,isCampaignTimerSet:a}=this.constructCampaignEntry(r)),yield Ui.setTriggeringPrimaryEvent(r.campaignId,t),yield Ui.setPendingSecondaryEventCampaign(r.campaignId,i),a&&(We.log(1,n,`The campaign: ${r.campaignId} has at least one 'has not executed' secondary event. Starting timer for this campaign. Time remaining: ${i.time_left} ms`),yield Hi.createPendingTimerCampaign(r.campaignId,i.time_left)))}}))}static constructCampaignEntry(e){const t=e.triggerData.secondary_condition.included_filters,n={operator:t.filter_operator,events:[]};let i=!1;return t.filters.forEach((e=>{if("nested_filters"===e.filter_type){const t={operator:e.filters.filter_operator,filters:[]};e.filters.filters.forEach((e=>{t.filters.push(e),!1===e.executed&&(i=!0)})),n.events.push(t)}else{var t={operator:n.operator===Fn.AND?Fn.OR:Fn.AND,filters:[e]};n.events.push(t),!1===e.executed&&(i=!0)}})),n.updated_time=Date.now(),n.time_left=1e3*e.triggerData.trigger_wait_time.wait_period,{campaignEntry:n,isCampaignTimerSet:i}}static pruneRemovedCampaigns(){return Fi(this,void 0,void 0,(function*(){var e=this.baseLogTag+".pruneRemovedCampaigns";const t=(yield ri()).map((e=>e.campaignId));var n=yield Ui.getPendingSecondaryEventKeys();for(let a=0;a<n.length;a++){var i=n[a];t.includes(i)||(We.warn(1,e,`The campaign: $${i} is not present in the latest meta call. Removing its entry from secondary stores and removing any pending timer`),yield Hi.deleteTimerAndRemoveFromStores(i))}}))}static updateCampaignTimeInSecondaryEventsStore(){return Fi(this,void 0,void 0,(function*(){var e=this.baseLogTag+".updateCampaignTimeInSecondaryEventsStore",t=yield Ui.getPendingSecondaryEventKeys();const n=[];for(let r=0;r<t.length;r++){var i=t[r];const o=yield Ui.getPendingSecondaryEventCampaign(i);var a=Date.now();o.time_left-=a-o.updated_time,o.updated_time=a,o.time_left<=0?(null!=(a=yield ai(i))&&a.campaignId&&(We.warn(1,e,`Campaign: ${i} does not have time left to render. Removing its entry from secondary stores and clearing any setTimeout associated to it`),n.push(a)),yield Hi.deleteTimerAndRemoveFromStores(i)):yield Ui.setPendingSecondaryEventCampaign(i,o)}this.sendPathTimeExpiredStat(n)}))}static updatePendingSecondaryEventsHistory(e,t){return Fi(this,void 0,void 0,(function*(){var n=this.baseLogTag+".updatePendingSecondaryEventsHistory";const i=[],a=[],r=[];var o=Date.now();for(let m=0;m<t.length;m++){var s=t[m];const p=yield Ui.getPendingSecondaryEventCampaign(s);if(p)if(p.time_left-=o-p.updated_time,p.updated_time=o,p.time_left<=0){var l=yield ai(s);null!=l&&l.campaignId&&(We.warn(1,n,`Campaign ${s} which is associated to the event: ${e.name} does not have time left to render. Removing its entry from secondary stores and clearing any setTimeout associated to it`),r.push(l)),a.push(s)}else{var d=p.operator;for(let t=0;t<p.events.length;t++){const r=p.events[t];var c=r.operator;for(let t=0;t<r.filters.length;t++){const o=r.filters[t];var u=o.attributes,g=o.executed;e.name===o.action_name&&(u&&_i.isTriggered(e,u.filters,null,u.filterOperator)||!e.attributes||!e.attributes.length)&&(g?c===Fn.OR?(r.toBeRemoved=!0,d!==Fn.OR&&(d!==Fn.AND||p.events.length&&!p.events.every((e=>e.toBeRemoved)))||(We.log(1,n,`Campaign: ${s}, triggered by event: ${e.name}, is eligible for further processing`),i.push(s))):c===Fn.AND&&(o.toBeRemoved=!0,r.filters.every((e=>e.toBeRemoved))&&(r.toBeRemoved=!0,(d===Fn.OR||d===Fn.AND&&p.events.every((e=>e.toBeRemoved)))&&(We.log(1,n,`Campaign: ${s}, triggered by event: ${e.name}, is eligible for further processing`),i.push(s)))):c===Fn.OR?(o.toBeRemoved=!0,r.filters.every((e=>e.toBeRemoved))&&(d===Fn.AND||d===Fn.OR&&1===p.events.length?(We.warn(1,n,`The event: ${e.name} breaks secondary conditons of the campaign: ${s}. Removing the campaign from secondary stores and clearing any setTimeout associated to it`),a.push(s)):r.toBeRemoved=!0)):c===Fn.AND&&(r.toBeRemoved=!0,1===p.events.length&&p.events[0].toBeRemoved&&d===Fn.OR&&(We.warn(1,n,`The event: ${e.name} breaks secondary conditons of the campaign: ${s}. Removing the campaign from secondary stores and clearing any setTimeout associated to it`),a.push(s))))}}a.includes(s)||i.includes(s)||(yield this.updatePendingSecondaryEvents(s,p))}}return this.sendPathTimeExpiredStat(r),yield this.clearCampaignsData(a),yield this.clearCampaignsData(i),i}))}static sendPathTimeExpiredStat(e){for(let n=0;n<e.length;n++){var t=e[n];this.deliveryStats.setStats(t,de.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(t,de.DELIVERY_FUNNEL.EVALUATION.CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED)}this.deliveryStats.sendDeliveryStats(e)}static updatePendingSecondaryEvents(e,t){return Fi(this,void 0,void 0,(function*(){t.events=t.events.filter((e=>!e.toBeRemoved));for(let e=0;e<t.events.length;e++){const n=t.events[e];n.filters=n.filters.filter((e=>!e.toBeRemoved))}yield Ui.setPendingSecondaryEventCampaign(e,t)}))}static clearCampaignsData(e){return Fi(this,void 0,void 0,(function*(){for(let t=0;t<e.length;t++)yield Hi.deleteTimerAndRemoveFromStores(e[t])}))}static removeStaleTriggeringPrimaryEventCampaigns(){return Fi(this,void 0,void 0,(function*(){const e=this.baseLogTag+".removeStaleTriggeringPrimaryEventCampaigns",t=yield Ui.getTriggeringPrimaryEventKeys(),n=yield Ui.getPendingSecondaryEventKeys();t.forEach((t=>Fi(this,void 0,void 0,(function*(){n.includes(t)||(We.warn(1,e,`Campaign: ${t} does not exist in pendingSecondaryEvents store but exists in triggeringPrimaryEvents store. Removing it from triggeringPrimaryEvents store`),yield Ui.removeTriggeringPrimaryEvent(t))}))))}))}}Gi.baseLogTag="SecondaryEventsManager",Gi.deliveryStats=null;var Ki=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class Vi{constructor(e){this.primaryEventsHash={},this.secondaryEventsHash={},this.messagingCampaigns=[],this.scrollCampaigns=[],this.scrollCampaignTriggered=!1,this.exitIntentCampaigns=[],this.exitCampaignTriggered=!1,this.listener=null,this.historyManager=window[le],this.onEvent=e=>Ki(this,void 0,void 0,(function*(){var t=Vi.baseLogTag+".onEvent";try{null!=this.primaryEventsHash[e.name]&&(yield this.handlePrimaryEvent(e)),null!=this.secondaryEventsHash[e.name]&&(yield this.handleSecondaryEvent(e))}catch(e){We.error(1,t,"Error occurred during check event trigger campaigns: ",e)}})),this.onScroll=e=>Ki(this,void 0,void 0,(function*(){const t=Vi.baseLogTag+".onScroll";try{if(this.scrollCampaigns&&0<this.scrollCampaigns.length&&!this.scrollCampaignTriggered){var n=yield this.getCampaignsFromHash(D);const i=yield Xn(n);null!=i&&i.map((n=>Ki(this,void 0,void 0,(function*(){var i,a=null===(i=null===(a=null===(i=null===(a=null===(i=null==n?void 0:n.triggerData)||void 0===i?void 0:i.primary_condition)||void 0===a?void 0:a.included_filters)||void 0===i?void 0:i.filters[0])||void 0===a?void 0:a.attributes)||void 0===i?void 0:i.filters[0];a&&(i=new yt(a.name,a.value),i=yield cn.createEvent(D,[i]),_i.getFilterResult(i,n)&&e>a.value&&!this.scrollCampaignTriggered&&(this.scrollCampaignTriggered=!0,window.removeEventListener("scroll",this.scrollListenerCallback),We.log(1,t,"Triggered Scroll campaign"),this.trigger([n],i)))}))))}}catch(n){We.error(1,t,"Error occurred in triggering scroll campaigns ",n)}})),this.onExit=e=>Ki(this,void 0,void 0,(function*(){var t=Vi.baseLogTag+".onExit";try{if(0<this.exitIntentCampaigns.length&&!this.exitCampaignTriggered){const i=yield cn.createEvent("MOE_EXIT",[]);var n=(yield this.getCampaignsFromHash(w)).filter((e=>_i.getFilterResult(i,e)));n.length?(We.log(1,t,"Triggered Exit Intent campaign: ",n),this.trigger(n,i)):("onBackClick"===e&&window.history.back(),We.log(1,t,"No Exit Intent campaign is eligible."))}}catch(n){We.error(1,t,"Error occurred in triggering exit intent campaigns ",n)}})),this.messagingCampaigns=e,this.windowEventManager=new xi}onTrigger(e){this.listener=e}handlePrimaryEvent(e){return Ki(this,void 0,void 0,(function*(){var t=Vi.baseLogTag+".handlePrimaryEvent",n=this.primaryEventsHash[e.name];const i=[],a=[];for(let e=0;e<n.length;e++){var r=n[e];r=yield ai(r),oi(r)?i.push(r):Le(r,"triggerData.primary_condition.included_filters.filter_operator")===Fn.OR&&a.push(r)}var o=i.filter((t=>_i.didPrimaryEventFilterTrigger(e,t)));o.length&&(yield Gi.createPendingSecondaryEvents(o,e)),o=a.filter((t=>_i.getFilterResult(e,t))),o.length&&(We.log(1,t,`Campaigns triggered for event ${e.name}: `+o.length),this.trigger(o,e))}))}handleSecondaryEvent(e){return Ki(this,void 0,void 0,(function*(){var t=Vi.baseLogTag+".handleSecondaryEvent",n=yield Gi.updatePendingSecondaryEventsHistory(e,this.secondaryEventsHash[e.name]);let i=[];for(let e=0;e<n.length;e++)i.push(yield ai(n[e]));i=i.filter((e=>_i.getURLFilterResult(e))),i.length&&(We.log(1,t,`Campaigns triggered by secondary event "${e.name}": `+i.length),this.trigger(i))}))}getCampaignsFromHash(e){return Ki(this,void 0,void 0,(function*(){const t=[];var n=this.primaryEventsHash[e];if(null!=n&&n.length)for(let e=0;e<n.length;e++)t.push(yield ai(n[e]));return t}))}addEntryInEventsHash(e,t,n){null==e[t]&&(e[t]=[]),e[t].push(n)}createPrimaryEventsHash(e){const t=Le(e,"triggerData.primary_condition.included_filters.filters",[]);t&&t.forEach((t=>{this.addEntryInEventsHash(this.primaryEventsHash,t.action_name,e.campaignId)}))}createSecondaryEventsHash(e){const t=Le(e,"triggerData.secondary_condition.included_filters.filters",[]);null!=t&&t.forEach((t=>{"nested_filters"===t.filter_type?t.filters.filters.forEach((t=>{this.addEntryInEventsHash(this.secondaryEventsHash,t.action_name,e.campaignId)})):this.addEntryInEventsHash(this.secondaryEventsHash,t.action_name,e.campaignId)}))}startWatching(){return Ki(this,void 0,void 0,(function*(){Vi.baseLogTag,this.messagingCampaigns.forEach((e=>{this.createPrimaryEventsHash(e),this.createSecondaryEventsHash(e)})),this.historyManager&&(this.historyManager.getHistory().forEach(this.onEvent),this.historyManager.addEventListener(this.onEvent)),this.scrollCampaignTriggered=!1,this.scrollCampaigns=this.messagingCampaigns.filter((e=>ni(e,D))),0<this.scrollCampaigns.length&&(this.scrollListenerCallback=this.windowEventManager.onScroll(this.onScroll)),this.exitCampaignTriggered=!1,this.exitIntentCampaigns=this.messagingCampaigns.filter((e=>ni(e,w))),0<this.exitIntentCampaigns.length&&this.windowEventManager.onExit(this.onExit)}))}setScrollListenerCallback(e){this.scrollListenerCallback=e}getScrollListenerCallback(){return this.scrollListenerCallback}getWindowEventManager(){return this.windowEventManager}trigger(e,t){null!=this.listener&&this.listener(e,t)}destory(){this.listener=null}}Vi.baseLogTag="OnsiteTriggerManager";class ji{constructor(e,t){this.waitForDelay=null,this.delayTimer=null,this.iframe=null,this.onFrameLoad=new gt,this.active=!1,this.dismissInterval=null,this.isJSONPayloadApproach=!1,this.osmDivRendering=null,this.osmDivSelector=null,this.campaignRendered=!1,this.isActive=()=>this.active,this.campaignMeta=e,this.data=t,this.active=!1,this.campaignRendered=!1;const n=Le(e,"triggerData.trigger_delay.delayInSeconds",0)||0;this.waitForDelay=new Promise((e=>{this.delayTimer=setTimeout((()=>{this.campaignRendered=!0,e()}),1e3*n)}))}setIsActive(e){this.active=e}}const Yi={CENTER:{position:"absolute",top:"50%",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, -50%)"},CENTER_LEFT:{position:"absolute",top:"50%",left:"10px",bottom:"auto",right:"auto",transform:"translate(0,-50%)"},CENTER_RIGHT:{position:"absolute",top:"50%",right:"10px",bottom:"auto",left:"auto",transform:"translate(0,-50%)"},TOP_LEFT:{position:"absolute",top:"10px",left:"10px",bottom:"auto",right:"auto"},TOP_CENTER:{position:"absolute",top:"0",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, 0)"},TOP_RIGHT:{position:"absolute",top:"10px",right:"10px",bottom:"auto",left:"auto"},BOTTOM_LEFT:{position:"absolute",bottom:"10px",left:"10px",top:"auto",right:"auto"},BOTTOM_CENTER:{position:"absolute",left:"50%",bottom:"10px",top:"auto",right:"auto",transform:"translate(-50%, 0)"},BOTTOM_RIGHT:{position:"absolute",bottom:"10px",right:"10px",top:"auto",left:"auto"},TOP:{position:"absolute",top:"0",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, 0)"},BOTTOM:{position:"absolute",bottom:"0",top:"auto",right:"auto",left:"50%",transform:"translate(-50%, 0)"},LEFT:{position:"absolute",left:"0",bottom:"auto",right:"auto",top:"auto"},RIGHT:{position:"absolute",right:"0",bottom:"auto",left:"auto",top:"auto"}},zi=e=>{try{return!qi()&&window.Moengage.onsite.displayManager.campaignRenderMap[e].campaignMeta}catch(t){We.error(1,"OsmFunctions.getCampaignMeta","Campaign meta not found: "+e)}},qi=()=>!!window.Moengage.onsite.displayManager.testCampaign&&(We.log(1,"OsmFunctions.isTestCampaign","Test campaign element. No data will be sent to BE right now. We'll start tracking events once the campaign is live"),!0);function $i(){const e=Me();if(e)return e.accessibilityFocusTrap||(e.accessibilityFocusTrap={lastActiveElement:[],dismissOsmEventHandlers:{},keyboardTrapHandler:null,focusTrapStack:[],focusedElements:[]}),e.accessibilityFocusTrap}function Ji(e){const t=$i();t&&(t.keyboardTrapHandler=e)}function Xi(e){const t=$i();if(t){t.dismissOsmEventHandlers[e]&&Qi(e);var n=function(e,t){"Escape"===t.key&&(window.MoeOsm.trackDismiss(e),window.MoeOsm.dismissMessage(e))}.bind(null,e);t.dismissOsmEventHandlers[e]=n,window.addEventListener("keyup",n),e=si(e);const i=document.getElementById(e);i&&"IFRAME"===i.tagName&&i.contentWindow&&i.contentWindow.addEventListener("keyup",n)}}function Qi(e){const t=$i();if(t){var n=t.dismissOsmEventHandlers[e];if(n){window.removeEventListener("keyup",n);var i=si(e);const a=document.getElementById(i);a&&"IFRAME"===a.tagName&&a.contentWindow&&a.contentWindow.removeEventListener("keyup",n),delete t.dismissOsmEventHandlers[e]}}}function Zi(){const e=$i();if(e){const t=e.lastActiveElement.pop();((null==t?void 0:t.id)===Ce?t.contentDocument.getElementById(Re):t&&"function"==typeof t.focus?t:document.body).focus({preventScroll:!0})}}function ea(e,t,n=!1){var i=si(e);(i=document.getElementById(i))&&(Xi(e),function(e){if(e){const t=e.querySelector(".brz-popup2__preview");let n="A pop-up has appeared on screen",i="dialog";t&&(t.hasAttribute("aria-label")&&(n=t.getAttribute("aria-label"),t.removeAttribute("aria-label")),t.hasAttribute("role")&&(i=t.getAttribute("role"))),e.setAttribute("tabindex","0"),e.setAttribute("aria-label",n),e.setAttribute("role",i),e.setAttribute("aria-modal","true")}}(i),t===Gn.POP_UP?function(e,t=document,n=!1){const i=$i();if(i){const r=na(e)||e;if(r){!function(e){const t=$i();var n;t&&e&&e.parentElement&&(-1!==(n=t.focusTrapStack.indexOf(e))&&t.focusTrapStack.splice(n,1),t.focusTrapStack.push(e),aa())}(e);var a=r.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');if(0!==(null==a?void 0:a.length)){const o=a[0],s=a[a.length-1];ta(r,!0,n);let l=null;n=n=>{if("Tab"===n.key){let i=!1,a=t.activeElement;if("IFRAME"===e.tagName){const t=e.contentDocument;t&&t.activeElement&&(a=t.activeElement,i=a===t.body||t.body.contains(a))}else i=a===e||e.contains(a);return i?(a&&"moe-focus-trap-end"!==a.id&&(l=a),a&&"moe-focus-trap-end"===a.id?(n.preventDefault(),void(n.shiftKey?l||s:o).focus({preventScroll:!0})):void(n.shiftKey&&a===o?(n.preventDefault(),s.focus({preventScroll:!0})):n.shiftKey||a!==s||(n.preventDefault(),o.focus({preventScroll:!0})))):(n.preventDefault(),void e.focus({preventScroll:!0}))}},i.keyboardTrapHandler&&t.removeEventListener("keydown",i.keyboardTrapHandler),Ji(i.keyboardTrapHandler=n),t.addEventListener("keydown",i.keyboardTrapHandler)}else r.hasAttribute("tabindex")&&"-1"!==r.getAttribute("tabindex")&&r.focus({preventScroll:!0})}}}(i,document,n):ta(i,!1,n))}function ta(e,t=!1,n=!0){if(e){const a=$i();if(a)if(n&&function(e){const t=$i(),n=parseInt(window.getComputedStyle(e).zIndex,10)||0;t.focusedElements=t.focusedElements.filter((e=>document.body.contains(e))),t.focusedElements.forEach((e=>{var t=parseInt(window.getComputedStyle(e).zIndex,10)||0;t>=n&&(e.style.zIndex=(t-1).toString())})),t.focusedElements.push(e)}(e),0<a.focusTrapStack.length&&!t)a.lastActiveElement.push(e);else{var i=e.id===Ce;const r=na(e)||e;if(!(n=a.focusTrapStack)||0===n.length||t)if(document.activeElement&&document.activeElement instanceof HTMLElement&&a.lastActiveElement.push(document.activeElement),i){const t=e.contentDocument,n=null==t?void 0:t.getElementById(Re);n&&n.focus({preventScroll:!0})}else r&&(r.setAttribute("tabindex","0"),r.focus({preventScroll:!0}));else r&&a.lastActiveElement.push(e)}}}function na(e){if(e){let n=e;var t;return"IFRAME"===e.tagName&&(n=null!=(t=e.contentDocument)&&t.body?t.body:null!=t&&t.activeElement?t.activeElement:e),n}}function ia(e,t=document){const n=$i();if(n&&(function(e){const t=$i();t&&(e?-1!==(e=t.focusTrapStack.indexOf(e))&&t.focusTrapStack.splice(e,1):t.focusTrapStack.length=0,aa())}(e),n.keyboardTrapHandler&&(t.removeEventListener("keydown",n.keyboardTrapHandler),Ji(n.keyboardTrapHandler=null)),0<n.focusTrapStack.length)){const e=n.focusTrapStack[n.focusTrapStack.length-1];e&&"function"==typeof e.focus&&setTimeout((()=>{e.focus({preventScroll:!0})}))}}function aa(){if(t=$i()){document.querySelectorAll("[data-moe-prev-aria-hidden]").forEach((e=>{var t;e instanceof HTMLElement&&("false"===(t=e.getAttribute("data-moe-prev-aria-hidden"))?e.removeAttribute("aria-hidden"):"true"===t?e.setAttribute("aria-hidden","true"):"null"===t&&e.removeAttribute("aria-hidden"),e.removeAttribute("data-moe-prev-aria-hidden"))})),document.querySelectorAll("[data-moe-prev-tabindex]").forEach((e=>{var t;e instanceof HTMLElement&&(""===(t=e.getAttribute("data-moe-prev-tabindex"))?e.removeAttribute("tabindex"):e.setAttribute("tabindex",t),e.removeAttribute("data-moe-prev-tabindex"))}));const n=t.focusTrapStack[t.focusTrapStack.length-1];if(document.querySelectorAll('[role="dialog"][aria-modal="true"]').forEach((e=>{e instanceof HTMLElement&&e!==n&&(e.removeAttribute("role"),e.removeAttribute("aria-modal"))})),0!==t.focusTrapStack.length){const i=[];var e=["a[href]","button","input","select","textarea","[tabindex]",'[contenteditable="true"]'].join(","),t=n.parentElement;if(t){for(const a of Array.from(t.children))a!==n&&a instanceof HTMLElement&&(a.hasAttribute("data-moe-prev-aria-hidden")||(a.hasAttribute("aria-hidden")?a.setAttribute("data-moe-prev-aria-hidden",a.getAttribute("aria-hidden")):a.setAttribute("data-moe-prev-aria-hidden","null")),a.setAttribute("aria-hidden","true"),i.push(a),a.querySelectorAll(e).forEach((e=>{e.hasAttribute("data-moe-prev-tabindex")||(e.hasAttribute("tabindex")?e.setAttribute("data-moe-prev-tabindex",e.getAttribute("tabindex")):e.setAttribute("data-moe-prev-tabindex","")),e.setAttribute("tabindex","-1")})));n._ariaHiddenSiblings=i}}}}var ra=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};function oa(e,t,n,i,a){return ra(this,void 0,void 0,(function*(){const r=si(t),o=/moe-campaign-id/g;yield ra(this,void 0,void 0,(function*(){try{let c=e.root;const{styles:u,scripts:g}=e,m=document.createElement("div");m.id=r,n.parentNode.insertBefore(m,n);const p=document.querySelector("#"+r),h=new DOMParser;c=c.replace(o,t);var s=h.parseFromString(c,"text/html");yield function(e){return ra(this,void 0,void 0,(function*(){try{const t=e.getElementsByTagName("a");for(let e=t.length-1;0<=e;e--)""===t[e].getAttribute("href")&&t[e].removeAttribute("href")}catch(e){We.error(2,"InsertCustomHtmlJs.removeEmptyHrefTags","Error while removing Empty href attributes",e)}}))}(s),function(e){try{["trackEvent","trackClick","trackDismiss","dismissMessage","leadGenFormSubmit","fetchRatingValue"].forEach((n=>{!function(e,n){e.querySelectorAll("[onclick]").forEach((e=>{var i=e.getAttribute("onclick").replace(new RegExp(n+"\\((.*?)\\)","g"),((e,i)=>i?n+`('${t}',${i})`:n+`('${t}')`));e.setAttribute("onclick",i)}))}(e,n)}))}catch(e){We.error(2,"InsertCustomHtmlJs.addCampaignId","Error while adding Campaign Id",e)}}(s);const v=u.map((e=>h.parseFromString(e,"text/html").head.childNodes[0]));var l=g.map((e=>(e=e.replace(o,t),h.parseFromString(e,"text/html").head.childNodes[0]))),d=v.map((e=>new Promise(((t,n)=>{!function(e){const{node:t,onLoad:n,onError:i}=e;t instanceof HTMLMetaElement||"dns-prefetch"===t.getAttribute("rel")?n():(t.onload=()=>n(),t.onerror=()=>i()),document.querySelector("#"+r).appendChild(t)}({node:e,onLoad:t,onError:n})}))));yield Promise.all(d).catch((e=>{We.warn(1,"InsertCustomHtmlJs","Error loading Styles",(null==e?void 0:e.message)||"")}));const f=s.body.childNodes[0];p.appendChild(f),[...f.querySelectorAll(".brz-embed-code script")].map((e=>{!function(e){const t=document.createElement("script");t.innerHTML=e.innerHTML;for(let a=0;a<e.attributes.length;a++){var{name:n,value:i}=e.attributes[a];t.setAttribute(n,i)}e.replaceWith(t)}(e)})),function(e){return ra(this,void 0,void 0,(function*(){for(const n of e)yield function(e){return new Promise(((n,i)=>{const a=document.createElement("script");for(let n=0;n<e.attributes.length;n++){var o=e.attributes[n].name;let i=e.attributes[n].value;"src"===o&&(i.includes("typeform")||i.includes("tv-button"))&&(i=i+"?campaignId="+t),a.setAttribute(o,i)}a.src?(a.onload=n,a.onerror=i):(a.innerHTML=e.innerHTML,n()),document.querySelector("#"+r).appendChild(a)}))}(n)}))}(l).then((()=>{var e,n;window.Brz.emit("init.dom",window.jQuery(f)),We.log(1,"InsertCustomHtmlJs","Custom HTML/JS DOM Level OSM Insertion: "+r),e=t,n=i.templateType,e&&(Xi(e),window.Brz.on("elements.popup.open",ea.bind(null,e,n))),a&&a(i,"OSM")()})).catch((e=>{We.warn(1,"InsertCustomHtmlJs","Error loading script",(null==e?void 0:e.message)||"")}))}catch(e){We.error(2,"InsertCustomHtmlJs","Failed to Insert OSM into DOM: "+r)}}))}))}var sa=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class la{constructor(){this.renderListener=null,this.initializationPromiseObject=null,this.campaignRenderOrder=[],this.campaignRenderMap={},this.dismissTestInapp=e=>{ia(),Qi(e),Zi(),this.initialInlineBodyStyle?document.body.setAttribute("style",this.initialInlineBodyStyle):document.body.removeAttribute("style"),this.removeOSMPusher(),this.pushCardsTemplate(0),setTimeout((()=>{var t;return null===(t=document.getElementById("moe-onsite-campaign-"+e))||void 0===t?void 0:t.remove()}),0)},this.dismissInapp=e=>{if(ia(document.getElementById(si(e))),Zi(),Qi(e),0!==this.getActiveCampaigns().length){const t=this.getActiveCampaigns();setTimeout((()=>{t.forEach((t=>{var n;t.campaignMeta.campaignId===e&&(t.iframe?null!==(n=t.iframe)&&void 0!==n&&n.remove():null!==(t=t.osmDivSelector)&&void 0!==t&&t.remove())}))}),0),this.campaignRenderMap[e].setIsActive(!1),this.campaignRenderOrder=this.campaignRenderOrder.filter((t=>t!==e)),clearInterval(this.campaignRenderMap[e].dismissInterval),this.campaignRenderMap[e].delayTimer=null,this.renderAllActiveCampaigns()}else this.dismissTestInapp(e)},this.clickTracker=Vn,this.dismissEvent=zn,this.startInitialization(),this.initialInlineBodyStyle=document.body.getAttribute("style")}startInitialization(){return sa(this,void 0,void 0,(function*(){var e=la.baseLogTag+".startInitialization";try{null==this.initializationPromiseObject&&(this.initializationPromiseObject=new gt),this.initializationPromiseObject.res()}catch(t){We.error(1,e,"Error initializing display managaer:",t)}}))}getOSMPusher(e){const t=document.createElement("div");if(t.id=de.PUSH_BANNER,t.style.setProperty("display","block","important"),t.style.height=e+"px","FRAMESET"===document.body.nodeName){const e=document.head;e.parentNode.insertBefore(t,e)}else{const e=document.body.firstChild;e.parentNode.insertBefore(t,e)}return t}removeOSMPusher(){var e;null!==(e=document.getElementById(de.PUSH_BANNER))&&void 0!==e&&e.remove()}queueDraftCampaign(e,t){return sa(this,void 0,void 0,(function*(){var n=la.baseLogTag+".queueDraftCampaign";try{yield this.initializationPromiseObject.p,e.position=t.position,this.testCampaign=e;var i=!("1"!==t.editorVersion||!t.htmlJsonPayload);const a=!i&&la.createDefaultIframe(this.testCampaign.draftId,t.payload);let r;We.warn(1,n,"Going to render test campaign "+e.draftId),r="FRAMESET"===document.body.nodeName?this.getOSMPusher(0):document.body.firstChild,i?(yield oa(t.htmlJsonPayload,this.testCampaign.draftId,r,{templateType:e.templateType}),this.renderTestCampaign(e,a,t)):(r.parentNode.insertBefore(a,r),a.onload=()=>{a.contentWindow.postMessage({campaignId:e.draftId},"*"),"1"===t.editorVersion?this.handleBridgeInsertion(a.contentDocument,e.draftId):this.handleClassBasedTrackingForTestCampaign(a,t,e),this.renderTestCampaign(e,a),ea(e.draftId,e.templateType)})}catch(e){We.error(1,n,"Error queueing draft campaign",e)}}))}renderTestCampaign(e,t,n){return sa(this,void 0,void 0,(function*(){if(t){var i;t.style.visibility="hidden",t.style.display="block",t.style.zIndex="2147483647",e.displaySettings.config.blocking?(t.style.height=window.innerHeight+"px",t.style.width="100%"):(t.style.height=getComputedStyle(t.contentDocument.body).height,t.style.width=getComputedStyle(t.contentDocument.body).width,e.templateType===Gn.POP_UP&&(t.style.margin="0px auto"),-1<t.srcdoc.indexOf(de.POSITIONED_TEMPLATE)&&(i=-1<t.srcdoc.indexOf(de.SIDE_BANNER),this.adjustPositionOfCampaign(t.style,e.position,i))),t.style.visibility="visible",this.testCampaignPositionStyling(e,t),e.displaySettings.config.scrollable||(document.body.style.overflow="hidden")}else{const t=document.getElementById(si(e.draftId));t.style.zIndex="2147483647",this.testCampaignPositionStyling(e,t)}e.templateType===Gn.BANNER&&this.bannerTestCampaignStyling(e,t,n)}))}queueLiveCampaign(e,t){return sa(this,void 0,void 0,(function*(){var n,i=la.baseLogTag+".queueLiveCampaign";e.campaignContext=t.campaignContext,e.editorVersion=t.editorVersion;try{yield this.initializationPromiseObject.p,null==this.campaignRenderMap[e.campaignId]||!this.campaignRenderMap[e.campaignId].isActive()&&null===this.campaignRenderMap[e.campaignId].delayTimer?(this.campaignRenderOrder.push(e.campaignId),this.campaignRenderMap[e.campaignId]=new ji(e,t),this.campaignRenderMap[e.campaignId].isJSONPayloadApproach=!("1"!==t.editorVersion||!t.htmlJsonPayload),this.campaignRenderMap[e.campaignId].isJSONPayloadApproach?this.campaignRenderMap[e.campaignId].osmDivRendering=n=>oa(t.htmlJsonPayload,e.campaignId,n,e,jn):(n=la.createDefaultIframe(e.campaignId,this.campaignRenderMap[e.campaignId].data.payload),this.campaignRenderMap[e.campaignId].iframe=n),yield this.campaignRenderMap[e.campaignId].waitForDelay,(yield this.canCampaignBeRendered(e))?(We.warn(1,i,"Going to render "+e.campaignId),this.campaignRenderMap[e.campaignId].setIsActive(!0),null!=this.renderListener&&this.renderListener(e),this.renderAllActiveCampaigns()):We.warn(1,i,"Can not render "+e.campaignId)):We.warn(1,i,`Can not render ${e.campaignId}, as campaign is already Active.`)}catch(n){We.error(1,i,"Error queuing campaign "+e.campaignId,n)}}))}renderAllActiveCampaigns(){return sa(this,void 0,void 0,(function*(){var e,t=la.baseLogTag+".renderAllActiveCampaigns";const n=this.getActiveCampaigns();if(this.restoreBodyStyle(),0<n.length){for(let i=0;i<n.length;i++)if(n[i].isJSONPayloadApproach||"visible"!==n[i].iframe.style.visibility){if(null==document.getElementById(si(n[i].campaignMeta.campaignId))){let e;e="FRAMESET"===document.body.nodeName?this.getOSMPusher(0):document.body.firstChild,n[i].isJSONPayloadApproach?(yield n[i].osmDivRendering(e),n[i].onFrameLoad.res(),n[i].osmDivSelector=document.getElementById(si(n[i].campaignMeta.campaignId))):(e.parentNode.insertBefore(n[i].iframe,e),n[i].iframe.onload=()=>{da.setScrollState(n),n[i].iframe.contentWindow.postMessage({campaignId:n[i].campaignMeta.campaignId},"*"),"1"===n[i].campaignMeta.editorVersion?(this.handleBridgeInsertion(n[i].iframe.contentDocument,n[i].campaignMeta.campaignId,n[i].campaignMeta),this.changeAnchorTagReDirectionMethod(n[i].iframe)):this.handleClassBasedTracking(n[i]),n[i].onFrameLoad.res()})}yield n[i].onFrameLoad.p,n[i].isJSONPayloadApproach?(We.log(1,t,"zindex for "+n[i].campaignMeta.campaignId,2147483647..toString()),n[i].osmDivSelector.style.zIndex=(2147483647-(n.length-i-1)).toString(),this.liveCampaignPositionStyling(n[i].campaignMeta,n[i].osmDivSelector)):(n[i].iframe.style.visibility="hidden",n[i].iframe.style.display="block",We.log(1,t,"zindex for "+n[i].campaignMeta.campaignId,2147483647..toString()),n[i].iframe.style.zIndex=(2147483647-(n.length-i-1)).toString(),n[i].iframe.style.margin="0",n[i].campaignMeta.display.config.blocking?(n[i].iframe.style.height=window.innerHeight+"px",n[i].iframe.style.width="100%"):(n[i].iframe.style.height=getComputedStyle(n[i].iframe.contentDocument.body).height,n[i].iframe.style.padding.includes("10px")?n[i].iframe.style.width=parseInt(getComputedStyle(n[i].iframe.contentDocument.body).width)+20+"px":n[i].iframe.style.width=getComputedStyle(n[i].iframe.contentDocument.body).width,n[i].campaignMeta.templateType===Gn.POP_UP&&(n[i].iframe.style.margin="0px auto"),n[i].data.payload&&-1<n[i].data.payload.indexOf(de.POSITIONED_TEMPLATE)&&(e=-1<n[i].data.payload.indexOf(de.SIDE_BANNER),this.adjustPositionOfCampaign(n[i].iframe.style,n[i].data.position,e))),n[i].iframe.style.visibility="visible",this.liveCampaignPositionStyling(n[i].campaignMeta,n[i].iframe),jn(n[i].campaignMeta,"OSM")(),ea(n[i].campaignMeta.campaignId,n[i].campaignMeta.templateType)),null!=n[i].dismissInterval||0<(e=1e3*Le(n[i].campaignMeta,"delivery.dismiss_interval",0))&&(n[i].dismissInterval=setTimeout((()=>{const e=this.campaignRenderMap[n[i].campaignMeta.campaignId];e&&e.isActive()&&(this.dismissInapp(n[i].campaignMeta.campaignId),window.MoeFocusHandler&&window.MoeFocusHandler(),zn(n[i].campaignMeta,"OSM",!0))}),e))}else n[i].iframe.style.zIndex=(2147483647-(n.length-i-1)).toString();this.bannerLiveCampaignsStyling(n)}}))}restoreBodyStyle(){this.removeOSMPusher(),this.pushCardsTemplate(0);let e=0;Object.keys(this.campaignRenderMap).forEach((t=>{this.campaignRenderMap[t].campaignMeta.templateType===Gn.POP_UP&&this.campaignRenderMap[t].isActive()&&e++})),1<=e||(this.initialInlineBodyStyle?document.body.setAttribute("style",this.initialInlineBodyStyle):document.body.removeAttribute("style"))}canCampaignBeRendered(e){return sa(this,void 0,void 0,(function*(){var t=la.baseLogTag+".canCampaignBeRendered";try{var n=yield Bn.campaingsStatsStore.getItem(e.campaignId),i=yield Bn.serviceMetaStore.getItem(de.STORES.SERVICE_META.KEYS.GLOBAL_DELAY),a=yield Bn.serviceMetaStore.getItem(de.STORES.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME);return Jn.isValid(e,n)&&Jn.isValidMessagingCampaign(e,n,i,a,this.getActiveCampaigns())&&_i.getURLFilterResult(e)}catch(n){We.error(1,t,`Error checking if campaign ${e.campaignId} can be rendered:`,n)}return!1}))}static createDefaultIframe(e,t){la.baseLogTag,e=si(e);const n=document.createElement("iframe");return n.setAttribute("id",e),n.style.left="0px",n.style.top="0px",n.style.bottom="0px",n.style.right="0px",n.style.border="0px none",n.style.height="100%",n.style.width=window.innerWidth.toString()+"px",n.style.padding="0",n.style.overflow="hidden",n.style.overflowY="hidden",n.style.zIndex="999999",n.style.display="none",n.style.position="fixed",n.setAttribute("srcdoc",t),n}onRender(e){this.renderListener=e}getActiveCampaigns(){return this.campaignRenderOrder.map((e=>this.campaignRenderMap[e])).filter((e=>e.isActive()))}destroy(){this.getActiveCampaigns().forEach((e=>{e.setIsActive(!1)})),this.renderAllActiveCampaigns(),this.campaignRenderOrder=[],this.campaignRenderMap={}}adjustPositionOfCampaign(e,t,n){t&&(Object.assign(e,Yi[t]),dt()&&n&&this.addMarginInMweb(e,t))}addMarginInMweb(e,t){const n={paddingLeft:"10px",paddingRight:"10px",marginTop:"0",marginBottom:"0"};"TOP"===t&&(n.marginTop="10px"),"BOTTOM"===t&&(n.marginBottom="10px"),Object.assign(e,n)}handleBridgeInsertion(e,t,n){var i=la.baseLogTag+".handleBridgeInsertion";try{e.head.append(((e,t)=>{const n=document.createElement("script");return n.type="text/javascript",n.text=(t=t,`\n    const moeSDK = window.parent.Moengage;\n    let moeOsmCampaignMeta = ${JSON.stringify(e)};\n    const moengage = {\n        trackEvent: function (eventName, eventAttr, isNonInteractive) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.track_event(eventName, eventAttr);\n          }\n          return Promise.resolve();\n        },\n        trackClick: function (id) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.onsite.displayManager.clickTracker(OsmCampaignMeta, 'OSM', {\n                widget_id: id,\n              })();\n          }\n          return Promise.resolve();\n        },\n        trackDismiss: function (isAuto = false) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.onsite.displayManager.dismissEvent(OsmCampaignMeta, 'OSM', isAuto);\n          }\n          return Promise.resolve();\n        },\n        setAlias: function (data) {\n          return moeSDK.update_unique_user_id(data);\n        },\n        setUniqueId: function (data) {\n          return moeSDK.add_unique_user_id(data);\n        },\n        identifyUser: function(data) {\n          return moeSDK.identifyUser(data);\n        },\n        destroySession: function () {\n          return moeSDK.destroy_session();\n        },\n        setUserName: function (data) {\n          return moeSDK.add_user_name(data);\n        },\n        setFirstName: function (data) {\n          return moeSDK.add_first_name(data);\n        },\n        setLastName: function (data) {\n          return moeSDK.add_last_name(data);\n        },\n        setEmailId: function (data) {\n          return moeSDK.add_email(data);\n        },\n        setMobileNumber: function (data) {\n          return moeSDK.add_mobile(data);\n        },\n        setGender: function (data) {\n          return moeSDK.add_gender(data);\n        },\n        setBirthDate: function (data) {\n            //iso date format only\n            return moeSDK.add_birthday(data);\n        },\n        setUserAttribute: function (name, value) {\n            return moeSDK.add_user_attribute(name, value);\n        },\n        dismissMessage: function () {\n          setTimeout(() => {\n            moeSDK.onsite.displayManager.dismissInapp('${t}');\n          }, 100)\n        },\n        showPushOptIn: function (config) {\n          return moeSDK.call_web_push(config);\n        },\n        copyText: function (selector) {\n          return new Promise((res, rej) => {\n            if(!selector) rej();\n            var text = document.querySelector(selector);\n            if(text.textContent) {\n              navigator.clipboard.writeText(text.textContent);\n              res(null);\n            }\n            else {\n              text.select();\n              text.setSelectionRange(0, 99999);\n              navigator.clipboard.writeText(text.value);\n              res(null);\n            }\n          })\n        }\n    }\n    const MoeOsm = moengage;\n    `),n.setAttribute("data-moe-script","1"),n})(n,t)),We.log(2,i,"JS-bridge script inserted successfully",t)}catch(e){We.warn(2,i,"Failed to insert OSM JS Bridge: ",t)}}handleClassBasedTrackingForTestCampaign(e,t,n){const i=la.baseLogTag+".handleClassBasedTrackingForTestCampaign";var a=e=>Array.prototype.slice.call(e),r=a(e.contentDocument.getElementsByClassName(de.CSS_SELECTORS.DISMISS_INAPP)),o=a(e.contentDocument.getElementsByClassName(de.CSS_SELECTORS.CLICK_INAPP));if(a=a(e.contentDocument.getElementsByTagName("a")),0===r.length&&We.warn(1,i,"No dismiss class items present in this template"),0===o.length&&We.warn(1,i,"No click class items present in this template"),-1<t.payload.indexOf("TEXT_INPUT")||-1<t.payload.indexOf('dynamic-listeners="true"'))e.contentDocument.body.addEventListener("click",(e=>{e.target&&e.target.classList.contains(de.CSS_SELECTORS.CLICK_INAPP)&&We.log(1,i,"Clicked on test campaign element. No data will be sent to BE right now. We'll start sending the click events once the campaign is live"),e.target&&e.target.classList.contains(de.CSS_SELECTORS.DISMISS_INAPP)&&this.dismissTestInapp(n.draftId)}));else{for(const e of o)e.addEventListener("click",(e=>{We.log(1,i,"Clicked on test campaign element. No data will be sent to BE right now. We'll start sending the click events once the campaign is live")}));for(const e of r)e.addEventListener("click",(()=>{this.dismissTestInapp(n.draftId)}))}for(const e of a)"_blank"!==e.getAttribute("target")&&e.setAttribute("target","_parent")}handleClassBasedTracking(e){var t=la.baseLogTag+".handleClassBasedTracking",n=e=>Array.prototype.slice.call(e);const i=e.iframe;var a=n(i.contentDocument.getElementsByClassName(de.CSS_SELECTORS.DISMISS_INAPP)),r=n(i.contentDocument.getElementsByClassName(de.CSS_SELECTORS.CLICK_INAPP));if(n=n(i.contentDocument.getElementsByTagName("a")),0===a.length&&We.warn(1,t,"No dismiss class items present in this template"),0===r.length&&We.warn(1,t,"No click class items present in this template"),e.data.payload&&(-1<e.data.payload.indexOf("TEXT_INPUT")||-1<e.data.payload.indexOf('dynamic-listeners="true"')))i.contentDocument.body.addEventListener("click",(t=>{var n;t.target&&t.target.classList.contains(de.CSS_SELECTORS.CLICK_INAPP)&&(n=t.target.dataset.id,Vn(e.campaignMeta,"OSM",{widget_id:n})()),t.target&&t.target.classList.contains(de.CSS_SELECTORS.DISMISS_INAPP)&&(this.dismissInapp(e.campaignMeta.campaignId),t.target.classList.contains(de.CSS_SELECTORS.CLICK_INAPP)||zn(e.campaignMeta,"OSM"))}));else{for(const t of r)t.addEventListener("click",(t=>{t=t.target.dataset.id,Vn(e.campaignMeta,"OSM",{widget_id:t})()}));for(const t of a)t.addEventListener("click",(()=>{this.dismissInapp(e.campaignMeta.campaignId),t.classList.contains(de.CSS_SELECTORS.CLICK_INAPP)||zn(e.campaignMeta,"OSM")}))}for(const e of n)"_blank"!==e.getAttribute("target")&&e.setAttribute("target","_parent")}changeAnchorTagReDirectionMethod(e){var t,n=la.baseLogTag+".changeAnchorTagReDirectionMethod";try{for(const n of(t=e.contentDocument.getElementsByTagName("a"),Array.prototype.slice.call(t))){var i=n.getAttribute("target"),a=n.getAttribute("href");a&&"_parent"===i&&(n.setAttribute("onclick",`setTimeout(()=>{window.open('${a}','_parent')})`),n.removeAttribute("href"))}We.log(1,n,"Anchor Tag Href Rendering Changed to onClick for Campaign Frame: "+e.id)}catch(t){We.error(1,n,"Failed to Change Anchor Tag Href Rendering for Campaign Frame: "+e.id)}}liveCampaignPositionStyling(e,t){var n=la.baseLogTag+".liveCampaignPositionStyling";try{e.templateType===Gn.BANNER?e.display.config.sticky?t.style.position="fixed":t.style.position="absolute":e.templateType===Gn.POP_UP&&(t.style.position="fixed","DIV"===t.tagName?t.style.inset="0":t.style.backgroundColor="rgba(99, 99, 99, 0.21)"),We.log(1,n,"Added Position Styles for CampaignId: "+e.campaignId)}catch(t){We.error(1,n,"Failed adding Styles for CampaignId: "+e.campaignId)}}testCampaignPositionStyling(e,t){var n=la.baseLogTag+".testCampaignPositionStyling";try{e.templateType===Gn.BANNER?e.displaySettings.config.sticky?t.style.position="fixed":t.style.position="absolute":e.templateType===Gn.POP_UP&&(t.style.position="fixed","DIV"===t.tagName?t.style.inset="0":t.style.backgroundColor="rgba(99, 99, 99, 0.21)"),We.log(1,n,"Added Position Styles for CampaignId: "+e.draftId)}catch(t){We.error(1,n,"Failed adding Styles for CampaignId: "+e.draftId)}}bannerTestCampaignStyling(e,t,n){var i,a=la.baseLogTag+".bannerTestCampaignStyling";try{let n,r,o=!0;t?(n=parseInt(getComputedStyle(t.contentDocument.body).height),o=-1<t.srcdoc.indexOf(de.POSITIONED_TEMPLATE)):(i=document.querySelector("#"+si(e.draftId)+" .brz-container"),n=parseInt(getComputedStyle(i).height)),r=e.displaySettings.config.pushPage&&(o&&"TOP"===e.position||!o)?this.getOSMPusher(n):this.getOSMPusher(0),this.pushCardsTemplate(n,r),We.log(1,a,"Added Banner Styles for Test CampaignId: "+e.draftId)}catch(n){We.error(1,a,"Failed Added Banner Styles for Test CampaignId: "+e.draftId)}}bannerLiveCampaignsStyling(e){var t=la.baseLogTag+".bannerLiveCampaignsStyling";let n=0,i=0;for(let r=e.filter((e=>e.campaignMeta.templateType===Gn.BANNER)).length-1;0<=r;r--)try{if(e[r].isJSONPayloadApproach||e[r].iframe.contentDocument){let a,o=!0;e[r].isJSONPayloadApproach?a=parseInt(getComputedStyle(e[r].osmDivSelector.querySelector(".brz-container")).height):(a=parseInt(getComputedStyle(e[r].iframe.contentDocument.body).height),o=e[r].data.payload&&-1<e[r].data.payload.indexOf(de.POSITIONED_TEMPLATE)),n+=a,e[r].campaignMeta.display.config.pushPage&&(o&&"TOP"===e[r].data.position||!o)&&(i+=a),We.log(1,t,"Added Banner Styles for Live CampaignId: "+e[r].campaignMeta.campaignId)}}catch(a){We.error(1,t,"Failed Adding Banner Styles for Live CampaignId: "+e[r].campaignMeta.campaignId)}var a=this.getOSMPusher(i);this.pushCardsTemplate(i,a)}pushCardsTemplate(e,t){var n;null!==(n=null===(n=null===(n=window)||void 0===n?void 0:n.Moengage)||void 0===n?void 0:n.cards)&&void 0!==n&&n.updatePushBannerHeight(e,t)}}la.baseLogTag="MessagingDisplayManager";class da{static setScrollState(e){let t=!0;for(let n=0;n<e.length;n++)t=t&&e[n].campaignMeta.display.config.scrollable;t||(document.body.style.overflow="hidden")}}class ca{constructor(e){this.campaignId=e.campaignId,this.campaignName=e.campaignName,this.expiryTime=e.expiryTime?new Date(e.expiryTime):null,this.updatedTime=e.updatedTime?new Date(e.updatedTime):null,this.status=e.status,this.jsonPayload=e.htmlJsonPayload,this.context=e.campaignContext,this.dismissInterval=e.delivery.dismiss_interval||0,this.urlFilters=e.triggerData.url_condition}}var ua=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class ga{constructor(e,t,n){this.baseLogTag="DeliveryFunnelManager",this.displayManager=t,this.OnsiteApiClient=new Mi(e),this.deliveryStats=n}attemptCampaigns(e){e.forEach((e=>{this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED)}))}getImpressionStats(e){return ua(this,void 0,void 0,(function*(){var t=this.baseLogTag+".getImpressionStats";try{return yield Bn.campaingsStatsStore.getItem(e.campaignId)}catch(n){We.error(1,t,"Error getting impression stats for "+e.campaignId,n)}}))}getLastGlobalInappShown(){return ua(this,void 0,void 0,(function*(){return yield Bn.serviceMetaStore.getItem(de.STORES.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME)}))}getGlobalDelay(){return ua(this,void 0,void 0,(function*(){return yield Bn.serviceMetaStore.getItem(de.STORES.SERVICE_META.KEYS.GLOBAL_DELAY)}))}filterValidCampaigns(e){return ua(this,void 0,void 0,(function*(){var t=this.baseLogTag+".filterValidCampaigns",n=e.map((e=>this.getImpressionStats(e)));const i=yield this.getLastGlobalInappShown(),a=yield this.getGlobalDelay();try{const t=yield Promise.all(n);return e.filter(((e,n)=>{if(e.templateType!==Gn.SELF_HANDLED){if(!Jn.isCampaignWithinFC(e,t[n]))return this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_MAX_TIMES_SHOWN),!1;if(!Jn.hasCampaignClearedSelfDelay(e,t[n]))return this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_MIN_DELAY),!1;if(!Jn.hasCampaignClearedGlobalDelay(e,a,i))return this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_GLOBAL_DELAY),!1}return!Jn.isCampaignExpired(e)||(this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_EXPIRED),!1)}))}catch(n){We.error(1,t,"Error filtering and sorting campaigns",n)}}))}prioritizeMessagingCampaigns(e){return ua(this,void 0,void 0,(function*(){const t=yield this.filterValidCampaigns(e);if(0<t.length){const[e,...n]=t.sort(Jn.comparator);return n&&0<n.length&&n.map((t=>{t.campaignId!==e.campaignId&&this.deliveryStats.setStats(t,de.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE)})),e}}))}getCampaignTagMap(e){const t={},n=[],i=[];return e.forEach((e=>{null!=e.tag&&(i.indexOf(e.tag)<0&&i.push(e.tag),null==t[e.tag]&&(t[e.tag]=[]),t[e.tag].push(e))})),i.forEach((e=>{if(null!=t[e]){var i=t[e].sort(Jn.comparator);for(let e=0;e<i.length;e++)0===e?n.push(i[e]):this.deliveryStats.setStats(i[e],de.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE)}})),n}prioritizePersonalizationCampaigns(e){return ua(this,void 0,void 0,(function*(){var t=yield this.filterValidCampaigns(e);return 0<t.length?this.getCampaignTagMap(t):[]}))}getOnsitePayload(e,t){return ua(this,void 0,void 0,(function*(){var n=this.baseLogTag+".getOnsitePayload";try{var i=yield this.OnsiteApiClient.getCampaignPayload(e,t);if(i&&!i.error)return i;if(i&&i.error){var a=i.reason;return void this.setDeliveryFailureStats(e,a)}return void this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}catch(i){return We.error(1,n,"Error getting onsite payload",i),void this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}}))}setDeliveryFailureStats(e,t){t&&["PAUSED","EXPIRED","personalize"].includes(t)||this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}getEventForPersonalisation(e){return ua(this,void 0,void 0,(function*(){var t=yield Ui.getTriggeringPrimaryEvent(e.campaignId);return t?new cn(t.name,t.attributes):null}))}deliverMessagingCampaign(e,t){var n;return ua(this,void 0,void 0,(function*(){var i=this.baseLogTag+".deliverMessagingCampaign";if(e){var a=(yield this.getEventForPersonalisation(e))||t;try{var r=yield this.getOnsitePayload(e,a);if(r)return e.onsitePayload=r,this.isGCGCampaign(e)?void 0:(null===(n=r.payload)||void 0===n?void 0:n.code)===de.GCG_ERROR_CODE?(We.warn(1,i,`Can not render ${e.campaignId} as it falls under Control Group.`),void jn(e,"OSM",!0)()):Jn.doCampaignPayloadHasMandatoryParams(e.onsitePayload)?e:(We.warn(1,i,"Can not render "+e.campaignId),void this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_MANDATORY_PARAMS_MISSING))}catch(a){We.error(1,i,"Error delivering messaging campaign",a)}}}))}deliverPersonalizationCampaigns(e,t,n){return ua(this,void 0,void 0,(function*(){var i=this.baseLogTag+".deliverPersonalizationCampaigns";if(0<e.length){var a=e.map((e=>this.getOnsitePayload(e,n)));try{const n=yield Promise.all(a);return e.filter(((e,i)=>{if(n[i]&&n[i].payload&&(e.onsitePayload=n[i],null!=e.tag&&null!=t[e.tag])){if("JSON"!==e.onsitePayload.payloadType)return!0;if((e=>{try{JSON.parse(e)}catch(e){return!1}return!0})(e.onsitePayload.payload))return!0}return!1}))}catch(a){We.error(1,i,"Error delivering personalization campaigns",a)}}}))}messagingCampaignImpression(e,t){return ua(this,void 0,void 0,(function*(){var n=this.baseLogTag+".messagingCampaignImpression";if(e)try{var i=yield this.getLastGlobalInappShown(),a=yield this.getGlobalDelay(),r=this.displayManager.getActiveCampaigns();if(!Jn.hasCampaignClearedGlobalDelay(e,a,i))return We.warn(1,n,"Can not render "+e.campaignId),void this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_GLOBAL_DELAY);if(!Jn.canCampaignBeRenderedOverExisting(e,r.length))return void this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE);if(!_i.getURLFilterResult(e))return We.warn(1,n,"Can not render "+e.campaignId),void this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_URL_CHANGED);const o=this.displayManager.campaignRenderMap[e.campaignId];return Ea.onScrollOrExitIntentCampaigns[e.campaignId]||null!=o&&("MOE_EXIT"===t||t===D)?(this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_MAX_TIMES_SHOWN),void We.warn(1,n,"Can not render "+e.campaignId)):null!=o&&o.isActive()?(this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE),void We.warn(1,n,`Can not render ${e.campaignId}, as campaign is already Active.`)):e}catch(i){return void We.error(1,n,"Error delivering messaging campaign",i)}}))}mostEligibleMessagingCampaign(e,t){return ua(this,void 0,void 0,(function*(){if(0<e.length){this.attemptCampaigns(e);var n,i=yield this.prioritizeMessagingCampaigns(e);let a;return ni(i,w)?(n=yield ii(i)).error?this.setDeliveryFailureStats(i,n.reason):this.isGCGCampaign(n)||(a=n):a=yield this.deliverMessagingCampaign(i,t),i=yield this.messagingCampaignImpression(a,null==t?void 0:t.name),this.deliveryStats.sendDeliveryStats(e),i}}))}mostEligiblePersonalizationCampaigns(e,t,n){return ua(this,void 0,void 0,(function*(){if(0<e.length){this.attemptCampaigns(e);var i=yield this.prioritizePersonalizationCampaigns(e);return i=yield this.deliverPersonalizationCampaigns(i,t,n),this.deliveryStats.sendDeliveryStats(e),i||[]}return[]}))}mostEligibleSelfHandledPersonalizationCampaigns(e,t){return ua(this,void 0,void 0,(function*(){var n=this.baseLogTag+".mostEligibleSelfHandledPersonalizationCampaigns";this.attemptCampaigns(e);const i=yield this.filterValidCampaigns(e);We.log(1,n,"Eligible campaigns with tag ",t,"are",i);const a=i.sort(Jn.comparator)[0];return a&&(We.log(1,n,"Campaign with highest priority for tag",t,"is",a.campaignId),(n=yield this.getOnsitePayload(a))&&n.payload&&(a.onsitePayload=n)),this.deliveryStats.sendDeliveryStats(e),a}))}mostEligibleSelfHandledCampaigns(e,t){return ua(this,void 0,void 0,(function*(){var n=this.baseLogTag+".mostEligibleSelfHandledCampaigns";this.attemptCampaigns(e);const i=yield this.filterValidCampaigns(e);if(0===i.length)return this.deliveryStats.sendDeliveryStats(e),[];We.log(1,n,"Eligible self-handled campaigns are ",i);let a=i.sort(Jn.comparator);return a&&0<a.length?(5<a.length&&(a.slice(5,a.length).map((e=>{this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE)})),a=a.slice(0,5)),We.log(1,n,"Campaign in prioritised order: ",a.map((e=>e.campaignId))),n=Promise.all(a.map((e=>this.getOnsitePayload(e,t)))).then((e=>e.filter((e=>(null==e?void 0:e.templateType)===Gn.SELF_HANDLED_OSM)).map(((e,t)=>new ca(Object.assign(Object.assign({},e),a[t])))))),this.deliveryStats.sendDeliveryStats(e),n):void 0}))}delayDeliveryCampaignStats(e){this.deliveryStats.setStats(e,de.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_CANCEL_BEFORE_DELAY),this.deliveryStats.sendDeliveryStats([e])}isGCGCampaign(e){var t,n=this.baseLogTag+".isGCGCampaign";return(null===(t=e.onsitePayload.payload)||void 0===t?void 0:t.code)===de.GCG_ERROR_CODE&&(We.warn(1,n,`Can not render ${e.campaignId} as it falls under Control Group.`),jn(e,"OSM",!0)(),!0)}}class ma{constructor(e){this.draftId=Le(e,"draft_id",null),this.draftType=Le(e,"draft_type",null),this.templateType=Le(e,"template_type",null),this.action=Le(e,"action",null);var t=Le(e,"campaign_meta",{});this.locale=Le(e,"locale",null),this.variation=Le(e,"variation",null),this.displaySettings=new Ri({config:t.config},this.templateType)}static isValidRawJson(e){var{draft_id:t,draft_tag:n,draft_type:e}=e;return e===de.DRAFT_CAMPAIGN_TPYES.WEB_PERSONALIZATON?null!=t&&null!=n:null!=t}}const pa=(e,t)=>(We.log(1,"selfHandledHelper.track",`Self handled OSM ${t} tracking called for campaign:`,e.campaignName),e.campaignId?(t===de.EVENT_NAMES.OSM.IMPRESSION&&Yn(e.campaignId),Me().track_event(t,Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName,type:de.EVENT_NAMES.OSM.TYPE},e.context))):new Promise(((e,t)=>{t("Moengage error: Campaign ID not found")})));class ha{handler(e,t,n,i,a,r){var o;return function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){var s=ha.baseLogTag+".handler";We.log(1,s,(null==r?void 0:r.name)&&`Triggered for ${r.name}: `||"Campaign(s) triggered: ",a);var l=a.filter((e=>e.templateType===Gn.SELF_HANDLED)),d=a.filter((e=>e.templateType!==Gn.SELF_HANDLED&&e.templateType!==Gn.SELF_HANDLED_OSM)),c=a.filter((e=>e.templateType===Gn.SELF_HANDLED_OSM));if(0<l.length&&0<(l=yield e.mostEligiblePersonalizationCampaigns(l,t,r)).length&&n(l),0<d.length){if(d=yield e.mostEligibleMessagingCampaign(d,r),null!=r&&r.timestamp&&r.timestamp<(null===(o=window.Moengage)||void 0===o?void 0:o.pageChangeHandlerCallingTime))return void We.log(1,s,"Stopped triggering the campaign because handle_page_change was called: ",a);d&&i(d)}if(0<c.length&&this.selfHandledOSMCallback){const t=yield e.mostEligibleSelfHandledCampaigns(c,r);0<t.length&&(t.forEach((e=>{pa(e,de.EVENT_NAMES.OSM.DELIVERED)})),this.selfHandledOSMCallback(t))}}))}}ha.baseLogTag="EventTriggerHandler";class va{constructor(e){this.baseLogTag="DeliveryStats",this.OnsiteApiClient=new Mi(e),this.batchId=(0,rt.v4)()}sendDeliveryStats(e){return function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){var t=this.baseLogTag+".sendDeliveryStats";if(!window.navigator.onLine)return We.error(1,t,"No internet connection. Delivery stats will not be sent"),void xi.setOnlineEventListner((()=>{this.sendDeliveryStats(e)}));if(0<e.length)try{const t={};e.forEach((e=>{t[e.campaignContext.cid]||(t[e.campaignContext.cid]=e.stats,e.stats={})}));var n={stats:t};this.OnsiteApiClient.callStatsAPI(n,this.batchId)}catch(n){We.error(1,t,"Error in sending delivery funnel stats",n)}}))}setStats(e,t){var n=(new Date).toISOString();e&&(e.stats[t]=e.stats[t]||[],e.stats[t].includes(n)||e.stats[t].push(n))}}var fa=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};const Sa=new gt;class Ea{constructor(e){this.initializationPomise=null,this.testDraftInfo=null,this.triggerManager=null,this.displayManager=null,this.selfHandledWebpTriggerListeners={},this.funnelManager=null,this.eventTriggerHandler=null,this.deliveryStats=null,this.initData=e,We.setLogLevel(e.debugLevel),this.OnsiteApiClient=new Mi(this.initData),function(){Ea.handleSDKEnableAndDisableLisetner||(window.addEventListener(W,(e=>Kn(this,void 0,void 0,(function*(){var t=null===(t=null==e?void 0:e.detail)||void 0===t?void 0:t.name;t===H.SDK_ENABLED?yield Ma.enableOSM():t===H.SDK_DISABLED&&(yield Ma.disableOSM(!1,!0))})))),Ea.handleSDKEnableAndDisableLisetner=!0)}()}setLogLevel(e){We.setLogLevel(e,!1)}isTestCampaignAvailable(){return fa(this,void 0,void 0,(function*(){const e=Ea.baseLogTag+".isTestCampaignAvailable";window.opener?(window.addEventListener("message",(t=>fa(this,void 0,void 0,(function*(){var n,i;t.data&&"inapp_test"===t.data.action&&(n=t.data,ma.isValidRawJson(n)?(i=new ma(n),We.log(1,e,"Valid test campaign data found checking TestCampaign",n),yield this.checkForTestCampaign(i)):We.error(1,e,"Data is not a valid test campaign",n),Sa.res())}))),!1),window.opener.postMessage("moe_test_osm","*"),setTimeout((()=>fa(this,void 0,void 0,(function*(){Sa.res()}))),100)):Sa.res()}))}initialize(){const e=Ea.baseLogTag+".initialize";return We.log(1,e,"Initialising onsite module"),null==this.initializationPomise&&xt()&&(this.initializationPomise=new Promise((t=>fa(this,void 0,void 0,(function*(){try{yield Bn.initialize(),yield this.isTestCampaignAvailable(),Sa.p.then((()=>fa(this,void 0,void 0,(function*(){yield this.syncCampaigns();const n=yield ri();var i=this.isExitIntentCampaignFound(n);if(i.length&&(yield this.prefetchExitIntentCampaigns(i)),i=n.filter((e=>null!=e.triggerData)),this.displayManager=new la,this.displayManager.onRender((t=>{We.log(1,e,"Campaign rendered: "+t.campaignId),Bn.serviceMetaStore.setItem(de.STORES.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME,new Date)})),null!=this.testDraftInfo&&this.testDraftInfo.draftType===de.DRAFT_CAMPAIGN_TPYES.ONSITE_MESSAGING){We.log(1,e,"Test campaigns present, will be showing only the test campaign."),We.log(1,e,"No live campaign will be shown till draft campaign showing");try{We.log(1,e,"Trying to render draft campaign with id "+this.testDraftInfo.draftId);var a=yield this.OnsiteApiClient.getDraftCampaign(this.testDraftInfo);We.log(1,e,"Test campaign payload: ",a),a&&this.displayManager.queueDraftCampaign(this.testDraftInfo,a),this.testDraftInfo=null}catch(n){We.error(1,e,`Error fetching data for test campaign ${this.testDraftInfo.draftId}: `,n)}}else null!==(a=this.initData)&&void 0!==a&&a.enableSPA&&this.handleSPA(),Ea.attachIdentityUpdateHandler(),this.deliveryStats=new va(this.initData),this.triggerManager=new Vi(i),this.funnelManager=new ga(this.initData,this.displayManager,this.deliveryStats),this.eventTriggerHandler=new ha,i=this.eventTriggerHandler.handler.bind(this.eventTriggerHandler,this.funnelManager,this.selfHandledWebpTriggerListeners,this.handlePersonalizationCampagins.bind(this),this.handleMessagingCampaigns.bind(this)),this.triggerManager.onTrigger(i),Hi.setListener(i),Gi.setDeliveryStats(this.deliveryStats),Hi.setDeliveryStats(this.deliveryStats),yield Hi.logDeliveryFunnelForExpiredTimerCampaigns(),yield Gi.updateCampaignTimeInSecondaryEventsStore(),yield Hi.createNewTimers(),this.triggerManager.startWatching();Ht.broadcastToWindow({topic:W,name:H.OSM_INIT}),t(!0)}))))}catch(t){We.error(1,e,t)}}))))),this.initializationPomise}handleMessagingCampaigns(e){return fa(this,void 0,void 0,(function*(){var t=Ea.baseLogTag+".handleMessagingCampaigns";e.onsitePayload&&this.displayManager&&(We.log(1,t,"Campaign triggered: "+e.campaignId),We.log(1,t,"Payload for campaign:",e.onsitePayload),this.displayManager.queueLiveCampaign(e,e.onsitePayload))}))}handlePersonalizationCampagins(e){return fa(this,void 0,void 0,(function*(){const t=Ea.baseLogTag+".handlePersonalizationCampagins";0<e.length&&e.forEach((e=>{null!=e.tag&&(We.log(1,t,"Personlization Campaign triggered: "+e.campaignId),this.selfHandledWebpTriggerListeners[e.tag].forEach((t=>{this.handleSelfHandledCallback(e,e.onsitePayload,t)})))}))}))}logout(e=!1,t=!1){var n;return fa(this,void 0,void 0,(function*(){var i=Ea.baseLogTag+".logout";if(We.log(1,i,"Starting module logout"),null!==(n=this.initData)&&void 0!==n&&n.enableSPA&&this.removeHandlePageChange(),this.initializationPomise=null,this.displayManager){ei(this.displayManager);const e=Object.keys(this.displayManager.campaignRenderMap);null!==(n=this.displayManager.testCampaign)&&void 0!==n&&n.draftId&&e.push(null===(n=this.displayManager.testCampaign)||void 0===n?void 0:n.draftId),e.forEach((e=>{const t=document.getElementById("moe-onsite-campaign-"+e);t&&t.remove()})),this.displayManager.destroy()}this.triggerManager&&(Zn(this.triggerManager),ti(this.triggerManager),this.triggerManager.destory()),un.clear(),Gi.destroy(),Hi.destroy(),e&&(Ea.onScrollOrExitIntentCampaigns={}),this.displayManager=null,this.funnelManager=null,this.eventTriggerHandler=null,yield Hi.deleteAllPendingTimers(),t?Bn.sdkOptOut():(yield Bn.serviceMetaStore.removeItem(de.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME),yield Bn.clear(e)),We.log(1,i,"Starting module logout complete")}))}checkForTestCampaign(e){return fa(this,void 0,void 0,(function*(){var t=Ea.baseLogTag+".checkForTestCampaign";try{var n=e;null==n?(We.log(1,t,"No draft campaign found"),this.testDraftInfo=null):(We.log(1,t,"Found draft campaign: ",n),this.testDraftInfo=n,null==this.testDraftInfo.draftId&&(this.testDraftInfo.draftType=de.DRAFT_CAMPAIGN_TPYES.WEB_PERSONALIZATON))}catch(n){We.error(1,t,"Error getting test campaign",n)}}))}getData(e,t){return fa(this,void 0,void 0,(function*(){const n=Ea.baseLogTag+".getData";null==t&&(We.warn(1,n,"Moengage.onsite.getData called without a providing a callback."),t=()=>{});try{if(yield this.initializationPomise,null!=this.testDraftInfo){var i;We.log(1,n,"Fetching test campaign: ",this.testDraftInfo),this.testDraftInfo.draftType===de.DRAFT_CAMPAIGN_TPYES.WEB_PERSONALIZATON&&(i=yield this.OnsiteApiClient.getDraftCampaign(this.testDraftInfo),this.testDraftInfo=null,t(null,{payload:i.payload,click:()=>{We.log(1,n,"This is a test campaign")},imp:()=>{We.log(1,n,"This is a test campaign")}}))}else{const i=yield Bn.campaingsTagsStore.getItem(e);if(i){const o=yield Promise.all(i.map((e=>ai(e))));var a=o.filter((e=>null==e.triggerData)),r=yield this.funnelManager.mostEligibleSelfHandledPersonalizationCampaigns(a,e);r&&r.onsitePayload?this.handleSelfHandledCallback(r,r.onsitePayload,t):(We.error(1,n,"Error fetching campaign payload"),t({message:"There was an error fetching data for this tag"},null))}else We.warn(1,n,"Could not find any eligible campaign for tag",e),t({message:"Could not find any eligible campaign for tag "+e},null)}}catch(i){We.error(1,n,"Error getting campaign",i)}}))}registerCallback(e,t){return fa(this,void 0,void 0,(function*(){var n=Ea.baseLogTag+".registerCallback";try{yield this.initializationPomise,null==this.selfHandledWebpTriggerListeners[e]?this.selfHandledWebpTriggerListeners[e]=[t]:this.selfHandledWebpTriggerListeners[e].push(t)}catch(t){We.error(1,n,"Error setting callback for tag",e),We.error(1,n,"Error stack:",t)}}))}handleSelfHandledCallback(e,t,n){return fa(this,void 0,void 0,(function*(){var i=Ea.baseLogTag+".handleSelfHandledCallback";if(e.campaignContext=t.campaignContext,"JSON"===t.payloadType)try{t.payload=JSON.parse(t.payload);var a=Le(e,"triggerData.trigger_delay.delayInSeconds",0)||0;setTimeout((()=>{qn(e,"WP"),n(null,{payload:t.payload,click:t=>{Vn(e,"WP",t)()},imp:jn(e,"WP")})}),1e3*a)}catch(r){a=`Payload for campaign_id ${e.campaignId} is not a valid JSON`,We.error(1,i,a),We.error(1,i,"Payload provided:",t.payload),n({message:a},null)}else qn(e,"WP"),n(null,{payload:t.payload,click:t=>{Vn(e,"WP",t)()},imp:jn(e,"WP")})}))}syncCampaigns(){return fa(this,void 0,void 0,(function*(){var e=Ea.baseLogTag+".syncCampaigns";try{(yield this.shouldClearMetaStorage())&&(yield Bn.campaingsMetaStore.clear(),yield this.rebuildTagStore()),(yield this.shouldSaveRemoteCampaigns())&&(yield this.saveRemoteCampaigns())}catch(t){We.error(1,e,"Error getting remote campaigns: ",t)}}))}shouldClearMetaStorage(){return fa(this,void 0,void 0,(function*(){return(yield Bn.serviceMetaStore.getItem(de.STORES.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION))!==Me().getSdkVersion()}))}shouldSaveRemoteCampaigns(){var e;return fa(this,void 0,void 0,(function*(){var t=Ea.baseLogTag+".shouldSaveRemoteCampaigns",n=yield Bn.serviceMetaStore.getItem(de.STORES.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION),i=yield Bn.serviceMetaStore.getItem(de.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME),a=(i=new Date(i),(new Date).getTime());return null==i||a-i>de.META_REFRESH_TIME||(We.remoteLogTracking(1,"info",t,"Last fetch was less than 15 mins ago at ",i),n!==Me().getSdkVersion()?(We.remoteLogTracking(1,"info",t,"Version change detected. Will proceed to fetch latest campaigns"),!0):!(!(n=yield Bn.serviceMetaStore.getItem(de.STORES.SERVICE_META.KEYS.UNIQUE_ID))||n===(null===(e=nt.get(s.USER_DATA))||void 0===e?void 0:e.deviceUuid)||(We.remoteLogTracking(1,"info",t,"Unique device id change detected. Will proceed to fetch latest campaigns"),0)))}))}saveRemoteCampaigns(){return fa(this,void 0,void 0,(function*(){var e=Ea.baseLogTag+".saveRemoteCampaigns";yield Bn.campaingsMetaStore.clear(),yield Bn.exitIntentCampaignStore.clear();var t=yield this.OnsiteApiClient.getCampaignsMeta();null!=t&&(yield this.addCampaignsToDB(t.campaignsMeta),We.log(1,e,"Inapp campaigns meta saved!")),yield Gi.pruneRemovedCampaigns(),yield Gi.removeStaleTriggeringPrimaryEventCampaigns(),yield Bn.serviceMetaStore.setItem(de.STORES.SERVICE_META.KEYS.GLOBAL_DELAY,t.globalDelayBetweenInapps),yield Bn.serviceMetaStore.setItem(de.STORES.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION,Me().getSdkVersion())}))}addCampaignsToDB(e){return fa(this,void 0,void 0,(function*(){var t=Ea.baseLogTag+".addCampaignsToDB";We.log(1,t,`Adding/Updating ${e.length} campaigns in DB`,e.map((e=>e.campaignId)));try{yield Promise.all(e.map((e=>Bn.campaingsMetaStore.setItem(e.campaignId,e)))),yield this.rebuildTagStore()}catch(e){We.error(1,t,"Error saving remote campaigns:",e)}}))}rebuildTagStore(){return fa(this,void 0,void 0,(function*(){var e=Ea.baseLogTag+".rebuildTagStore";try{yield Bn.campaingsTagsStore.clear();var t=yield ri();const e={};for(const n of t)null!=n.tag&&(null==e[n.tag]&&(e[n.tag]=[]),e[n.tag].push(n.campaignId));const n=[];yield Bn.campaingsTagsStore.clear();for(const t in e)e.hasOwnProperty(t)&&n.push(Bn.campaingsTagsStore.setItem(t,e[t]));yield Promise.all(n)}catch(t){We.error(1,e,"Error updating tags store:",t)}}))}isExitIntentCampaignFound(e){return e.filter((e=>e.templateType!==Gn.SELF_HANDLED&&ni(e,w)))}prefetchExitIntentCampaigns(e){return fa(this,void 0,void 0,(function*(){var t=Ea.baseLogTag+".prefetchExitIntentCampaigns";const n=yield cn.createEvent("MOE_EXIT",[]),i=(yield Xn(e)).filter((e=>_i.getFilterResult(n,e)));if(!i||!i.length)return We.log(1,t,"Exit intent campaign not eligible to prefetch"),!1;{const e=yield ii(i[0]);if(!e||!e.onsitePayload||e.onsitePayload.updatedTime.getTime()!==i[0].updatedTime.getTime()){var a=i[0].campaignId;const e=yield this.OnsiteApiClient.getCampaignPayload(i[0]);e.payload||e.htmlJsonPayload?(e.updatedTime=i[0].updatedTime,yield Bn.exitIntentCampaignStore.setItem(a,e),We.log(1,t,"Exit intent campaign prefetched: "+a)):e.error&&e.reason&&(yield Bn.exitIntentCampaignStore.setItem(a,e))}}}))}static handleDisableModule(e){Ht.broadcastToWindow({topic:"MODULE_ACTIONS",name:"DISABLE_OSM",data:{isUserLogout:e}})}sendDelayCampaignStats(e,t){return fa(this,void 0,void 0,(function*(){var n=Ea.baseLogTag+".sendDelayCampaignStats",i=Object.keys(e.campaignRenderMap).filter((t=>!e.campaignRenderMap[t].campaignRendered));0<i.length&&(We.log(1,n,"Campaigns found:",i),t.delayDeliveryCampaignStats(e.campaignRenderMap[i[0]].campaignMeta))}))}handleSPA(){var e=Ea.baseLogTag+".handleSPA";We.log(2,e,"Adding SPA event listener for OSM"),window.addEventListener(V,li,{once:!0})}removeHandlePageChange(){var e=Ea.baseLogTag+".removeHandlePageChange";We.log(2,e,"Removing SPA event listener for OSM"),window.removeEventListener(V,li)}static identityUpdateHandler(e){return fa(this,void 0,void 0,(function*(){e.detail.name===K.USER_IDENTITY_UPDATE?Ht.broadcastToWindow({topic:"MODULE_ACTIONS",name:"DISABLE_ENABLE_OSM"}):e.detail.name===K.LOGOUT&&(removeEventListener(G,Ea.identityUpdateHandler),Ea.identityListenerAdded=!1,Ea.handleDisableModule(!0))}))}static attachIdentityUpdateHandler(){Ea.identityListenerAdded||(window.addEventListener(G,Ea.identityUpdateHandler),Ea.identityListenerAdded=!0)}getSelfHandledOSM(e){const t=Ea.baseLogTag+".getSelfHandledOSM";e&&"function"==typeof e?(We.log(1,t,"Self handled OSM callback requested"),this.initializationPomise.then((()=>{this.eventTriggerHandler?this.eventTriggerHandler.selfHandledOSMCallback=e:We.warn(1,t,"OSM module not initialised properly for self handled OSM to work; or it is in test campaign mode.")})).catch((n=>{We.error(1,t,"Error during initialization:",n),e(n,null)}))):We.error(1,t,"Self handled OSM callback is not a function.")}selfHandledShown(e){return pa(e,de.EVENT_NAMES.OSM.IMPRESSION)}selfHandledClicked(e){return pa(e,de.EVENT_NAMES.OSM.CLICK)}selfHandledDismissed(e){return pa(e,de.EVENT_NAMES.OSM.DISMISS)}}Ea.baseLogTag="MoeOnsite",Ea.identityListenerAdded=!1,Ea.onScrollOrExitIntentCampaigns={},Ea.handleSDKEnableAndDisableLisetner=!1,window[de.OSM_MODULE]=Ea,window.MoeOsm=(We.log(1,"OsmFunctions","Osm Functions for tracking user behaviour"),{trackEvent:(e,t,n,i)=>(e=zi(e),{}.constructor===n.constructor&&e?(n=Object.assign(Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName},e.campaignContext),n),window.Moengage.track_event(t,n)):Promise.resolve()),trackClick:(e,t)=>(e=zi(e))?window.Moengage.onsite.displayManager.clickTracker(e,"OSM",{widget_id:t})():Promise.resolve(),trackDismiss:(e,t=!1)=>(e=zi(e))?window.Moengage.onsite.displayManager.dismissEvent(e,"OSM",t):Promise.resolve(),setAlias:e=>window.Moengage.update_unique_user_id(e),setUniqueId:e=>window.Moengage.add_unique_user_id(e),identifyUser:e=>window.Moengage.identifyUser(e),destroySession:()=>window.Moengage.destroy_session(),setUserName:e=>window.Moengage.add_user_name(e),setFirstName:e=>window.Moengage.add_first_name(e),setLastName:e=>window.Moengage.add_last_name(e),setEmailId:e=>window.Moengage.add_email(e),setMobileNumber:e=>window.Moengage.add_mobile(e),setGender:e=>window.Moengage.add_gender(e),setBirthDate:e=>window.Moengage.add_birthday(e),setUserAttribute:(e,t)=>window.Moengage.add_user_attribute(e,t),dismissMessage(e){setTimeout((()=>{window.Moengage.onsite.displayManager.dismissInapp(""+e)}),100)},showPushOptIn:e=>window.Moengage.call_web_push(e),copyText:e=>new Promise(((t,n)=>{e||n();const i=document.querySelector(e);i.textContent?navigator.clipboard.writeText(i.textContent):(i.select(),i.setSelectionRange(0,99999),navigator.clipboard.writeText(i.value)),t(null)}))});class ya{static addCallback(e,t){null!=e&&null!=t&&(null==ya.callbacks[e]&&(ya.callbacks[e]=[]),ya.callbacks[e].push(t))}static getCallbacks(e){return ya.callbacks[e]||[]}static runCallbacks(e){ya.getCallbacks(e).forEach((e=>{e()}))}}function ba(){const e=document.getElementById("moe-push-div");null!=e&&(e.style.visibility="none",e.style.opacity="0",e.parentNode.removeChild(e))}var _a;ya.callbacks={};class Ta{constructor(e){this.swRegisterPromise=null,this.swActiveRetries=1;const t=Ta.baseLogTag+".constructor";this.sdkSettings=e,this.registerServiceWorker().then((e=>{this.sendDataToServiceWorker()})).catch((e=>{We.error(1,t,"Error registering serviceworker:",e)}))}showHardAsk(){const e=Ta.baseLogTag+".showHardAsk";return new Promise(((t,n)=>{Ta.isWebPushSupported().then((i=>{i?this.getCurrentPermissionState().then((i=>{xt()&&this.registerServiceWorker().then((a=>{var r;i!==gn.DENIED?(We.remoteLogTracking(1,"info",e,"Attempting to open hard ask"),null!==(r=Me())&&void 0!==r&&r.track_event(b),Ht.broadcastToWindow({topic:W,name:F.HARD_ASK_ATTEMPTED}),this.showOverlay(),xt()&&this.askPermission().then((n=>{xt()&&(this.hideOverlay(),We.remoteLogTracking(2,"info",e,"Permission state after hard ask:",n),n===gn.GRANTED?this.getPushTokenDetails().then((e=>{this.sendDataToServiceWorker(e.token),t({state:n,subscriptionDetails:e})})):(this.sendDataToServiceWorker(),t({state:n,subscriptionDetails:null})))})).catch((t=>{We.error(1,e,t),n(z)}))):(We.remoteLogTracking(1,"info",e,"Hard ask not shown as permission state is",i),t({state:i,subscriptionDetails:null}))})).catch((t=>{We.error(1,e,"Error registering serviceworker:",t),n(t)}))})).catch((t=>{We.error(1,e,"Registering service worker failed:",t),n(z)})):(We.warn(1,e,"Web push not supported in current browser environment"),n(Y))}))}))}sendDataToServiceWorker(t){return new Promise((n=>{vn.collectGetParams().then((n=>{var i,a=He.get();t&&(n.push_id=t||bt()||void 0),n.isWebPushEnabled=this.sdkSettings.isWebPushEnabled&&!a.disableWebPush,n.isBatchingEnabled=nt.get(s.WEB_SETTINGS).configs.isBatchingEnabled,null!==(i=a.proxyDomains)&&void 0!==i&&i.api&&(n.proxyDomains=a.proxyDomains),Ke()||a.swScope?e.createInstance({driver:[e.INDEXEDDB],name:"moe_database",storeName:"moe_data"}).setItem("reportParams",{data:n}):navigator.serviceWorker.ready.then((()=>{this.sendDataToServiceWorkerOnControllerReady(n)}))}))}))}sendDataToServiceWorkerOnControllerReady(e){if(navigator.serviceWorker.controller){if("chrome-extension:"===window.location.protocol)return chrome.runtime.sendMessage({data:e});navigator.serviceWorker.controller.postMessage({data:e})}else this.swActiveRetries<3&&setTimeout((()=>{this.swActiveRetries++,this.sendDataToServiceWorkerOnControllerReady(e)}),500)}getCurrentPermissionState(){return ft.getInstance().then((e=>navigator.permissions&&!e.isSafari()?navigator.permissions.query({name:"notifications"}).then((e=>Ta.parsePermissionState(e.state))).catch((e=>{})):new Promise((t=>{var n;let i=null===(n=window.Notification)||void 0===n?void 0:n.permission;e.isSafari()&&"default"===i&&(i="prompt",nt.get(Se)&&(i="denied")),t(Ta.parsePermissionState(i))}))))}getPushTokenDetails(){const e=Ta.baseLogTag+".getPushTokenDetails";return new Promise(((t,n)=>{this.getCurrentPermissionState().then((n=>{ft.getInstance().then((i=>{n!==gn.GRANTED?t({token:null,raw:null}):this.registerServiceWorker().then((n=>{let a=null;const r={userVisibleOnly:!0};Ge(this.sdkSettings.webPushPlatformData,i)&&(a=je(this.sdkSettings.webPushPlatformData,i),r.applicationServerKey=Nt(a));const o=()=>{n.pushManager.subscribe(r).then((e=>{(e=>{const n=e.toJSON();var a=e.endpoint.substring(0,n.endpoint.lastIndexOf("/")+1);e=n.expirationTime;let r=n.endpoint.split("/")[n.endpoint.split("/").length-1];i.isEdge()&&(r=r.replace("?token=",""));const o={};if(n.keys)for(const e in n.keys)n.keys.hasOwnProperty(e)&&(o[e]=n.keys[e]);t({token:r,endpoint:a,keys:o,expirationTime:e,raw:n})})(e)})).catch((n=>{We.error(1,e,"Error in subscribtion: ",n),t({token:null,raw:null})}))};n.pushManager.getSubscription().then((e=>{if(e)if("vapid"===this.sdkSettings.webPushPlatformData.chrome.subscriptionMode&&e.options&&e.options.applicationServerKey){var t=Ct(e.options.applicationServerKey);[a,a+"=",a+"==",Ct(Nt(a))].indexOf(t)<0?e.unsubscribe().then((()=>{o()})):o()}else o();else o()}))})).catch((n=>{We.error(1,e,"Error in getting push token: ",n),t({token:null,raw:null})}))}))}))}))}removeToken(){return nt.remove(s.PUSH_TOKEN),nt.remove(s.OPTED_STATUS_TRACK_TIME),nt.remove(s.SUBSCRIPTION_DETAILS),Promise.resolve()}askPermission(){return new Promise(((e,t)=>{var n;null!==(n=window.Notification)&&void 0!==n&&n.requestPermission().then((t=>{var n;nt.set(s.OPT_IN_SHOWN_TIME,Date.now()),null!==(n=Me())&&void 0!==n&&n.track_event(f),Ht.broadcastToWindow({topic:W,name:F.HARD_ASK_SHOWN}),Ht.deprecatedSdkCallback("opt_in_shown"),ya.runCallbacks(F.HARD_ASK_SHOWN),e(Ta.parsePermissionState(t))})).catch((e=>{t($)}))}))}registerServiceWorker(){const e=Ta.baseLogTag+".registerServiceWorker";return"chrome-extension:"===window.location.protocol?navigator.serviceWorker.ready:(null!=this.swRegisterPromise||(this.swRegisterPromise=new Promise(((t,n)=>{if(Ta.registeredServiceWorker)t(Ta.registeredServiceWorker);else if("serviceWorker"in navigator){let i="serviceworker.js",a=!1;if(He.get()&&null!=He.get().swPath&&(i=He.get().swPath,a=!0),"/"===i[0]||i.startsWith("http")||(i="/"+i),Ke())We.log(1,e,"Removing scope in case of shopify."),this.registerScopedSW(i,/moengage/,t,n);else{let r="/";He.get()&&null!=He.get().swScope?(r=He.get().swScope,this.registerScopedSW(i,r,t,n)):(a&&(We.log(1,e,"Using user defined path to serviceworker:",i),r=i.substr(0,i.lastIndexOf("/")+1),Ta.canSwBeRegisteredWithScope(r)||(We.error(1,e,"Service worker can only be registered from same directory or child directory."),n(J))),navigator.serviceWorker.register(i,{scope:r}).then((i=>{We.log(2,e,"Serviceworker registered"),navigator.serviceWorker.ready.then((n=>{We.log(2,e,"Serviceworker ready"),Ta.registeredServiceWorker=n,He.get()&&He.get().forceSwUpdate&&n.update(),t(n)})).catch((t=>{We.error(1,e,"Service worker register failed:",t),n(z)}))})).catch((t=>{We.error(1,e,"Service worker register failed:",t),n(z)}))),We.log(1,e,"Scope for serviceworker:",r)}}else We.error(1,e,"Service worker not supported"),n("Service worker not supported")}))),this.swRegisterPromise)}registerScopedSW(e,t,n,i){const a=Ta.baseLogTag+".registerScopedSW";navigator.serviceWorker.register(e).then((e=>{We.log(2,a,"Serviceworker registered"),navigator.serviceWorker.getRegistrations().then((e=>{e.forEach((e=>{setTimeout((()=>{e.active&&e.active.scriptURL.match(t)&&(We.log(2,a,"Serviceworker ready"),Ta.registeredServiceWorker=e,He.get()&&He.get().forceSwUpdate&&e.update(),n(e))}),100)}))})).catch((e=>{We.error(1,a,"Service worker register failed:",e),i(z)}))})).catch((e=>{We.error(1,a,"Service worker register failed:",e),i(z)}))}static canSwBeRegisteredWithScope(e){var t=window.location.pathname;return e=e,!((t=t).indexOf(e)<0)&&0<=t.substring(t.indexOf(e)).length}static isWebPushSupported(){return new Promise((e=>{ft.getInstance().then((t=>{!t.isIncognito&&"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window&&t.isWebPushCompatible()?e(!0):e(!1)}))}))}static parsePermissionState(e){return"prompt"===e?gn.PROMPT:"granted"===e?gn.GRANTED:"denied"===e?gn.DENIED:"default"===e?gn.DISMISSED:null}showNotification(e){const t=Ta.baseLogTag+".showNotification";this.registerServiceWorker().then((n=>{e?e.title?e.body?(null==e.requireInteraction&&(e.requireInteraction=!0),n.showNotification(e.title,e)):We.error(1,t,"Notification body can not be blank"):We.error(1,t,"Notification title can not be blank"):We.error(1,t,"Notification object can not be blank")})).catch((e=>{We.error(1,t,"Error registering serviceworker:",e)}))}showOverlay(){if(this.sdkSettings.toShowOverlay&&this.sdkSettings.optInType===pn.ONE_STEP){const e=document.createElement("div");e.id="moe-push-div",e.style.display="none",e.className="moe-push-class",ft.getInstance().then((t=>function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){t.isMobile?e.innerHTML=(yield Tt(this.sdkSettings.overlay,this.sdkSettings.isBrandingHidden)).mobileUI:e.innerHTML=(yield Tt(this.sdkSettings.overlay,this.sdkSettings.isBrandingHidden)).webUI;const n=document.body.firstChild;n.parentNode.insertBefore(e,n);var i=t.name;let a;if(i===ft.BROWSER_NAMES.CHROME||i===ft.BROWSER_NAMES.OPERA_NEON?a=document.getElementsByClassName("moe_chrome"):i===ft.BROWSER_NAMES.FIREFOX?a=document.getElementsByClassName("moe_firefox"):i!==ft.BROWSER_NAMES.OPERA&&i!==ft.BROWSER_NAMES.SAFARI||(a=document.getElementsByClassName("moe_opera")),0===a.length)document.getElementById("moe-push-div").style.display="none";else for(let e=a.length-1;0<=e;e--)a[e].style.display="block";this.overlayTimer=window.setTimeout((()=>{""===e.style.opacity&&(e.style.display="block")}),1500),e.onclick=()=>{this.hideOverlay()}}))))}}hideOverlay(){clearTimeout(this.overlayTimer),ba()}}Ta.baseLogTag="HTTPS-NotificationManager";const Ia="Web push settings not configured on MoEngage dashboard: "+ee;class Aa{constructor(e,t){this.currentManager=null;var n=Aa.baseLogTag+".constructor";this.config=e,this.browser=t,this.browser.isWebPushCompatible()?e.webPushPlatformData.chrome&&(e.isWebPushEnabled?"https"===function(){if(window)return"localhost"===window.location.hostname?"https":"http:"===window.location.protocol?"http":"https:"===window.location.protocol||"chrome-extension:"===window.location.protocol?"https":void 0}()?this.currentManager=new Ta(e):We.error(1,n,"Web Push does not work in http mode"):(Ke()&&new Ta(e),We.warn(1,n,"Web push settings not configured. Please configure at ",ee))):this.browser.name===ft.BROWSER_NAMES.SAFARI&&"safari"in window&&"pushNotification"in window.safari&&(this.currentManager=null,We.warn(1,n,"Web push is only supported on Safari 16 and above."))}showHardAsk(){const e=Aa.baseLogTag+".showHardAsk";return new Promise(((t,n)=>{this.getCurrentPermissionState().then((i=>{null!=this.currentManager?i===gn.PROMPT?this.currentManager.showHardAsk().then((n=>{var i,a;n.state===gn.DISMISSED?(null!==(i=Me())&&void 0!==i&&i.track_event(E),Ht.broadcastToWindow({topic:W,name:F.HARD_ASK_DISMISSED}),Ht.deprecatedSdkCallback("opt_in_dismissed"),ya.runCallbacks(F.HARD_ASK_DISMISSED),We.log(1,e,"Hard ask was dismissed")):n.state===gn.GRANTED?(null!==(a=Me())&&void 0!==a&&a.track_event(S),Ht.broadcastToWindow({topic:W,name:F.HARD_ASK_ALLOWED,data:n.subscriptionDetails}),Ht.deprecatedSdkCallback("opt_in_allowed"),ya.runCallbacks(F.HARD_ASK_ALLOWED),We.log(1,e,"Push permission was granted"),We.customLabel(1,e,"token",n.subscriptionDetails.token)):n.state===gn.DENIED&&(null!==(a=Me())&&void 0!==a&&a.track_event(y),null!==(a=Me())&&void 0!==a&&a.track_event("Web Push Opt-in Denied"),Ht.broadcastToWindow({topic:W,name:F.HARD_ASK_DENIED}),Ht.deprecatedSdkCallback("opt_in_blocked"),ya.runCallbacks(F.HARD_ASK_DENIED),We.log(1,e,"Notification permission was denied")),t(n)})).catch((n=>{We.error(1,e,"Error showing hard ask:",n),t({state:i,subscriptionDetails:null})})):(We.log(1,e,"Not showing Hard Ask as current permission state is",i),this.getPushTokenDetails().then((n=>{We.customLabel(1,e,"token",n.token),t({state:i,subscriptionDetails:n})})).catch((n=>{We.warn(1,e,"Could not get push token details"),t({state:i,subscriptionDetails:null})}))):(We.log(1,e,"MoEngage web push settings not configured. Please configure at",ee),n(q))})).catch((e=>{n(e)}))}))}getCurrentPermissionState(){return null!=this.currentManager?this.currentManager.getCurrentPermissionState():Promise.reject(Ia)}getPushTokenDetails(){return null!=this.currentManager?this.currentManager.getPushTokenDetails():Promise.reject(Ia)}removeToken(){return null!=this.currentManager?this.currentManager.removeToken():Promise.reject(Ia)}showNotification(e){var t=Aa.baseLogTag+".showNotification";if(null!=this.currentManager)return this.currentManager.showNotification(e);We.warn(1,t,Ia)}}Aa.baseLogTag="NotificationManager";class wa{constructor(e){this.mainDivs=[],this.config=e}showSoftAsk(){const e=wa.baseLogTag+".showSoftAsk";return new Promise(((t,n)=>{let i=this.config.loadTime;ft.getInstance().then((n=>{(this.config.optInType===pn.SELF_HANDLED||n.isSafari()&&this.config.optInType===pn.ONE_STEP)&&(i=0),i&&We.log(1,e,"Delay of",i," second(s) requested before opt-in flow"),setTimeout((()=>{!n.isWebPushCompatible()||this.config.optInType!==pn.TWO_STEP&&this.config.optInType!==pn.SELF_HANDLED?(nt.set(s.SOFT_ASK_STATUS,_a.NOT_SHOWN),t({showHardAsk:!0,softAskState:_a.NOT_SHOWN})):this.showOptIn((()=>{We.log(1,e,"Soft ask was shown"),nt.set(s.OPT_IN_SHOWN_TIME,Date.now()),nt.set(s.SOFT_ASK_STATUS,_a.SHOWN),Ht.broadcastToWindow({topic:W,name:F.SOFT_ASK_SHOWN}),Ht.deprecatedSdkCallback("soft_ask_shown"),ya.runCallbacks(F.SOFT_ASK_SHOWN)}),(()=>{var n;null!==(n=Me())&&void 0!==n&&n.track_event(v),this.hideOptIn(),Zi(),We.log(1,e,"Soft ask was allowed"),nt.set(s.SOFT_ASK_STATUS,_a.ALLOWED),t({showHardAsk:!0,softAskState:_a.ALLOWED}),Ht.broadcastToWindow({topic:W,name:F.SOFT_ASK_ALLOWED}),Ht.deprecatedSdkCallback("soft_ask_allowed"),ya.runCallbacks(F.SOFT_ASK_ALLOWED)}),(()=>{var n;this.hideOptIn(),Zi(),null!==(n=Me())&&void 0!==n&&n.track_event(h),We.log(1,e,"Soft ask was dismissed"),nt.set(s.SOFT_ASK_STATUS,_a.DISMISSED),t({showHardAsk:!1,softAskState:_a.DISMISSED}),Ht.broadcastToWindow({topic:W,name:F.SOFT_ASK_DISMISSED}),Ht.deprecatedSdkCallback("soft_ask_closed"),ya.runCallbacks(F.SOFT_ASK_DISMISSED)}),(e=>{e=!!e,this.hideOptIn(),t({showHardAsk:e,softAskState:_a.NOT_SHOWN})}))}),1e3*i)}))}))}showOptIn(e,t,n,i){const a=wa.baseLogTag+".showOptIn";if(this.config.optInType===pn.TWO_STEP){let r=document.getElementById("moe-push-div");null==r&&(r=document.createElement("div"),r.id="moe-push-div",r.className="moe-push-class"),ft.getInstance().then((o=>{let s=null;if(s=o.isMobile?_t(this.config.optInPreview,this.config.isBrandingHidden).mobileUI:_t(this.config.optInPreview,this.config.isBrandingHidden).webUI,null!=s){r.innerHTML=s;const l=document.body.firstChild;null!=l&&l.parentNode.insertBefore(r,l),this.moeDiv=r;const d=r.firstElementChild;d&&(d.tabIndex=0,d.setAttribute("role","alert"),d.setAttribute("aria-live","polite"),ta(r.firstElementChild));const c=document.getElementById("optInText")||document.getElementById("optInTextConventional"),u=document.getElementById("moe-dontallow_button");null==c?(We.error(1,a,"Error showing soft ask. Allow button id is missing"),i()):(e(),null!==(o=Me())&&void 0!==o&&o.track_event(p),c.onclick=()=>{t()},u?u.onclick=()=>{n()}:window.moeRemoveBanner=()=>{n()})}else We.error(1,a,"Error displaying soft ask"),i()}))}else if(this.config.optInType===pn.SELF_HANDLED){var r=He.get();if(r.customSoftAsk){var o=document.getElementsByClassName(r.customSoftAsk.mainClass),s=document.getElementsByClassName(r.customSoftAsk.allowClass),l=document.getElementsByClassName(r.customSoftAsk.dismissClass);if(o.length<1)We.error(1,a,"Could not find main class for the soft ask. Class name given:",r.customSoftAsk.mainClass),ft.getInstance().then((e=>{e.isWebPushCompatible()&&(We.warn(1,a,"Proceeding to hard ask directly"),i(!0))}));else{e(),s.length<1&&(We.warn(1,a,"Could not find any element for allow button. Class name given:",r.customSoftAsk.allowClass),We.warn(1,a,"Docs for self-handled opt in available here - ",Z.SELF_HANDLED_DOCS)),l.length<1&&We.warn(1,a,"Could not find any element for dismiss button. Class name given:",r.customSoftAsk.dismissClass);for(let e=o.length-1;0<=e;e--){const t=o[e];this.mainDivs.push(t),t.style.display="block",ta(t)}for(let e=s.length-1;0<=e;e--)s[e].onclick=()=>{t()};for(let e=l.length-1;0<=e;e--)l[e].onclick=()=>{n()}}}else ft.getInstance().then((e=>{e.isWebPushCompatible()?(We.warn(1,a,"No soft ask configured. Proceeding to hard ask directly. \n\nYou can ignore this message if you do not want any soft ask."),i(!0)):(We.error(1,a,"Soft ask needs to be present in case of http implementation. Can not show hard ask otherwise."),i())}))}}hideOptIn(){null!=this.moeDiv&&(this.moeDiv.style.display="none"),0<this.mainDivs.length&&this.mainDivs.map((e=>{e.style.display="none"}))}}wa.baseLogTag="SoftAskManager",(kn=_a=_a||{}).SHOWN="shown",kn.NOT_SHOWN="not shown",kn.ALLOWED="allowed",kn.DISMISSED="dismissed";class Da{constructor(e,t){this.notificationManager=null,this.softAskManager=null,Da.baseLogTag,this.sdkSettings=e,this.browser=t,this.softAskManager=new wa(this.sdkSettings),this.notificationManager=new Aa(this.sdkSettings,t),function(){Da.handleSdkDisableListener||(window.addEventListener(W,(e=>function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){var t;(null===(t=null==e?void 0:e.detail)||void 0===t?void 0:t.name)===H.SDK_DISABLED&&ba()})))),Da.handleSdkDisableListener=!0)}()}callWebPush(){const e=Da.baseLogTag+".callWebPush";var t,n,i;t=this.sdkSettings,n=this.browser,(null===(i=He.get())||void 0===i||!i.disableWebPush)&&t.isWebPushEnabled&&0<=De.indexOf(n.name)&&navigator.serviceWorker&&"PushManager"in window&&"Notification"in window&&this.notificationManager.getCurrentPermissionState().then((t=>function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){var n=(n=t)=>{Ot.get().then((t=>{var i,a,r,o,l;t.deviceAdded=(i=this.sdkSettings,a=t,r=pt.getUserIdentities(),o=a.getAttribute("email"),l=a.getAttribute("mobile"),!!(null!==o||null!==l||null!=r&&r.u_em||null!=r&&r.u_mb||null!==(l=null===(l=null==i?void 0:i.configs)||void 0===l?void 0:l.subscriberBasedBillingAttributes)&&void 0!==l&&l.some((e=>null!==a.getAttribute(e)))||r&&0<Object.keys(r).length&&Object.keys(r).some((e=>{var t;return null===(t=null===(t=null==i?void 0:i.configs)||void 0===t?void 0:t.subscriberBasedBillingAttributes)||void 0===t?void 0:t.includes((null===(t=we.find((t=>t.moeName===e)))||void 0===t?void 0:t.attributeName)||e)}))||Mt())),t.save().then((()=>{this.notificationManager.removeToken().then((()=>{var t;null!==(t=Me())&&void 0!==t&&t.track_event(T,{[Ee]:!1}),null!==(t=Me())&&void 0!==t&&t.track_event(A),n===gn.DENIED?We.log(1,e,"Not asking for permission as current state is denied."):(nt.remove(s.OPT_IN_SHOWN_TIME),this.startPushSubscription())}))}))}))};const i=yield ft.getInstance();var a=bt(),r=t===gn.DENIED&&!this.sdkSettings.isDomainLevelStorage;null==a&&t!==gn.DENIED?this.startPushSubscription():null!=a&&(r||i.isSafari()&&t===gn.PROMPT)?(We.log(1,e,"User has removed the permission"),We.image(1,X),i.isSafari()&&t===gn.PROMPT&&(nt.set(Se,!0),t=gn.DENIED),n(t)):r?We.warn(1,e,"Not proceeding with push subscription as current state is denied"):null!=a&&t===gn.GRANTED?this.browser.name===ft.BROWSER_NAMES.CHROME?Ge(this.sdkSettings.webPushPlatformData,this.browser)?this.startPushSubscription():We.warn(1,e,"Subscription mode is not VAPID type. Cannot subscribe to web push."):(this.startPushSubscription(),this.notificationManager.getPushTokenDetails().then((t=>{We.customLabel(1,e,"token",t.token)}))):this.sdkSettings.isDomainLevelStorage?et.get(s.HARD_ASK_STATUS)===gn.GRANTED?(a=null===(a=et.get(s.SUBSCRIPTION_DETAILS))||void 0===a?void 0:a.domain)&&a===window.location.origin?(We.log(1,e,"It seems that the user has unsubscribed manually. Starting push subscription.."),n(t)):We.log(1,e,"Not showing opt-in as user subscribed to sub-domain"):this.startPushSubscription():n()})))).catch((t=>{We.error(1,e,"Error in getting current state:",t)}))}startPushSubscription(){const e=Da.baseLogTag+".startPushSubscription",t=()=>{nt.set(s.HARD_ASK_STATUS,gn.PROMPT);const t=bt();this.notificationManager.showHardAsk().then((n=>{nt.set(s.HARD_ASK_STATUS,n.state),n.state===gn.GRANTED?null!=n.subscriptionDetails.token?(nt.set(s.PUSH_TOKEN,n.subscriptionDetails.token),n.subscriptionDetails.domain=window.location.origin,nt.set(s.SUBSCRIPTION_DETAILS,n.subscriptionDetails),n.subscriptionDetails.token&&t!==n.subscriptionDetails.token&&vn.deviceAdd().then((()=>{var i,a;We.image(1,"https://media.giphy.com/media/90F8aUepslB84/giphy.gif"),Ot.getSync().subscribedToOldSdk?We.remoteLogTracking(1,"info",e,"User subscribed from older sdk, hence not sending subscription event"):(null!=t?null!==(i=Me())&&void 0!==i&&i.add_user_attribute("Web Migrated User","true"):null!==(a=Me())&&void 0!==a&&a.add_user_attribute("Web Subscription URL",location.href),null!==(a=Me())&&void 0!==a&&a.track_event(I,{MOE_WEB_PUSH_TOKEN:n.subscriptionDetails.token,migrated_user:!!window.location.search.includes("moe_migration=true")||void 0}))})),this.sdkSettings.isDomainLevelStorage&&et.set(s.SUBSCRIPTION_DETAILS,{domain:n.subscriptionDetails.domain,token:n.subscriptionDetails.token,endpoint:n.subscriptionDetails.endpoint,keys:n.subscriptionDetails.keys})):(We.error(1,e,"Push token was received as null."),We.error(1,e,"Please contact MoEngage support if this troubleshooting does not solve the issue.")):n.state===gn.DENIED&&We.image(1,X)})).catch((t=>{We.warn(1,e,t)}))},n=()=>{this.softAskManager?this.softAskManager.showSoftAsk().then((e=>{e.showHardAsk&&t()})):We.log(1,e,"SoftAskManager not set.")};this.notificationManager.getCurrentPermissionState().then((i=>{if(i===gn.GRANTED)this.sdkSettings.optInType!==pn.ONE_STEP&&We.remoteLogTracking(1,"info",e,"Skipping soft ask as browser permission is set to allow all notifications"),t();else{var a=parseInt(nt.get(s.OPT_IN_SHOWN_TIME));if(nt.get(s.SOFT_ASK_STATUS),nt.get(s.HARD_ASK_STATUS),i=(Date.now()-a)/36e5,!a||this.sdkSettings.optInType===pn.SELF_HANDLED||i>this.sdkSettings.promptAgain)if(this.browser.name===ft.BROWSER_NAMES.SAFARI&&this.sdkSettings.optInType===pn.ONE_STEP){We.log(1,e,"1 step optin configured. In Safari 16+ and macOS 13+, the web push optin will be shown after a user click. Any delay will be ignored.");const t=()=>{window.removeEventListener("click",t),n()};window.addEventListener("click",t)}else n();else{let t,n;n=i<1?(t=Math.floor(60*i),"minute(s)"):(t=Math.floor(100*i)/100,"hour(s)"),We.remoteLogTracking(1,"info",e,"Not showing opt in as last it was shown",t,n,"back on",new Date(a),". Reappear time is set to",this.sdkSettings.promptAgain,"hours."),We.log(1,e,"You can clear localstorage to get opt-in again.")}}}))}getPermissionState(){return this.notificationManager.getCurrentPermissionState()}showNotification(e){this.notificationManager&&this.notificationManager.showNotification(e)}trackPushOptedDeviceAttribute(){return new Promise((e=>{var t,n=nt.get(s.OPTED_STATUS_TRACK_TIME);n&&864e5<Date.now()-n&&(t=bt(),null!==(n=Me())&&void 0!==n&&n.track_event(T,{[Ee]:!!t}),nt.set(s.OPTED_STATUS_TRACK_TIME,Date.now())),e(null)}))}}Da.baseLogTag="WebPushManager",Da.handleSdkDisableListener=!1;class Oa{constructor(){this.customSoftAsk=null}static get(){return ke.get(t)}static save(e){ke.set(t,e),nt.set(s.INIT_DATA,e)}static setSoftAskConfig(e){var t=Oa.get();e={mainClass:Le(e,"main_class",Le(e,"mainClass",null)),allowClass:Le(e,"allow_class",Le(e,"allowClass",null)),dismissClass:Le(e,"block_class",Le(e,"dismissClass",null))},Oa.save(Object.assign(Object.assign({},t),{customSoftAsk:e}))}}class Pa{initialize(e){const t=Pa.baseLogTag+".initialize";Pa.handlePublicFunctions(),ft.getInstance().then((n=>{const i=new Da(e,n);i&&Fe(e,n)?(0<=[pn.ONE_STEP,pn.TWO_STEP].indexOf(e.optInType)?i.callWebPush():(We.log(1,t,"Self handled setting. Will show opt-in on manual invocation, if required."),i.getPermissionState().then((e=>{var n=bt();(e===gn.GRANTED||null!=n&&e===gn.DENIED)&&(e===gn.GRANTED&&We.log(1,t,"Notification permission already granted. Proceeding to subscribe the user"),i.callWebPush())})).catch((e=>{We.warn(1,t,"Cannot get permission state: ",e)}))),i.trackPushOptedDeviceAttribute()):De.indexOf(n.name)<0&&We.warn(1,t,"Web push not supported on this browser. Supported browsers are:\n\t\t1. Google Chrome\n\t\t2. Mozilla Firefox\n\t\t3. Opera\n\t\t4. Edge\n\t\t5. Safari 16 and above + macOS 13 and above")}))}static getPermissionState(e){return new Promise(((t,n)=>{St().then((i=>{ft.getInstance().then((a=>{new Da(i,a).getPermissionState().then((n=>{t(n),e&&e(null,n)})).catch((t=>{n(t),e&&e(t,null)}))}))})).catch((t=>{n(t),e&&e(t,null)}))}))}static handlePublicFunctions(){const e=Me();e.callWebPush=Pa.callWebPush,e.call_web_push=Pa.callWebPush,e.showNotification=Pa.showNotification,e.getPermissionState=Pa.getPermissionState}static callWebPush(e){const t=Pa.baseLogTag+".callWebPush";xt()?St().then((n=>{n.isWebPushEnabled?n.optInType===pn.SELF_HANDLED?(We.log(1,t,"Starting web push functions"),null!=e&&Oa.setSoftAskConfig(e),ft.getInstance().then((e=>{new Da(n,e).callWebPush()}))):We.warn(1,t,"This feature can only be used when you have chosed self-handled approach in the dashboard. You can check dashboard here:",ee):We.log(1,t,"Web push settings not configured on dashboard yet. To start web push subscriptions, please configure the settings on dashboard.")})).catch((e=>{We.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked.")})):We.warn(2,t,"Cannot initiate web push as Web SDK has been disabled.")}static showNotification(e){St().then((t=>{ft.getInstance().then((n=>{new Da(t,n).showNotification(e)}))})).catch((e=>{}))}}function Na(e){return!(!e||"object"!=typeof e)&&["moe_offering_id","moe_offering_name","moe_offering_type","moe_decision_policy_id","moe_decision_policy_name"].every((t=>t in e&&"string"==typeof e[t]&&""!==e[t].trim()))}function Ca(e){return!(!e||"object"!=typeof e)&&["cid","moe_locale_id","moe_variation_id"].every((t=>t in e&&"string"==typeof e[t]&&""!==e[t].trim()))}function Ra(e,t){if(e&&"object"==typeof e&&!Array.isArray(e))return e;if("string"==typeof e)try{var n=JSON.parse(e);return n&&"object"==typeof n&&!Array.isArray(n)?n:(We.error(2,t,"Parsed JSON is not a valid object"),null)}catch(e){return We.error(2,t,"Error parsing JSON string:",e),null}return null}Pa.baseLogTag="PushModule";class La{constructor(){this.initialize=()=>{Me().personalize={trackClick:this.trackClick,trackImpression:this.trackImpression,onUpdateDeviceId:this.onUpdateDeviceId,offeringClicked:this.offeringClicked,offeringShown:this.offeringShown},La.setupFetchExperiencesFunction()},this.getDeviceUniqueId=e=>{window.addEventListener(W,(t=>{t.detail.name===H.DEVICE_UUID&&(t=t.detail.data,e(t))}))},this.onUpdateDeviceId=e=>{this.getDeviceUniqueId(e)},this.offeringClicked=(e,t)=>La.track(e,"MOE_OFFERING_CLICKED",Na,"Invalid offering context, missing required fields",t),this.offeringShown=(e,t)=>La.track(e,"MOE_OFFERING_SHOWN",Na,"Invalid offering context, missing required fields",t),this.trackClick=(e,t)=>La.track(e,"MOE_WEBP_MESSAGE_CLICKED",Ca,"Invalid experience context, missing required fields",t),this.trackImpression=(e,t)=>La.track(e,"MOE_WEBP_MESSAGE_SHOWN",Ca,"Invalid experience context, missing required fields",t)}}La.baseLogTag="Web Personalization Tracking",La.setupFetchExperiencesFunction=()=>{const e=()=>{const e=Me();e&&e.personalize&&(e.personalize.fetchExperiences=window.MoeWebP.fetchExperiences)};window.MoeWebP&&window.MoeWebP.fetchExperiences?e():window.addEventListener(W,(t=>{t.detail.name===H.WEBP_INIT&&e()}))},La.track=(e,t,n,i,a)=>{var r=La.baseLogTag+".track";if(!(e=Ra(e,r)))return We.error(2,r,"Invalid context"),Promise.reject(new Error("Invalid context"));if(!n(e))return We.error(2,r,i),Promise.reject(new Error(i));a=a&&Ra(a,r)||{},a=Object.assign(Object.assign({},e),a);try{const e=Me();return e?(We.log(2,r,t+": Event Tracked"),e.track_event(t,a)):(window.moengage_q=window.moengage_q||[]).push({f:"track_event",a:[t,a]}),Promise.resolve()}catch(e){return We.error(2,r,"Failed tracking expression",e),Promise.reject(e)}};var ka=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class Ma{constructor(){Ma.handleEventListeners()}static loadModule(e){var t=Ma.baseLogTag+".loadModule";return null!=Ma.loadPromises[e.name]||(We.log(1,t,"Starting to fetch module: ",e.name),Ma.loadPromises[e.name]=new Promise(((t,n)=>{!function(e,t){if(document){const n=document.createElement("script");n.setAttribute("src",kt(e)),n.onload=t,n.async=!0,document.body.appendChild(n)}}(e.src,(()=>{var n=new(0,window[ce[e.name].windowLocation])(n=He.get());t(n)}))}))),Ma.loadPromises[e.name]}static enableOSM(){return ka(this,void 0,void 0,(function*(){var e=He.get();void 0===Me().onsite.OnsiteApiClient&&(Me().onsite=new Ea(e),yield Me().onsite.initialize())}))}static disableOSM(e=!1,t=!1){return ka(this,void 0,void 0,(function*(){const n=Me();n.onsite.OnsiteApiClient&&(We.log(1,Ma.baseLogTag,"logging out from OSM module"),yield Me().onsite.logout(e,t),n.onsite=null,n.onsite=Ln)}))}static enableCards(e){return ka(this,void 0,void 0,(function*(){const t=Me();Ma.loadModule(ce.CARDS).then((n=>{n.initialize(e),t.cards=n})).catch((e=>{We.error(1,"enableCards","Error in loading Cards Module:",e)}))}))}static disableCards(){return ka(this,void 0,void 0,(function*(){const e=Me();e.cards&&(yield e.cards.disableCardsModule())}))}static enablePush(e){return ka(this,void 0,void 0,(function*(){(new Pa).initialize(e)}))}static handleEventListeners(){window.addEventListener("MODULE_ACTIONS",(e=>ka(this,void 0,void 0,(function*(){var t,n;"DISABLE_OSM"===e.detail.name&&Ma.disableOSM(null===(t=e.detail.data)||void 0===t?void 0:t.isUserLogout),"DISABLE_ENABLE_OSM"===e.detail.name&&null!==(n=null===(n=Me())||void 0===n?void 0:n.onsite.initData)&&void 0!==n&&n.appId&&(yield Ma.disableOSM(),Ma.enableOSM())}))))}static enableWebPersonalizationTracking(){return ka(this,void 0,void 0,(function*(){(new La).initialize()}))}}Ma.baseLogTag="ModuleManager",Ma.loadPromises={};class xa{constructor(e){this.deviceToLogout=Le(e,"deviceToLogout",null)}static get(){return new xa(nt.get(s.GRACEFUL_DATA))}save(){nt.set(s.GRACEFUL_DATA,this)}}class Ba{onWindowVisibilityChange(e){Ba.baseLogTag,ke.set("isWindowActive",!0),document.addEventListener("focus",(()=>{t(!0)}),!1),document.addEventListener("blur",(()=>{t(!1)}),!1),window.addEventListener("focus",(()=>{t(!0)}),!1),window.addEventListener("blur",(()=>{"IFRAME"!==document.activeElement.tagName&&t(!1)}),!1);const t=e=>"boolean"==typeof e?n(e?"visible":"hidden"):document.hidden?n("hidden"):n("visible"),n=t=>{ke.set("isWindowActive","visible"===t),e(t)};window.addEventListener("visibilitychange",t,!1)}static beforeUnload(){var e;if(Ba.isBatchingEnabled&&(Zt.windowClosed=!0,on.sendBeacon()),null!==(e=window.Moengage.onsite)&&void 0!==e&&e.displayManager){const{sendDelayCampaignStats:e,displayManager:t,funnelManager:n}=window.Moengage.onsite;e(t,n)}}static removeBeforeUnloadListeners(){window.removeEventListener("beforeunload",Ba.beforeUnload,!1)}static addBeforeUnloadListeners(e){e&&(Ba.isBatchingEnabled=!0),window.addEventListener("beforeunload",Ba.beforeUnload,!1)}}Ba.baseLogTag="WindowEventManager",Ba.isBatchingEnabled=!1;var Ua=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};const Wa="MoEngage.user";class Ha{static addAttribute(e,t){const n=Wa+".addUserAttribute";return new Promise(((i,a)=>{if(!xt())return We.warn(2,n,`Not tracking the attribute "${e}" as Web SDK has been disabled.`),void i(!1);St().then((a=>{if("string"!=typeof e||null==e)We.error(1,n,"Attribute name needs to be a string"),i({error:5e3,message:"Attribute name needs to be a string. Type provided was "+typeof e});else if(""===e)We.error(1,n,"Attribute name can not be an empty string"),i({error:5001,message:"Attribute name can not be an empty string"});else if(null==t)We.error(1,n,"Attribute value null"),i({error:5003,message:"Attribute value was empty"});else if("string"==typeof t&&""===t)We.error(1,n,"Attribute value needs to be non-empty string or non-empty object"),i({error:5004,message:"Attribute value needs to be non-empty string or non-empty object"});else if($t(t)&&B.includes(e))We.error(1,n,`Value of '${e}' attribute cannot be an object`),i({error:5002,message:"Attribute value cannot be an object"});else if("object"==typeof t&&Array.isArray(t)&&!t.length)We.error(1,n,"Attribute value needs to be non-empty string or non-empty object"),i({error:5006,message:"Attribute value needs to be non-empty string or non-empty object"});else if($t(t)&&!Object.keys(t).length)We.error(1,n,"Attribute value cannot be empty object"),i({error:5005,message:"Attribute value cannot be empty object"});else{const r=new yt(e,t),o=()=>{Ot.get().then((e=>{e.addAttribute(r).then((e=>Ua(this,void 0,void 0,(function*(){yield this.checkAndAddAttributeInIdentityMap(r,t,a),e?(r.key===P&&(yield pt.updateIdentifiersIDB({moe_user_id:r.value}),We.log(1,n,"Logging in the user with id: ",r.value)),cn.createUserAttributeEvent(r).then((e=>{We.log(2,n,"Event to be converted to report:",e),un.addEvent(e),vn.collectGetParams().then((t=>{t=new dn(dn.REPORT_ADD_TYPE.USER_ATTRIBUTE,t,e),vn.reportAdd(t).then((()=>{i(!0)}))}))}))):(We.error(1,n,"Attribute already present/queued. Not adding again."),i({error:5005,message:"Attribute already present/queued. Not adding again."}))}))))}))};"id"===e?Ot.get().then((e=>Ua(this,void 0,void 0,(function*(){var r=e.indexOfAttribute("id");if(-1<r)if(t===e.attributes[r].value)We.log(1,n,"User already logged in with id:",t),i(!0);else{We.log(1,n,"Logging out previous user with id:",e.attributes[r].value),Ht.broadcastToWindow({topic:"USER_ACTIONS",name:"FORCED_LOGOUT",data:{id:t}});const i=null==(r=pt.getUserIdentities())?void 0:r.uid;Ha.logout(!0,t).then((()=>Ua(this,void 0,void 0,(function*(){yield this.forcedLogoutUpdateInIdentityMap(t,i,a),o()}))))}else yield this.uidLoginUpdateIdentityMap(t,a),o()})))):(Ht.broadcastToWindow({topic:"USER_ACTIONS",name:"LOGIN",data:{id:t}}),o())}})).catch((a=>{var r;null!==(r=window.moengage_q)&&void 0!==r&&r.push({f:"add_user_attribute",a:[e,t]}),We.error(1,n,"Error in getting Web SDK Settings. ",a),i({error:5007,message:"Error in getting Web SDK Settings.",err:a})}))}))}static login(e){return Ha.addAttribute("id",e)}static identifyUser(e){return Ua(this,void 0,void 0,(function*(){var t=Wa+".identifyUser";if(xt())if("string"==typeof e&&e.length||function(e){if("object"==typeof e&&null!==e){let n=!0;for(const i in e){n=!1;var t=e[i];if("string"!=typeof t||!t.length)return}return!n}}(e)){let a,r={};"string"==typeof e?r.uid=e:r=Object.assign({},e);try{a=yield St()}catch(e){We.warn(1,t,"Could not fetch sdk config.")}const o=yield Ot.get();var n=pt.getUserIdentities()||{};let s=!1,l=!1;const d={};for(const e in r){if("string"!=typeof r[e])return void We.error(1,t,`Identity '${e}' has a non-string value. Rejecting the IdentityMap.`);n[e]&&n[e]===r[e]||(s=!0),n[e]&&n[e]!==r[e]&&(d[e]=n[e]),!l&&this.shouldTriggerPushSubBilling(e,o,a)&&(l=!0)}if(s){var i=Object.keys(pt.getUserIdentities()||{}).length||o.getAttribute("id");i&&(yield on.flushReports());let e=!1;if(l)try{yield vn.deviceAdd(),e=!0}catch(e){We.error(1,t,"Error occurred while adding device: ",e)}r.uid&&r.uid!==n.uid&&(yield o.addAttribute(new yt("id",r.uid)),yield pt.updateIdentifiersIDB({moe_user_id:r.uid})),yield pt.updateCurrentUserIdentities(r),Object.keys(d).length&&(yield pt.updatePreviousUserIdentities(d));try{!i&&on.reports.length||!a||a.isPushSubBilling&&(!a.isPushSubBilling||!o.deviceAdded&&!e)||(yield vn.sendBatchOfReports([]))}catch(e){We.error(1,t,"Error occurred while sending identities request: ",e)}pt.broadcastUserIdentityUpdate()}else We.warn(1,t,"Identities not updated as same values were passed again.")}else We.error(1,t,"type of the argument 'identities' is not supported OR empty identity received.");else We.warn(2,t,"Not tracking user identities as Web SDK has been disabled.")}))}static logout(e,t){const n=Wa+".logout";if(!xt())return We.warn(2,n,"Not tracking user logout as Web SDK has been disabled."),Promise.resolve(!1);const i=e?{type:"forced",new_uid:t}:null;return function(){const e=xa.get();null!=Ot.getSync()&&(e.deviceToLogout=Ot.getSync().deviceUuid,e.save())}(),new Promise((e=>{mn.track(_,i).then((()=>Ua(this,void 0,void 0,(function*(){We.log(1,n,"Logging out now!"),yield on.flushReports(!0),Ba.removeBeforeUnloadListeners(),St().then((t=>Ua(this,void 0,void 0,(function*(){t.isDomainLevelStorage&&(et.remove(s.USER_DATA),et.remove(s.IDENTITY_MAP)),un.clear(),pt.broadcastLogout(),nt.logout(),yield pt.updateIdentifiersIDB({}),yield Ot.logout(),nt.remove(s.GRACEFUL_DATA),vn.onDeviceAdd=new gt,setTimeout((()=>{Ht.broadcastToWindow({topic:"USER_ACTIONS",name:"LOGOUT_COMPLETED"})}),100),xe.setRemoteLogging(null,!1),ke.set(o,!0),e(!0)})))).catch((t=>{We.error(1,n,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),e(!1)}))}))))}))}static updateUniqueId(e){const t=Wa+".updateUniqueId";return xt()?new Promise((n=>{Ot.get().then((i=>Ua(this,void 0,void 0,(function*(){var a=i.indexOfAttribute(P),r=i.indexOfAttribute("oldUniqueIds");if(!(-1<a))return We.log(2,t,"Logging in as no id found"),Ha.login(e);var o=i.attributes[a].value;e!==o?(We.log(2,t,"Different ids found"),-1<r?(i.attributes[r].value.push(o),i.attributes.splice(a,1)):(i.attributes.splice(a,1),i.addAttribute(new yt("oldUniqueIds",[o]))),i.save().then((()=>{Ha.login(e).then((()=>{n(!0)}))}))):(We.warn(1,t,"New id and old id are the same. Not updating the id."),n(!0))}))))})):(We.warn(2,t,"Not updating user ID as Web SDK has been disabled."),Promise.resolve(!1))}static getAttributes(){const e=Ot.getSync().attributes,t={};return e.map((e=>{t[e.key]=e.value})),t}static setAttributes(e){Ot.getSync().attributes=e,We.log(2,"MoEngage.user.setAttributes","User attributes have been updated")}static checkAndAddAttributeInIdentityMap(e,t,n){var i;return Ua(this,void 0,void 0,(function*(){var a;e.key!==P&&"string"==typeof t&&(a=(null===(i=we.find((t=>t.attributeName===e.key)))||void 0===i?void 0:i.moeName)||e.key,n.configs.identityAttributes.includes(a)&&(We.log(1,"MoEngage.user.checkAndAddAttributeInIdentityMap",`Attribute to be tracked: '${e.key}' is an identity.`),yield this.identifyUser({[a]:t})))}))}static forcedLogoutUpdateInIdentityMap(e,t,n){return Ua(this,void 0,void 0,(function*(){n.configs.identityAttributes.includes("uid")&&t&&t!==e&&(yield pt.updateCurrentUserIdentities({uid:e}))}))}static uidLoginUpdateIdentityMap(e,t){var n;return Ua(this,void 0,void 0,(function*(){var i;null!==(n=null===(n=t.configs)||void 0===n?void 0:n.identityAttributes)&&void 0!==n&&n.includes("uid")&&(null!=(i=pt.getUserIdentities())&&i.uid&&i.uid!==e&&(yield on.flushReports(),yield pt.updatePreviousUserIdentities({uid:i.uid})),yield pt.updateCurrentUserIdentities({uid:e})),pt.broadcastUserIdentityUpdate()}))}static shouldTriggerPushSubBilling(e,t,n){return(null==n?void 0:n.isPushSubBilling)&&!t.deviceAdded&&Ve((null===(t=we.find((t=>t.moeName===e)))||void 0===t?void 0:t.attributeName)||e,n.configs.subscriberBasedBillingAttributes)}}const Fa=()=>new Promise((e=>{"complete"!==window.document.readyState?window.addEventListener("load",(()=>{e(!0)})):e(!0)}));class Ga{static enableSdk(){const e=this.baseLogTag+".enableSdk";return new Promise((t=>{xt()?(We.warn(2,e,"SDK is already enabled."),t(!0)):(this.setDisabledFlag(!1),qa().then((()=>{this.broadcastSdkEnabled(),en.initialize().then((()=>{this.setDisabledFlagIDB(!1)})),Gt(),t(!0)})))}))}static disableSdk(){const e=this.baseLogTag+".disableSdk";return new Promise((t=>{xt()?(this.broadcastSdkDisabled(),this.setDisabledFlag(!0),this.setDisabledFlagIDB(!0).then((e=>{this.disableSdkActivities(),(new zt).clearSessionAndSource(),this.filterAndClearUserAttributesCache(),t(e)}))):(We.warn(2,e,"SDK is already disabled."),t(!0))}))}static setDisabledFlag(e){nt.set(s.SDK_DISABLED,e),et.set(s.SDK_DISABLED,e)}static filterAndClearUserAttributesCache(){var e;const t=nt.get(s.WEB_SETTINGS),n=null===(e=null==t?void 0:t.configs)||void 0===e?void 0:e.identityAttributes,i=null===(e=null==t?void 0:t.configs)||void 0===e?void 0:e.subscriberBasedBillingAttributes,a=nt.get(s.USER_DATA);null!==(e=null==a?void 0:a.attributes)&&void 0!==e&&e.length&&(a.attributes=a.attributes.filter((e=>{if(null!=n&&n.length){var a=(null===(a=we.find((t=>t.attributeName===e.key)))||void 0===a?void 0:a.moeName)||e.key;if(n.includes(a))return!0}const r=[N,k,"Web Migrated User","Web Subscription URL"];return!(null==t||!t.isPushSubBilling||!(r.includes(e.key)||null!=i&&i.length&&i.includes(e.key)))})),Ha.setAttributes(a.attributes),nt.set(s.USER_DATA,a))}static broadcastSdkEnabled(){Ht.broadcastToWindow({topic:W,name:H.SDK_ENABLED})}static broadcastSdkDisabled(){Ht.broadcastToWindow({topic:W,name:H.SDK_DISABLED})}static setDisabledFlagIDB(t=!1){return function(e,t,n,i){return new(n=n||Promise)((function(t,a){function r(e){try{s(i.next(e))}catch(e){a(e)}}function o(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var i;e.done?t(e.value):((i=e.value)instanceof n?i:new n((function(e){e(i)}))).then(r,o)}s((i=i.apply(e,[])).next())}))}(this,0,void 0,(function*(){return new Promise((n=>{var i;null!==(i=this.moeDataStore)&&void 0!==i&&i.getItem||(this.moeDataStore=e.createInstance({driver:[e.INDEXEDDB],name:re,storeName:oe})),this.moeDataStore?this.moeDataStore.setItem(s.SDK_DISABLED,t).then((()=>{n(!0)})).catch((()=>n(!1))):n(!1)}))}))}static disableSdkActivities(){var e;on.suspendBatching(),null!==(e=He.get())&&void 0!==e&&e.enableSPA&&Nn.removeURLChangeObserver(),Ba.removeBeforeUnloadListeners();for(const e in s.Q)it.purge(e);"function"==typeof(null===(e=en.offlineDataStore)||void 0===e?void 0:e.clear)&&en.offlineDataStore.clear()}}Ga.baseLogTag="SdkMethods";var Ka=function(e,t,n,i){return new(n=n||Promise)((function(a,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((i=i.apply(e,t||[])).next())}))};class Va{}Va.track_event=(e,t)=>mn.track(e,t),Va.add_unique_user_id=e=>Ka(void 0,void 0,void 0,(function*(){return yield Ha.login(e)})),Va.update_unique_user_id=e=>Ka(void 0,void 0,void 0,(function*(){return yield Ha.updateUniqueId(e)})),Va.add_user_attribute=(e,t)=>Ha.addAttribute(e,t),Va.add_first_name=e=>Ha.addAttribute("first_name",e),Va.add_last_name=e=>Ha.addAttribute("last_name",e),Va.add_email=e=>Ha.addAttribute("email",e),Va.add_mobile=e=>Ha.addAttribute("mobile",e),Va.add_user_name=e=>Ha.addAttribute("name",e),Va.add_gender=e=>Ha.addAttribute("gender",e),Va.add_birthday=e=>Ha.addAttribute("birthday",e),Va.destroy_session=()=>Ha.logout(),Va.track_page_view=()=>(mn.track(g,{timestamp:Number(Date.now())}),mn.track(m,{timestamp:Number(Date.now())})),Va.identifyUser=e=>Ka(void 0,void 0,void 0,(function*(){return yield Ha.identifyUser(e)})),Va.getUserIdentities=()=>pt.getUserIdentities(),Va.enableSdk=()=>Ka(void 0,void 0,void 0,(function*(){return yield Ga.enableSdk()})),Va.disableSdk=()=>Ka(void 0,void 0,void 0,(function*(){return yield Ga.disableSdk()})),Va.isSdkEnabled=()=>xt(),Va.user={getAttributes:Ha.getAttributes},Va.getUserId=()=>{var e;return(null===(e=Ha.getAttributes())||void 0===e?void 0:e.USER_ATTRIBUTE_UNIQUE_ID)||""},Va.getUserAttribute=e=>Ha.getAttributes()[e]||"";class ja{static getUuid(){return nt.get(s.USER_DATA).deviceUuid}static getPushToken(){var e=nt.get(s.SUBSCRIPTION_DETAILS);return(null==e?void 0:e.token)||null}static getDeviceData(){return nt.get(s.DEVICE_DATA)}static setDeviceData(e,t){nt.set(s.DEVICE_DATA,Object.assign(Object.assign({},this.getDeviceData()),{[e]:t}))}static createNewDeviceUniqueId(){this.setDeviceData("deviceUniqueId",(0,rt.v4)())}}function Ya(t){const n="Pre-Initialization";if(!(e=>{const t=["bot","spider","crawler","crawling","Applebot","PetalBot","pingbot","proximic","AdsBot-Google","Googlebot","Cincraw","SnapchatBot","Snapchat-Proxy/1.0","SnapchatAds","Snapchat-Ads/1.0","YandexRenderResourcesBot","bingbot","slurp","MicrosoftPreview","Baiduspider","HeadlessChrome",...Array.isArray(e)?e:[]];return new RegExp(t.join("|"),"i").test(navigator.userAgent)})(null==t?void 0:t.bots_list)){var i=Me();if(i&&0<i.initialised)return We.error(1,n,"MoEngage Web SDK initialised multiple times. Please integrate the Web SDK only once!"),i;if("undefined"==typeof Promise)return We.error(1,n,"Promises not supported"),Mn;if(t.app_id||t.appId){var a=class{static isIntegrated(){try{var e=localStorage.getItem("moe_segment_cluster"),t=localStorage.getItem("moe_segment_sw_path"),n=localStorage.getItem("moe_segment_sw_scope"),i=localStorage.getItem("moe_segment_enable_spa"),a=localStorage.getItem("moe_segment_disable_onsite"),r=localStorage.getItem("moe_segment_disable_cookies"),o=localStorage.getItem("moe_segment_cards");const l={};e&&(l.cluster=e),t&&(l.swPath=t),n&&(l.swScope=n),i&&(l.enableSPA="true"===i),r&&(l.disableCookies="true"===r),a&&(l.disable_onsite="true"===r),o&&(l.cards=JSON.parse(o));var s=e||t||n||i||r||a||o;return s&&We.log(1,".isSegmentDataFound","Data found for segment initialisation",l),!!s&&l}catch(e){return!1}}}.isIntegrated();a&&(t=Object.assign({},t,a)),He.save(t);const r=He.get();return Fa().then((()=>{var i;za(),new Ma,(e=>{const t="handleLogger";We.setLogLevel(e.debugLevel),We.log(1,t,"Init data: ",e),We.log(1,t,"Script loaded!"),We.customLabel(1,t,"SDK Version","2.56.1"),e.debugLevel>0&&(We.warn(1,t,"You are currently using MoEngage in debug environment. You'll find all the data captured in this environment in the TEST mode on the dashoard."),We.warn(1,t,"Please initialize with debugLevel as",0,"when using on your production environment."))})(r),i=t.disableSdk,new Promise((e=>{const t=indexedDB.open("moe_database");t.onsuccess=()=>{t.result.objectStoreNames.contains("moe_data")?e(!0):e(!1)},t.onerror=()=>{e(!1)}})).then((t=>{if(t){const n=e.createInstance({driver:[e.INDEXEDDB],name:re,storeName:oe});n&&(n.setItem("isSdkDisabledAtInit",!!i),(Bt()||et.get(d))&&("boolean"==typeof(t=et.get(s.SDK_DISABLED))?n.setItem(s.SDK_DISABLED,t):n.removeItem(s.SDK_DISABLED)))}})),xt()||(Bt()||et.get(d))&&!1===et.get(s.SDK_DISABLED)&&(nt.set(s.SDK_DISABLED,!1),1)?(window.addEventListener("USER_ACTIONS",(e=>{"LOGOUT_COMPLETED"===e.detail.name&&qa(!0)})),qa().then((()=>{Gt()}))):We.warn(2,n,"Not initialising the SDK as it has been disabled."),Ht.broadcastToWindow({topic:W,name:H.MOE_INIT,data:t},!0)})),i=window.moengage_object||"Moengage",a=Object.assign(Object.assign(Object.assign({},Rn),Va),{onsite:Ln}),window[i]=a}return We.error(1,n,"App Id not specified. Please check docs page to complete the integration - ",Z.WEBSDK_DOCS),Mn}We.error(1,n,"Bot detected, Can't initialise the MoEngage Web SDK")}const za=()=>{ct()===Ie.WEB&&e.createInstance({driver:[e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE],name:ne,storeName:ie}).clear()};window&&(window.moe=Ya,window.moeBannerText="banner",window[le]=un);const qa=(e=!1)=>{const t="Initialization";return new Promise((n=>Pn.getWebSDKSettings().then((i=>{const{isDomainLevelStorage:a,isPushSubBilling:r,isWebPushEnabled:o,configs:{isBatchingEnabled:l,remoteLogTracking:d,logLevel:c,isCardsModuleEnabled:u}}=i;xe.setRemoteLogging(c,d),Ja(a),Xa(l,d,i);var g=ja.getDeviceData();return null!=g&&g.deviceUniqueId||ja.createNewDeviceUniqueId(),Ot.get().then((l=>function(e,t,n,i){return new(n=n||Promise)((function(e,t){function a(e){try{o(i.next(e))}catch(e){t(e)}}function r(e){try{o(i.throw(e))}catch(e){t(e)}}function o(t){var i;t.done?e(t.value):((i=t.value)instanceof n?i:new n((function(e){e(i)}))).then(a,r)}o((i=i.apply(undefined,[])).next())}))}(0,0,void 0,(function*(){var d;if(null===(d=null===(d=i.configs)||void 0===d?void 0:d.identityAttributes)||void 0===d||!d.includes("uid")||null!==(c=pt.getUserIdentities())&&void 0!==c&&c.uid||pt.copyUidIntoIdentityMap(l),xa.get().deviceToLogout===l.deviceUuid)return We.remoteLogTracking(1,"info",t,"User was not able to logout last time. Completing the logout now and starting new session."),Ha.logout();l.deviceAdded&&vn.onDeviceAdd.res(),r&&We.warn(1,t,"You are under push subscriber based billing plan. We are only tracking users with an email, phone number or have subscribed to web push. All user attributes and events will be stored in a queue till we receive either of the properties.");var c=new zt;(new Ba).onWindowVisibilityChange(c.handleBrowserInactivity),We.customLabel(1,t,"Device UUID",l.deviceUuid),We.customLabel(1,t,"Device Added",l.deviceAdded),Ht.broadcastToWindow({topic:W,name:H.SETTINGS_FETCHED,data:i}),Ht.broadcastToWindow({topic:W,name:H.DEVICE_UUID,data:l.deviceUuid}),(!i.isPushSubBilling&&(!l.deviceAdded||e)||i.isPushSubBilling&&(function(e,t){const n=(null===(e=null==e?void 0:e.configs)||void 0===e?void 0:e.subscriberBasedBillingAttributes)||[];return(null===(t=t.attributes)||void 0===t?void 0:t.some((e=>Ve(e.key,n))))||!!bt()}(i,l)&&e||Mt()))&&vn.deviceAdd(),Va.track_page_view(),En.clear(s.Q.DEVICE),En.clear(s.Q.REPORT),He.get().enableSPA&&!Nn.isObserverRunning&&(new Nn).addURLChangeObserver(a),ft.getInstance().then((e=>{var n,a,r=!(null!==(n=null===(r=window.MoeWebP)||void 0===r?void 0:r.isEditorModeEnabled)&&void 0!==n&&n.call(r));o&&!He.get().disableWebPush&&r?Ma.enablePush(i):We.warn(1,t,"Web push feature not enabled for current environment"),!He.get().disableOnsite&&r?vn.onDeviceAdd.p.then((()=>{Ma.enableOSM()})):We.warn(1,t,"Onsite is disabled in this page since `disableOnsite: true` is passed during initialization."),u&&null!==(a=He.get().cards)&&void 0!==a&&a.enable&&r?Ma.enableCards(i):Ma.disableCards(),null!==(r=i.configs)&&void 0!==r&&r.isWebPersonalizationModuleEnabled&&Ma.enableWebPersonalizationTracking(),$a()})),n(!0)}))))})).catch((e=>{We.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),n(!1)}))))},$a=()=>{var e="Moengage.clearWindowQ";try{const n=Me();let i=window.moengage_q;if(n&&i){if(window.moengage_q=[],i&&0<i.length&&n)for(let a=0;a<i.length;a++){We.remoteLogTracking(1,"info",e,"Method called before SDK downloaded:",[i[a].f],i[a].a);var t=i[a].f;"onsite.getData"===t?n.onsite.getData(...i[a].a):"onsite.registerCallback"===t?n.onsite.registerCallback(...i[a].a):"onsite.getSelfHandledOSM"===t?n.onsite.getSelfHandledOSM(...i[a].a):"landingPages.trackImpression"===t?n.landingPages.trackImpression.apply(null,i[a].a):null!=n[i[a].f]&&n[i[a].f].apply(null,i[a].a)}i=[]}}catch(t){We.error(1,e,t)}},Ja=e=>{e&&(nt.isSharedWithCookie=!0,nt.copyKeysFromCookie())},Xa=(e,t,n)=>{Ba.addBeforeUnloadListeners(e),(e||t)&&(on.init(n),We.log(1,"handleBatching","Enabled Batching for "+(e?"Event Tracking":"")+(t?", Remote Logs Tracking":"")))},Qa={clearWindowQ:$a,clearEventsFromIDB:za,initialize:Ya,isWindowLoaded:Fa}})()})();